<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>TISC 2024 - Hardware isnt that Hard!</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-2b920568.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-f556d4cd.css">
  <meta property="article:tag" content="TISC 2024"><meta property="article:tag" content="rev"><meta property="article:tag" content="hardware"><meta name="description" content="I was kind of scared when I first read the challenge description, as I had never done a firmware rev chal before.

# Overview

I started by trying to get an overall idea of the the various concepts involved, beginning with the Trusted Platform Module (TPM). I watched [this video](https://www.youtube.com/watch?v=RW2zHvVO09g).

Based on my understanding, a TPM is a piece of hardware that does encryption and decryption of data passed to it. It has a &quot;mini-processor&quot; and the key is stored inside it, allowing all operations to occur independently of the actual computer. Hence, it is impossible for an attacker to inject their own code or otherwise interfere with the encryption and decryption algorithms. Neither is it possible to leak the encryption key since it is stored on an entirely different memory chip.

![](https://upload.wikimedia.org/wikipedia/commons/b/be/TPM.svg)

Next, I began researching ways to reverse the firmware dump. My search led to [esp32_image_parser](https://github.com/tenable/esp32_image_parser) on github (some other useful resources I came across are [https://github.com/BlackVS/ESP32-reversing?tab=readme-ov-file#firmware](https://github.com/BlackVS/ESP32-reversing?tab=readme-ov-file#firmware) and [https://olof-astrand.medium.com/reverse-engineering-of-esp32-flash-dumps-with-ghidra-or-ida-pro-8c7c58871e68](https://olof-astrand.medium.com/reverse-engineering-of-esp32-flash-dumps-with-ghidra-or-ida-pro-8c7c58871e68))

# Extracting the firmware ELF

The first thing to do is list the partitions on the firmware dump. This is done with `python esp32_image_parser.py show_partitions flash_dump.bin`

```plaintext:output
reading partition table...
entry 0:
  label      : nvs
  offset     : 0x9000
  length     : 20480
  type       : 1 [DATA]
  sub type   : 2 [WIFI]

entry 1:
  label      : otadata
  offset     : 0xe000
  length     : 8192
  type       : 1 [DATA]
  sub type   : 0 [OTA]

entry 2:
  label      : app0
  offset     : 0x10000
  length     : 1310720
  type       : 0 [APP]
  sub type   : 16 [ota_0]

entry 3:
  label      : app1
  offset     : 0x150000
  length     : 1310720
  type       : 0 [APP]
  sub type   : 17 [ota_1]

entry 4:
  label      : spiffs
  offset     : 0x290000
  length     : 1441792
  type       : 1 [DATA]
  sub type   : 130 [unknown]

entry 5:
  label      : coredump
  offset     : 0x3f0000
  length     : 65536
  type       : 1 [DATA]
  sub type   : 3 [unknown]

MD5sum: 
972dae2ff872a0142d60bad124c0666b
Done
```

To get an idea of what each partition is for, I watched [this video](https://www.youtube.com/watch?v=eGZ-TxHpm24). I concluded that the main program code should be in either the app0 or app1 partition.

I tried to dump it using the command `python esp32_image_parser.py dump_partition flash_dump.bin -partition app0`. This produced the file `app0_out.bin`. Then I tried to extract it as an ELF using the command `python esp32_image_parser.py create_elf flash_dump.bin -partition app0 -output app0.elf`. There were a number of errors but looking through the github issues and pull requests I was able to apply the relevant patches to fix each issue. Here are all the patches I applied:

```plaintext:git diff
diff --git a/esp32_image_parser.py b/esp32_image_parser.py
index 6503cf7..0abcc86 100755
--- a/esp32_image_parser.py
+++ b/esp32_image_parser.py
@@ -6,6 +6,7 @@ import json
 import os, argparse
 from makeelf.elf import *
 from esptool import *
+from esptool.bin_image import *
 from esp32_firmware_reader import *
 from read_nvs import *
 
@@ -53,6 +54,7 @@ def image2elf(filename, output_file, verbose=False):
     section_map = {
         'DROM'                      : '.flash.rodata',
         'BYTE_ACCESSIBLE, DRAM, DMA': '.dram0.data',
+        'BYTE_ACCESSIBLE, DRAM': '.dram0.data',  # hope this works
         'IROM'                      : '.flash.text',
         #'RTC_IRAM'                  : '.rtc.text' TODO
     }
@@ -154,7 +156,9 @@ def image2elf(filename, output_file, verbose=False):
 
         if (name == '.iram0.vectors'):
             # combine these
-            size = len(section_data['.iram0.vectors']['data']) + len(section_data['.iram0.text']['data'])
+            size = len(section_data['.iram0.vectors']['data']) # + len(section_data['.iram0.text']['data'])
+            if '.iram0.text' in section_data:
+                size += len(section_data['.iram0.text']['data'])
         else:
             size = len(section_data[name]['data'])
```

Now, rerunning the command produces an ELF file. To decompile the file with ghidra, I had to install ghidra version 11+ as previous versions did not have support for xtensa esp32 instructions (another option was using https://github.com/Ebiroll/ghidra-xtensa). Now after importing the file into ghidra, we can see the decompilation.

![](/ctf-writeups/tisc24/firmware_decomp.png)

To be honest, I wasn't expecting the decompilation to work since I wasn't even sure if the ELF had been extracted correctly, or if the patches had messed it up somehow. Anyway, I continued on.

# Reversing the ELF

The entry function seems to be quite complex and there is no immediately obvious program logic. One good way to locate the program logic is to try and find where readable strings are being used. A strings check on the ELF file yielded a very long list, but one string in particular stood out: `BRYXcorp_CrapTPM v1.0-TISC!`.

I searched for this string in ghidra using `Search > Memory`

![](/ctf-writeups/tisc24/hardware_ghidra_search.png)

Following its references, we can see its being used in the following function:

```c
void FUN_400d1578(void)

{
  FUN_400d3470(0x3ffc1ecc,0x1c200,0x800001c,0xffffffff,0xffffffff,0,20000,0x70);
  FUN_400d3670(0x3ffc1ecc,1);
  FUN_400f25bc(0x3ffc1cdc,FUN_400d1614);
  FUN_400f25c4(0x3ffc1cdc,FUN_400d15e8);
  FUN_400d17d8(0x3ffc1cdc,0x69,0xffffffff,0xffffffff,0);
  FUN_400d379c(0x3ffc1ecc,s_BRYXcorp_CrapTPM_v1.0-TISC!_====_3f400120);
  do {
    DAT_3ffbdb68 = FUN_400d1b04(4);
    memw();
    memw();
  } while (DAT_3ffbdb68 == 0);
  return;
}
```

After looking through the functions (BFS), I came across this one:

```c

/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void FUN_400d1614(uint param_1)

{
  byte bVar1;
  int iVar2;
  int iVar3;
  byte bVar4;
  uint uVar5;
  int iVar6;
  int in_WindowStart;
  undefined auStack_30 [12];
  uint uStack_24;
  
  memw();
  memw();
  uStack_24 = _DAT_3ffc20ec;
  FUN_400d36ec(0x3ffc1ecc,s_i2c_recv_%d_byte(s):_3f400163,param_1);
  iVar2 = (uint)(in_WindowStart == 0) * (int)auStack_30;
  iVar3 = (uint)(in_WindowStart != 0) * (int)(auStack_30 + -(param_1 + 0xf &amp; 0xfffffff0));
  FUN_400d37e0(0x3ffc1cdc,iVar2 + iVar3,param_1);
  FUN_400d2fa8(iVar2 + iVar3,param_1);
  if (0 < (int)param_1) {
    uVar5 = (uint)*(byte *)(iVar2 + iVar3);
    if (uVar5 != 0x52) goto LAB_400d1689;
    memw();
    uRam3ffc1c80 = 0;
  }
  while( true ) {
    uVar5 = uStack_24;
    param_1 = _DAT_3ffc20ec;
    memw();
    memw();
    if (uStack_24 == _DAT_3ffc20ec) break;
    func_0x40082818();
LAB_400d1689:
    if (uVar5 == 0x46) {
      iVar6 = 0;
      do {
        memw();
        bVar1 = (&amp;DAT_3ffbdb6a)[iVar6];
        bVar4 = FUN_400d1508();
        memw();
        *(byte *)(iVar6 + 0x3ffc1c80) = bVar1 ^ bVar4;
        iVar6 = iVar6 + 1;
      } while (iVar6 != 0x10);
    }
    else if (uVar5 == 0x4d) {
      memw();
      uRam3ffc1c80 = DAT_3ffbdb7a;
      memw();
    }
    else if ((param_1 != 1) &amp;&amp; (uVar5 == 0x43)) {
      memw();
      bVar1 = *(byte *)(*(byte *)(iVar2 + iVar3 + 1) + 0x3ffbdb09);
      bVar4 = FUN_400d1508();
      memw();
      (&amp;DAT_3ffc1c1f)[*(byte *)(iVar2 + iVar3 + 1)] = bVar1 ^ bVar4;
    }
  }
  return;
}
```

clicking on the `DAT_3ffbdb6a` symbol I found that it points to an interesting string:

![](/ctf-writeups/tisc24/hardware_interesting_string.png)

A fake flag! This proves we're on the right track. The function above is probably the main function, and `FUN_400f25bc` is probably analgous to `__libc_start_main`?

Let's take a closer look at this branch:

```c
    if (uVar5 == 0x46) {
      iVar6 = 0;
      do {
        memw();
        bVar1 = (&amp;DAT_3ffbdb6a)[iVar6]; // the fake flag
        bVar4 = FUN_400d1508();
        memw();
        *(byte *)(iVar6 + 0x3ffc1c80) = bVar1 ^ bVar4;
        iVar6 = iVar6 + 1;
      } while (iVar6 != 0x10);
    }
```

So it's xoring the flag with the output of a mystery function, `FUN_400d1508`. (It's unclear what is done with the result, but most likely it's being outputted in some way?) Let's have a look at that function:

```c
ushort FUN_400d1508(void)

{
  ushort uVar1;
  
  memw();
  memw();
  uVar1 = DAT_3ffbdb68 << 7 ^ DAT_3ffbdb68;
  memw();
  memw();
  memw();
  uVar1 = uVar1 >> 9 ^ uVar1;
  memw();
  memw();
  memw();
  DAT_3ffbdb68 = uVar1 << 8 ^ uVar1;
  memw();
  memw();
  return DAT_3ffbdb68;
}
```

`DAT_3ffbdb68` is a 2 byte region of memory right before the fake flag. So it is presumably some sort of global variable that gets updated each time the function is called. I tried to simplify the equation used to update it but failed to do so. However, safe to say that the resulting xored flag is determined based on the starting value of `DAT_3ffbdb68`.

Now looking back at the main function `FUN_400d1614`, it's reasonable to deduce that `uVar5` is a value supplied by the user, like an opcode of sorts, and if we somehow send `0x46` to the firmware it should return us the xored flag. This xored flag can then be easily brute-forced by trying all 65536 values for `DAT_3ffbdb68`.

# Testing/fuzzing the firmware

Note: when I was doing my testing on the firmware interface provided, I used the following branch for testing.

```c
    else if (uVar5 == 0x4d) {
      memw();
      uRam3ffc1c80 = DAT_3ffbdb7a; // DAT_3ffbdb7a = &quot;BRYXcorp_CrapTPM&quot;
      memw();
    }
```

I assumed that passing `0x4d` to the firmware would result in the string &quot;BRYXcorp_CrapTPM&quot; being returned.

Now I had to figure out how to interact with the firmware. Here is the firmware interface provided (nc command in chal description):

![](/ctf-writeups/tisc24/firmware_interface.png)

Looking at the example for SEND, it seems like the first argument is some address or opcode, and the second argument is the payload.

I tried sending `SEND 12 4d` followed by `RECV 4` but I received only null bytes. After some more unsuccessful tries, I decided to see if it was possible to brute force the first argument (after all, it's only 1 byte). I wrote the following python script to do so:

```python:t.py
from pwn import *
import random

t = remote('chals.tisc24.ctf.sg', 61622)

t.recvuntil(b'\n\n> ')

for i in range(256):
    t.sendline(f'SEND {hex(i)[2:]} 4d'.encode())
    t.sendlineafter(b'> ', b'RECV 10')
    data = t.recvline()
    if data != b'00 00 00 00 00 00 00 00 00 00\n':
        print(hex(i))
        print(data)
    t.recvuntil(b'> ')
```

This printed out the following:

```plaintext
0xd3
b'42 52 59 58 63 6f 72 70 5f 43\n'
0xd4
b'72 61 70 54 50 4d 00 00 00 00\n'
```

This looks like ascii text! Decoding it does indeed give the string &quot;BRYXcorp_CrapTPM&quot;, which means our hypothesis is correct!

However, when I tried `SEND d3 46` followed by `RECV 16` I received all null bytes. Maybe some of the bytes sent by my script prior to `0xd3` were important? I tried randomizing the order in which I sent the bytes (shuffle `range(256)`) and now nothing was being received. So indeed, somewhere along the line one or more of the `SEND n 4d` commands did ... something. But the command with `0xd3` was where we actually got bytes returned.

Applying that logic, I wrote the following script:

```python:s.py
from pwn import *

t = remote('chals.tisc24.ctf.sg', 61622)

t.recvuntil(b'\n\n> ')

for i in range(0xd3):
    t.sendline(f'SEND {hex(i)[2:]} 46'.encode())
    t.recvuntil(b'> ')

t.sendline(b'SEND d3 46')
t.sendlineafter(b'> ', b'RECV 16')
print(t.recvline())
t.interactive()
```

`af 02 df ed 8b c2 b8 58 2a e8 94 69 91 2e b9 6f` was printed. I wrote yet another script to brute force the flag:

```python:s.py
enc = b'\xaf\x02\xdf\xed\x8b\xc2\xb8\x58\x2a\xe8\x94\x69\x91\x2e\xb9\x6f'

for i in range(65536):
    curr = i
    mask = 2**16 - 1
    res = []
    for i in range(16):
        curr = ((curr << 7) ^ curr) &amp; mask
        curr = ((curr >> 9) ^ curr) &amp; mask
        curr = ((curr << 8) ^ curr) &amp; mask
        res.append(curr &amp; 255)
    decoded = bytes([a ^ b for a, b in zip(res, enc)])
    if decoded.startswith(b'TISC'):
        print(i)
        print(decoded)
```

After running this script, the flag was printed!

`TISC{hwfuninnit}`

# Closing thoughts

I think I got quite lucky in the course of solving this level, as many of my guesses proved to be correct."><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a aria-current="page" href="/ctf-writeups/hardware-isnt-that-hard" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-8"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a aria-current="page" href="/ctf-writeups/hardware-isnt-that-hard" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-2xl opacity-40 mb-1"></span><h1 class="mb-7">Hardware isnt that Hard!</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>Shucks... it seems like our enemies are making their own silicon chips??!? They have decided to make their own source of trust, a TPM (Trusted Platform Module) or I guess their best attempt at it.</p>
<p>Your fellow agent smuggled one out for us to reverse engineer. Don't ask us how we did it, we just did it, it was hard ...</p>
<p>All we know so far is that their TPM connects to other devices using the i2c bus and does some security stuff inside. Agent! Your mission, should you choose to accept it, is to get us unparalleled intel by finding their TPM's weakness and exfiltrating its secrets.</p>
<p>You will be provided with the following compressed flash dump:</p>
<ul>
<li>MD5 (flash_dump.bin.xz) = fdff2dbda38f694111ad744061ca2f8a</li>
</ul>
<p>Flash was dumped from the device using the command:
<code>esptool.py -p /dev/REDACTED -b 921600 read_flash 0 0x400000 flash_dump.bin</code></p>
<p>You can perform your attack on a live TPM module via the i2c implant device hosted behind enemy lines: <code>nc chals.tisc24.ctf.sg 61622</code></p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">keyboard_double_arrow_left</i><span class="mr-4 text-black font-semibold">rev</span></div><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">memory</i><span class="mr-4 text-black font-semibold">hardware</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">89 solves</span><span class="opacity-60">0 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by jiefeng</span></div></div><div class="dotted-line-hori self-stretch w-auto mx-4 mt-10 mb-7 max-md:mx-0"></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p>I was kind of scared when I first read the challenge description, as I had never done a firmware rev chal before.</p>
<h1 id="overview" tabindex="-1">Overview</h1>
<p>I started by trying to get an overall idea of the the various concepts involved, beginning with the Trusted Platform Module (TPM). I watched <a href="https://www.youtube.com/watch?v=RW2zHvVO09g">this video</a>.</p>
<p>Based on my understanding, a TPM is a piece of hardware that does encryption and decryption of data passed to it. It has a "mini-processor" and the key is stored inside it, allowing all operations to occur independently of the actual computer. Hence, it is impossible for an attacker to inject their own code or otherwise interfere with the encryption and decryption algorithms. Neither is it possible to leak the encryption key since it is stored on an entirely different memory chip.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/b/be/TPM.svg" alt=""></p>
<p>Next, I began researching ways to reverse the firmware dump. My search led to <a href="https://github.com/tenable/esp32_image_parser">esp32_image_parser</a> on github (some other useful resources I came across are <a href="https://github.com/BlackVS/ESP32-reversing?tab=readme-ov-file#firmware">https://github.com/BlackVS/ESP32-reversing?tab=readme-ov-file#firmware</a> and <a href="https://olof-astrand.medium.com/reverse-engineering-of-esp32-flash-dumps-with-ghidra-or-ida-pro-8c7c58871e68">https://olof-astrand.medium.com/reverse-engineering-of-esp32-flash-dumps-with-ghidra-or-ida-pro-8c7c58871e68</a>)</p>
<h1 id="extracting-the-firmware-elf" tabindex="-1">Extracting the firmware ELF</h1>
<p>The first thing to do is list the partitions on the firmware dump. This is done with <code>python esp32_image_parser.py show_partitions flash_dump.bin</code></p>
<pre class="named-fence-block"><code class="language-plaintext">reading partition table...
entry 0:
  label      : nvs
  offset     : 0x9000
  length     : 20480
  type       : 1 [DATA]
  sub type   : 2 [WIFI]

entry 1:
  label      : otadata
  offset     : 0xe000
  length     : 8192
  type       : 1 [DATA]
  sub type   : 0 [OTA]

entry 2:
  label      : app0
  offset     : 0x10000
  length     : 1310720
  type       : 0 [APP]
  sub type   : 16 [ota_0]

entry 3:
  label      : app1
  offset     : 0x150000
  length     : 1310720
  type       : 0 [APP]
  sub type   : 17 [ota_1]

entry 4:
  label      : spiffs
  offset     : 0x290000
  length     : 1441792
  type       : 1 [DATA]
  sub type   : 130 [unknown]

entry 5:
  label      : coredump
  offset     : 0x3f0000
  length     : 65536
  type       : 1 [DATA]
  sub type   : 3 [unknown]

MD5sum: 
972dae2ff872a0142d60bad124c0666b
Done
</code><div class="named-fence-filename">output</div></pre>
<p>To get an idea of what each partition is for, I watched <a href="https://www.youtube.com/watch?v=eGZ-TxHpm24">this video</a>. I concluded that the main program code should be in either the app0 or app1 partition.</p>
<p>I tried to dump it using the command <code>python esp32_image_parser.py dump_partition flash_dump.bin -partition app0</code>. This produced the file <code>app0_out.bin</code>. Then I tried to extract it as an ELF using the command <code>python esp32_image_parser.py create_elf flash_dump.bin -partition app0 -output app0.elf</code>. There were a number of errors but looking through the github issues and pull requests I was able to apply the relevant patches to fix each issue. Here are all the patches I applied:</p>
<pre class="named-fence-block"><code class="language-plaintext">diff --git a/esp32_image_parser.py b/esp32_image_parser.py
index 6503cf7..0abcc86 100755
--- a/esp32_image_parser.py
+++ b/esp32_image_parser.py
@@ -6,6 +6,7 @@ import json
 import os, argparse
 from makeelf.elf import *
 from esptool import *
+from esptool.bin_image import *
 from esp32_firmware_reader import *
 from read_nvs import *
 
@@ -53,6 +54,7 @@ def image2elf(filename, output_file, verbose=False):
     section_map = {
         'DROM'                      : '.flash.rodata',
         'BYTE_ACCESSIBLE, DRAM, DMA': '.dram0.data',
+        'BYTE_ACCESSIBLE, DRAM': '.dram0.data',  # hope this works
         'IROM'                      : '.flash.text',
         #'RTC_IRAM'                  : '.rtc.text' TODO
     }
@@ -154,7 +156,9 @@ def image2elf(filename, output_file, verbose=False):
 
         if (name == '.iram0.vectors'):
             # combine these
-            size = len(section_data['.iram0.vectors']['data']) + len(section_data['.iram0.text']['data'])
+            size = len(section_data['.iram0.vectors']['data']) # + len(section_data['.iram0.text']['data'])
+            if '.iram0.text' in section_data:
+                size += len(section_data['.iram0.text']['data'])
         else:
             size = len(section_data[name]['data'])
</code><div class="named-fence-filename">git</div></pre>
<p>Now, rerunning the command produces an ELF file. To decompile the file with ghidra, I had to install ghidra version 11+ as previous versions did not have support for xtensa esp32 instructions (another option was using https://github.com/Ebiroll/ghidra-xtensa). Now after importing the file into ghidra, we can see the decompilation.</p>
<p><img src="/ctf-writeups/tisc24/firmware_decomp.png" alt=""></p>
<p>To be honest, I wasn't expecting the decompilation to work since I wasn't even sure if the ELF had been extracted correctly, or if the patches had messed it up somehow. Anyway, I continued on.</p>
<h1 id="reversing-the-elf" tabindex="-1">Reversing the ELF</h1>
<p>The entry function seems to be quite complex and there is no immediately obvious program logic. One good way to locate the program logic is to try and find where readable strings are being used. A strings check on the ELF file yielded a very long list, but one string in particular stood out: <code>BRYXcorp_CrapTPM v1.0-TISC!</code>.</p>
<p>I searched for this string in ghidra using <code>Search &gt; Memory</code></p>
<p><img src="/ctf-writeups/tisc24/hardware_ghidra_search.png" alt=""></p>
<p>Following its references, we can see its being used in the following function:</p>
<pre><code class="language-c">void FUN_400d1578(void)

{
  FUN_400d3470(0x3ffc1ecc,0x1c200,0x800001c,0xffffffff,0xffffffff,0,20000,0x70);
  FUN_400d3670(0x3ffc1ecc,1);
  FUN_400f25bc(0x3ffc1cdc,FUN_400d1614);
  FUN_400f25c4(0x3ffc1cdc,FUN_400d15e8);
  FUN_400d17d8(0x3ffc1cdc,0x69,0xffffffff,0xffffffff,0);
  FUN_400d379c(0x3ffc1ecc,s_BRYXcorp_CrapTPM_v1.0-TISC!_====_3f400120);
  do {
    DAT_3ffbdb68 = FUN_400d1b04(4);
    memw();
    memw();
  } while (DAT_3ffbdb68 == 0);
  return;
}
</code></pre>
<p>After looking through the functions (BFS), I came across this one:</p>
<pre><code class="language-c">
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

void FUN_400d1614(uint param_1)

{
  byte bVar1;
  int iVar2;
  int iVar3;
  byte bVar4;
  uint uVar5;
  int iVar6;
  int in_WindowStart;
  undefined auStack_30 [12];
  uint uStack_24;
  
  memw();
  memw();
  uStack_24 = _DAT_3ffc20ec;
  FUN_400d36ec(0x3ffc1ecc,s_i2c_recv_%d_byte(s):_3f400163,param_1);
  iVar2 = (uint)(in_WindowStart == 0) * (int)auStack_30;
  iVar3 = (uint)(in_WindowStart != 0) * (int)(auStack_30 + -(param_1 + 0xf &amp; 0xfffffff0));
  FUN_400d37e0(0x3ffc1cdc,iVar2 + iVar3,param_1);
  FUN_400d2fa8(iVar2 + iVar3,param_1);
  if (0 &lt; (int)param_1) {
    uVar5 = (uint)*(byte *)(iVar2 + iVar3);
    if (uVar5 != 0x52) goto LAB_400d1689;
    memw();
    uRam3ffc1c80 = 0;
  }
  while( true ) {
    uVar5 = uStack_24;
    param_1 = _DAT_3ffc20ec;
    memw();
    memw();
    if (uStack_24 == _DAT_3ffc20ec) break;
    func_0x40082818();
LAB_400d1689:
    if (uVar5 == 0x46) {
      iVar6 = 0;
      do {
        memw();
        bVar1 = (&amp;DAT_3ffbdb6a)[iVar6];
        bVar4 = FUN_400d1508();
        memw();
        *(byte *)(iVar6 + 0x3ffc1c80) = bVar1 ^ bVar4;
        iVar6 = iVar6 + 1;
      } while (iVar6 != 0x10);
    }
    else if (uVar5 == 0x4d) {
      memw();
      uRam3ffc1c80 = DAT_3ffbdb7a;
      memw();
    }
    else if ((param_1 != 1) &amp;&amp; (uVar5 == 0x43)) {
      memw();
      bVar1 = *(byte *)(*(byte *)(iVar2 + iVar3 + 1) + 0x3ffbdb09);
      bVar4 = FUN_400d1508();
      memw();
      (&amp;DAT_3ffc1c1f)[*(byte *)(iVar2 + iVar3 + 1)] = bVar1 ^ bVar4;
    }
  }
  return;
}
</code></pre>
<p>clicking on the <code>DAT_3ffbdb6a</code> symbol I found that it points to an interesting string:</p>
<p><img src="/ctf-writeups/tisc24/hardware_interesting_string.png" alt=""></p>
<p>A fake flag! This proves we're on the right track. The function above is probably the main function, and <code>FUN_400f25bc</code> is probably analgous to <code>__libc_start_main</code>?</p>
<p>Let's take a closer look at this branch:</p>
<pre><code class="language-c">    if (uVar5 == 0x46) {
      iVar6 = 0;
      do {
        memw();
        bVar1 = (&amp;DAT_3ffbdb6a)[iVar6]; // the fake flag
        bVar4 = FUN_400d1508();
        memw();
        *(byte *)(iVar6 + 0x3ffc1c80) = bVar1 ^ bVar4;
        iVar6 = iVar6 + 1;
      } while (iVar6 != 0x10);
    }
</code></pre>
<p>So it's xoring the flag with the output of a mystery function, <code>FUN_400d1508</code>. (It's unclear what is done with the result, but most likely it's being outputted in some way?) Let's have a look at that function:</p>
<pre><code class="language-c">ushort FUN_400d1508(void)

{
  ushort uVar1;
  
  memw();
  memw();
  uVar1 = DAT_3ffbdb68 &lt;&lt; 7 ^ DAT_3ffbdb68;
  memw();
  memw();
  memw();
  uVar1 = uVar1 &gt;&gt; 9 ^ uVar1;
  memw();
  memw();
  memw();
  DAT_3ffbdb68 = uVar1 &lt;&lt; 8 ^ uVar1;
  memw();
  memw();
  return DAT_3ffbdb68;
}
</code></pre>
<p><code>DAT_3ffbdb68</code> is a 2 byte region of memory right before the fake flag. So it is presumably some sort of global variable that gets updated each time the function is called. I tried to simplify the equation used to update it but failed to do so. However, safe to say that the resulting xored flag is determined based on the starting value of <code>DAT_3ffbdb68</code>.</p>
<p>Now looking back at the main function <code>FUN_400d1614</code>, it's reasonable to deduce that <code>uVar5</code> is a value supplied by the user, like an opcode of sorts, and if we somehow send <code>0x46</code> to the firmware it should return us the xored flag. This xored flag can then be easily brute-forced by trying all 65536 values for <code>DAT_3ffbdb68</code>.</p>
<h1 id="testing%2Ffuzzing-the-firmware" tabindex="-1">Testing/fuzzing the firmware</h1>
<p>Note: when I was doing my testing on the firmware interface provided, I used the following branch for testing.</p>
<pre><code class="language-c">    else if (uVar5 == 0x4d) {
      memw();
      uRam3ffc1c80 = DAT_3ffbdb7a; // DAT_3ffbdb7a = "BRYXcorp_CrapTPM"
      memw();
    }
</code></pre>
<p>I assumed that passing <code>0x4d</code> to the firmware would result in the string "BRYXcorp_CrapTPM" being returned.</p>
<p>Now I had to figure out how to interact with the firmware. Here is the firmware interface provided (nc command in chal description):</p>
<p><img src="/ctf-writeups/tisc24/firmware_interface.png" alt=""></p>
<p>Looking at the example for SEND, it seems like the first argument is some address or opcode, and the second argument is the payload.</p>
<p>I tried sending <code>SEND 12 4d</code> followed by <code>RECV 4</code> but I received only null bytes. After some more unsuccessful tries, I decided to see if it was possible to brute force the first argument (after all, it's only 1 byte). I wrote the following python script to do so:</p>
<pre class="named-fence-block"><code class="language-python">from pwn import *
import random

t = remote('chals.tisc24.ctf.sg', 61622)

t.recvuntil(b'\n\n&gt; ')

for i in range(256):
    t.sendline(f'SEND {hex(i)[2:]} 4d'.encode())
    t.sendlineafter(b'&gt; ', b'RECV 10')
    data = t.recvline()
    if data != b'00 00 00 00 00 00 00 00 00 00\n':
        print(hex(i))
        print(data)
    t.recvuntil(b'&gt; ')
</code><div class="named-fence-filename">t.py</div></pre>
<p>This printed out the following:</p>
<pre><code class="language-plaintext">0xd3
b'42 52 59 58 63 6f 72 70 5f 43\n'
0xd4
b'72 61 70 54 50 4d 00 00 00 00\n'
</code></pre>
<p>This looks like ascii text! Decoding it does indeed give the string "BRYXcorp_CrapTPM", which means our hypothesis is correct!</p>
<p>However, when I tried <code>SEND d3 46</code> followed by <code>RECV 16</code> I received all null bytes. Maybe some of the bytes sent by my script prior to <code>0xd3</code> were important? I tried randomizing the order in which I sent the bytes (shuffle <code>range(256)</code>) and now nothing was being received. So indeed, somewhere along the line one or more of the <code>SEND n 4d</code> commands did ... something. But the command with <code>0xd3</code> was where we actually got bytes returned.</p>
<p>Applying that logic, I wrote the following script:</p>
<pre class="named-fence-block"><code class="language-python">from pwn import *

t = remote('chals.tisc24.ctf.sg', 61622)

t.recvuntil(b'\n\n&gt; ')

for i in range(0xd3):
    t.sendline(f'SEND {hex(i)[2:]} 46'.encode())
    t.recvuntil(b'&gt; ')

t.sendline(b'SEND d3 46')
t.sendlineafter(b'&gt; ', b'RECV 16')
print(t.recvline())
t.interactive()
</code><div class="named-fence-filename">s.py</div></pre>
<p><code>af 02 df ed 8b c2 b8 58 2a e8 94 69 91 2e b9 6f</code> was printed. I wrote yet another script to brute force the flag:</p>
<pre class="named-fence-block"><code class="language-python">enc = b'\xaf\x02\xdf\xed\x8b\xc2\xb8\x58\x2a\xe8\x94\x69\x91\x2e\xb9\x6f'

for i in range(65536):
    curr = i
    mask = 2**16 - 1
    res = []
    for i in range(16):
        curr = ((curr &lt;&lt; 7) ^ curr) &amp; mask
        curr = ((curr &gt;&gt; 9) ^ curr) &amp; mask
        curr = ((curr &lt;&lt; 8) ^ curr) &amp; mask
        res.append(curr &amp; 255)
    decoded = bytes([a ^ b for a, b in zip(res, enc)])
    if decoded.startswith(b'TISC'):
        print(i)
        print(decoded)
</code><div class="named-fence-filename">s.py</div></pre>
<p>After running this script, the flag was printed!</p>
<p><code>TISC{hwfuninnit}</code></p>
<h1 id="closing-thoughts" tabindex="-1">Closing thoughts</h1>
<p>I think I got quite lucky in the course of solving this level, as many of my guesses proved to be correct.</p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div></div></div>
    
  

</body></html>