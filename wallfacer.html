<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>TISC 2024 - Wallfacer</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-743000a6.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-393c89c5.css">
  <meta property="article:tag" content="TISC 2024"><meta property="article:tag" content="rev"><meta property="article:tag" content="mobile"><meta name="description" content="Installing the apk reveals very little:

![](/ctf-writeups/tisc24/wallfacer_home.jpg)

# Java decompilation

I used jadx to decompile the apk: `jadx wallfacer-x86_64.apk`. We can see a number of decompiled java files under `sources/com/wall/facer`:

![](/ctf-writeups/tisc24/wallfacer_java_files.png)

Storage is a simple class implementing the singleton pattern, with a secretMessage property:

```java:Storage.java
package com.wall.facer;
/* loaded from: classes.dex */
public class Storage {
    private static Storage instance;
    private String secretMessage;

    private Storage() {
    }

    public static synchronized Storage getInstance() {
        Storage storage;
        synchronized (Storage.class) {
            try {
                if (instance == null) {
                    instance = new Storage();
                }
                storage = instance;
            } catch (Throwable th) {
                throw th;
            }
        }
        return storage;
    }

    public synchronized String getMessage() {
        return this.secretMessage;
    }

    public synchronized void saveMessage(String str) {
        this.secretMessage = str;
    }
}
```

MainActivity.java is the controller for the above home page. Its implementation is also very barebones:

```java:MainActivity.java
package com.wall.facer;

import android.os.Bundle;
import android.view.View;
import android.widget.EditText;
/* loaded from: classes.dex */
public class MainActivity extends C0 {
    public EditText y;

    @Override // defpackage.C0, defpackage.O3, android.app.Activity
    public final void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_main);
        this.y = (EditText) findViewById(R.id.edit_text);
    }

    public void onSubmitClicked(View view) {
        Storage.getInstance().saveMessage(this.y.getText().toString());
    }
}
```

There is another activity class, query:

```java:query.java
package com.wall.facer;

import android.content.Context;
import android.os.Bundle;
import android.util.Base64;
import android.util.Log;
import android.view.View;
import android.widget.EditText;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;
/* loaded from: classes.dex */
public class query extends C0 {
    public EditText y;
    public EditText z;

    @Override // defpackage.C0, defpackage.O3, android.app.Activity
    public final void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_query);
        this.y = (EditText) findViewById(R.id.key_text);
        this.z = (EditText) findViewById(R.id.iv_text);
    }

    public void onSubmitClicked(View view) {
        Context applicationContext = getApplicationContext();
        String obj = this.y.getText().toString();
        String obj2 = this.z.getText().toString();
        try {
            byte[] decode = Base64.decode(applicationContext.getString(R.string.str), 0);
            byte[] bytes = obj.getBytes();
            byte[] bytes2 = obj2.getBytes();
            Cipher cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;);
            cipher.init(2, new SecretKeySpec(bytes, &quot;AES&quot;), new IvParameterSpec(bytes2));
            Log.d(getString(R.string.tag), &quot;Decrypted data: &quot;.concat(new String(cipher.doFinal(decode))));
        } catch (Exception unused) {
            Log.e(getString(R.string.tag), &quot;Failed to decrypt data&quot;);
        }
    }
}
```

It seems to be a page where string decryption is going on, however we have to provide the key and iv. The value of `R.string.str` can be found under `resources/res/values/strings.xml`: 

```xml:strings.xml
...
    <string name=&quot;str&quot;>4tYKEbM6WqQcItBx0GMJvssyGHpVTJMhpjxHVLEZLVK6cmIH7jAmI/nwEJ1gUDo2</string>
...
```

Looking around the file, I found a few other interesting strings:

```xml:strings.xml
...
    <string name=&quot;base&quot;>d2FsbG93aW5wYWlu</string>
...
    <string name=&quot;dir&quot;>ZGF0YS8</string>
...
    <string name=&quot;filename&quot;>c3FsaXRlLmRi</string>
...
```

They seem to also be base64-encoded. Decoding them gives base = `wallowinpain`, dir = `data/`, filename = `sqlite.db`.

Under `resources/assets`, I noticed a `sqlite.db` file. However, attempts to open it were met with the error: `file is not a database`. I tried various methods to patch the file unsuccessfully. Furthermore, a strings check on the file does not return any readable text except for the sqlite header.

> **Stuff that didn't work**
> 
> At this point, I went down a few different rabbit holes. Following the hint in the challenge description that *something* was being loaded at runtime, I rooted my android emulator (took way longer than I would like to admit) and used [Fridump](https://github.com/Nightbringer21/fridump) to dump the app memory. I thought that perhaps the sqlite file was being decrypted at runtime, so the decrypted file would be in the memory dump. This proved to be false.

Eventually, I returned to the three mysterious strings and tried to figure out where they were being used. We can find the string ids in `R.java`

```java:R.java
...
        public static final int base = 0x7f0f001e;
...
        public static final int dir = 0x7f0f0030;
...
        public static final int filename = 0x7f0f0038;
...
```

Running a global search for the string ids (both hex and decimal format) yielded nothing. Maybe they are referenced in binary files? I searched for this using: `grep -aRP '8\x00\x0f\x7f' .`. Sure enough, a match was returned for `filename`'s id inside `resoucers/classes.dex`. I postulated that the java decompilation was missing something, so I looked in the smali decompilation (smali is basically a human readable representation of Dalvik bytecode, so decompiling to smali is lossless).

Using `apktool d wallfacer-x86_64.apk`, we can access the smali files. Searching for `0x7f0f0038` shows that is being used in `K0.smali`.

# Extracting DynamicClass

We reverse it section by section:

```plaintext:K0.smali
    const v0, 0x7f0f0038

    :try_start_0
    invoke-virtual {p0, v0}, Landroid/content/Context;->getString(I)Ljava/lang/String;

    move-result-object v0
```

Fortunately, the smali decompilation is verbose enough that we can kind of figure out what's going on. For parts that I didn't understand, I consulted ChatGPT or Google. The above section does something like `v0 = context.getString(0x7f0f0038)`.

```plaintext:K0.smali
    new-instance v1, Ljava/lang/String;

    const/4 v2, 0x0

    invoke-static {v0, v2}, Landroid/util/Base64;->decode(Ljava/lang/String;I)[B

    move-result-object v0

    invoke-direct {v1, v0}, Ljava/lang/String;-><init>([B)V

    invoke-static {p0, v1}, LA8;->K(Landroid/content/Context;Ljava/lang/String;)Ljava/nio/ByteBuffer;

    move-result-object v0
```

Now this does `v0 = A8.K(context, new String(Base64.decode(v0, 0)))`. We will investigate the `A8.K` function later.

```plaintext:K0.smali
    new-instance v1, Ldalvik/system/InMemoryDexClassLoader;

    invoke-virtual {p0}, Landroid/content/Context;->getClassLoader()Ljava/lang/ClassLoader;

    move-result-object v2

    invoke-direct {v1, v0, v2}, Ldalvik/system/InMemoryDexClassLoader;-><init>(Ljava/nio/ByteBuffer;Ljava/lang/ClassLoader;)V
```

`v1 = new InMemoryDexClassLoader(v0, context.getClassLoader())`

```plaintext:K0.smali
    const-string v0, &quot;DynamicClass&quot;

    invoke-virtual {v1, v0}, Ljava/lang/ClassLoader;->loadClass(Ljava/lang/String;)Ljava/lang/Class;

    move-result-object v0
```

`v0 = v1.loadClass(&quot;DynamicClass&quot;)`

```plaintext:K0.smali
    const-class v1, Landroid/content/Context;

    filled-new-array {v1}, [Ljava/lang/Class;

    move-result-object v1

    const-string v2, &quot;dynamicMethod&quot;

    invoke-virtual {v0, v2, v1}, Ljava/lang/Class;->getMethod(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;

    move-result-object v0
```

`v0.getMethod(&quot;dynamicMethod&quot;, new java.lang.Class[] { android.content.Context })`

So it seems that `A8.K` is loading bytecode used to construct DynamicClass, and the method dynamicMethod is then invoked on it.

Fortunately for us, the `A8` class seems to be correctly decompiled to java and we can find it under `sources/defpackage` (in the jadx decompilation).

```java:A8.java
    public static ByteBuffer K(Context context, String str) {
        int i2;
        InputStream open = context.getAssets().open(str);
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] bArr = new byte[1024];
        while (true) {
            int read = open.read(bArr);
            if (read == -1) {
                break;
            }
            byteArrayOutputStream.write(bArr, 0, read);
        }
        open.close();
        byte[] byteArray = byteArrayOutputStream.toByteArray();
        // here, contents of assets/sqlite.db have been read to byteArray
        byte[] bArr2 = new byte[128];
        byte[] bArr3 = new byte[4];
        System.arraycopy(byteArray, 4096, bArr3, 0, 4);
        int i3 = ByteBuffer.wrap(bArr3).getInt();
        byte[] bArr4 = new byte[i3];
        System.arraycopy(byteArray, 4100, bArr4, 0, i3);
        System.arraycopy(byteArray, 4100 + i3, bArr2, 0, 128);
        C0289q1 c0289q1 = new C0289q1(bArr2);
        byte[] bArr5 = new byte[i3];
        int i4 = 0;
        int i5 = 0;
        for (i2 = 0; i2 < i3; i2++) {
            i4 = (i4 + 1) &amp; 255;
            byte[] bArr6 = (byte[]) c0289q1.c;
            byte b2 = bArr6[i4];
            i5 = (i5 + (b2 &amp; 255)) &amp; 255;
            bArr6[i4] = bArr6[i5];
            bArr6[i5] = b2;
            bArr5[i2] = (byte) (bArr6[(bArr6[i4] + b2) &amp; 255] ^ bArr4[i2]);
        }
        return ByteBuffer.wrap(bArr5);
    }
```

Here, the contents of `sqlite.db` are read to `byteArray`, and some copying is done. The signature of `System.arraycopy` is  `arraycopy(Object src, int srcPos, Object dest, int destPos, int length)`. The first 4 bytes read to bArr3 seem to be a length specifier, and the specified number of bytes is then read into bArr4, then the next 128 bytes are read to bArr2. Then the `C0289q1` class is created. I looked up the implementation:

```java:C0289q1.java
    public C0289q1(byte[] bArr) {
        this.a = 17;
        this.b = bArr;
        this.c = new byte[256];
        for (int i = 0; i < 256; i++) {
            ((byte[]) this.c)[i] = (byte) i;
        }
        int i2 = 0;
        for (int i3 = 0; i3 < 256; i3++) {
            byte[] bArr2 = (byte[]) this.c;
            byte b = bArr2[i3];
            byte[] bArr3 = (byte[]) this.b;
            i2 = (i2 + (b &amp; 255) + (bArr3[i3 % bArr3.length] &amp; 255)) &amp; 255;
            bArr2[i3] = bArr2[i2];
            bArr2[i2] = b;
        }
    }
```

I can't remember whether I reversed the function logic, but either way it is not necessary to figure out exactly what is going on, since the function is just moving values around. All we need for decryption is the sqlite.db file, and to translate the algorithm to python:

```python:h.py
with open('sqlite.db', 'rb') as f:
    data = f.read()
    chunksize = int.from_bytes(data[4096:4100], 'big')
    chunk = data[4100: 4100+chunksize]
    keything = data[4100+chunksize: 4100+chunksize+128]

    # calculate c0289q1.c
    c = [i for i in range(256)]
    acc = 0
    for i in range(256):
        temp = c[i]
        acc = (acc + temp + keything[i % 128]) &amp; 255
        c[i] = c[acc]
        c[acc] = temp
    print(c)

    bArr5 = [0 for _ in range(chunksize)]
    i4 = 0
    i5 = 0
    for i in range(chunksize):
        i4 = (i4 + 1) &amp; 255
        b2 = c[i4]
        i5 = (i5 + (b2 &amp; 255)) &amp; 255
        c[i4] = c[i5]
        c[i5] = b2
        bArr5[i] = (c[(c[i4] + b2) &amp; 255] ^ chunk[i])

with open('output.dex', 'wb') as f:
    f.write(bytes(bArr5))
```

# Extracting libnative.so

The resulting .dex file can be decompiled with `jadx output.dex`. Then we have the decompiled class under `output/sources/defpackage` (I added some comments):

```java:DynamicClass.java
package defpackage;

import android.content.Context;
import android.content.res.AssetManager;
import android.content.res.Resources;
import android.os.SystemClock;
import android.util.Base64;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.Comparator;
/* renamed from: DynamicClass  reason: default package */
/* loaded from: /home/smalldonkey/ctf/tisc24/l8/l8/wallfacer-x86_64/resources/assets/output.dex */
public class DynamicClass {
    static final /* synthetic */ boolean $assertionsDisabled = false;
    private static final String TAG = &quot;TISC&quot;;

    public static native void nativeMethod();

    public static void dynamicMethod(Context context) throws Exception {
        pollForTombMessage();
        Log.i(TAG, &quot;Tomb message received!&quot;);
        File generateNativeLibrary = generateNativeLibrary(context);
        try {
            System.load(generateNativeLibrary.getAbsolutePath());
        } catch (Throwable th) {
            String message = th.getMessage();
            message.getClass();
            Log.e(TAG, message);
            System.exit(-1);
        }
        Log.i(TAG, &quot;Native library loaded!&quot;);
        if (generateNativeLibrary.exists()) {
            generateNativeLibrary.delete();
        }
        pollForAdvanceMessage();
        Log.i(TAG, &quot;Advance message received!&quot;);
        nativeMethod();
    }

    private static void pollForTombMessage() throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Class<?> cls;
        do {
            SystemClock.sleep(1000L);
            cls = Class.forName(&quot;com.wall.facer.Storage&quot;);
        } while (!DynamicClass$$ExternalSyntheticBackport1.m((String) cls.getMethod(&quot;getMessage&quot;, new Class[0]).invoke(cls.getMethod(&quot;getInstance&quot;, new Class[0]).invoke(null, new Object[0]), new Object[0]), &quot;I am a tomb&quot;)); // Storage.getInstance().getMessage() == &quot;I am a tomb&quot;
    }

    private static void pollForAdvanceMessage() throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Class<?> cls;
        do {
            SystemClock.sleep(1000L);
            cls = Class.forName(&quot;com.wall.facer.Storage&quot;);
        } while (!DynamicClass$$ExternalSyntheticBackport1.m((String) cls.getMethod(&quot;getMessage&quot;, new Class[0]).invoke(cls.getMethod(&quot;getInstance&quot;, new Class[0]).invoke(null, new Object[0]), new Object[0]), &quot;Only Advance&quot;)); // Storage.getInstance().getMessage() == &quot;Only Advance&quot;
    }

    public static File generateNativeLibrary(Context context) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {
        AssetManager assets = context.getAssets();
        Resources resources = context.getResources();
        String str = new String(Base64.decode(resources.getString(resources.getIdentifier(&quot;dir&quot;, &quot;string&quot;, context.getPackageName())) + &quot;=&quot;, 0));
        // str = &quot;data/&quot;
        String[] list = assets.list(str);
        // sort files alphabetically
        Arrays.sort(list, new Comparator() { // from class: DynamicClass$$ExternalSyntheticLambda3
            @Override // java.util.Comparator
            public final int compare(Object obj, Object obj2) {
                int m;
                m = DynamicClass$$ExternalSyntheticBackport0.m(Integer.parseInt(((String) obj).split(&quot;\\$&quot;)[0]), Integer.parseInt(((String) obj2).split(&quot;\\$&quot;)[0]));
                return m;
            }
        });
        String str2 = new String(Base64.decode(resources.getString(resources.getIdentifier(&quot;base&quot;, &quot;string&quot;, context.getPackageName())), 0));
        // str2 = &quot;wallowinpain&quot;
        File file = new File(context.getFilesDir(), &quot;libnative.so&quot;);
        Method method = Class.forName(&quot;Oa&quot;).getMethod(&quot;a&quot;, byte[].class, String.class, byte[].class);
        FileOutputStream fileOutputStream = new FileOutputStream(file);
        try {
            for (String str3 : list) {
                InputStream open = assets.open(str + str3);
                byte[] readAllBytes = open.readAllBytes();
                open.close();
                fileOutputStream.write((byte[]) method.invoke(null, readAllBytes, str2, Base64.decode(str3.split(&quot;\\$&quot;)[1] + &quot;==&quot;, 8)));
            }
            fileOutputStream.close();
            return file;
        } catch (Throwable th) {
            try {
                fileOutputStream.close();
            } catch (Throwable th2) {
                Throwable.class.getDeclaredMethod(&quot;addSuppressed&quot;, Throwable.class).invoke(th, th2);
            }
            throw th;
        }
    }
}
```

`dynamicMethod` waits for the &quot;I am a tomb&quot; message, then loads a native library. This native library is dynamically loaded in `generateNativeLibrary`. 

Reading the decompilation, `generateNativeLibrary` is reading the files under `assets/data`, decrypting them, then combining the result to form the final native library. Let's take a look at the decryption function, `Oa.a`:

```java:Oa.java
package defpackage;

import javax.crypto.Cipher;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;
/* renamed from: Oa  reason: default package */
/* loaded from: classes.dex */
public class Oa {
    public static byte[] a(byte[] bArr, String str, byte[] bArr2) {
        byte[] b = b(str, bArr2);
        Cipher cipher = Cipher.getInstance(&quot;AES/GCM/NoPadding&quot;);
        byte[] bArr3 = new byte[12];
        int length = bArr.length - 12;
        byte[] bArr4 = new byte[length];
        System.arraycopy(bArr, 0, bArr3, 0, 12);
        System.arraycopy(bArr, 12, bArr4, 0, length);
        cipher.init(2, new SecretKeySpec(b, &quot;AES&quot;), new GCMParameterSpec(128, bArr3));
        return cipher.doFinal(bArr4);
    }

    private static byte[] b(String str, byte[] bArr) {
        return SecretKeyFactory.getInstance(&quot;PBKDF2WithHmacSHA256&quot;).generateSecret(new PBEKeySpec(str.toCharArray(), bArr, 16384, 256)).getEncoded();
    }
}
```

So the function `a` is doing AES GCM decryption. I compiled the necessary parts together to form the following java script:

```java:h2.java
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Base64;
import java.util.Arrays;
import java.util.Comparator;
import javax.crypto.Cipher;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;
import java.io.FileOutputStream;

public class h2 {
    public static byte[] a(byte[] bArr, String str, byte[] bArr2) throws Throwable {
        byte[] b = b(str, bArr2);
        Cipher cipher = Cipher.getInstance(&quot;AES/GCM/NoPadding&quot;);
        byte[] bArr3 = new byte[12];
        int length = bArr.length - 12;
        byte[] bArr4 = new byte[length];
        System.arraycopy(bArr, 0, bArr3, 0, 12);
        System.arraycopy(bArr, 12, bArr4, 0, length);
        cipher.init(2, new SecretKeySpec(b, &quot;AES&quot;), new GCMParameterSpec(128, bArr3));
        return cipher.doFinal(bArr4);
    }

    private static byte[] b(String str, byte[] bArr) throws Throwable {
        return SecretKeyFactory.getInstance(&quot;PBKDF2WithHmacSHA256&quot;).generateSecret(new PBEKeySpec(str.toCharArray(), bArr, 16384, 256)).getEncoded();
    }

    public static void main(String[] args) {
      try {
      File folder = new File(&quot;data/&quot;);
        File outFile = new File(&quot;libnative.so&quot;);
        FileOutputStream fileOutputStream = new FileOutputStream(outFile);

        // Check if the folder exists and is indeed a directory
        if (!folder.exists() || !folder.isDirectory()) {
            System.out.println(&quot;Invalid folder path.&quot;);
            return;
        }

        // List all files in the directory
        File[] files = folder.listFiles();
        Arrays.sort(files, new Comparator<File>() {
            @Override
            public int compare(File o1, File o2) {
                int n1 = Integer.parseInt(o1.getName().split(&quot;\\$&quot;)[0]);
                int n2 = Integer.parseInt(o2.getName().split(&quot;\\$&quot;)[0]);
                return n1 - n2;
            }
        });
        if (files != null) {
            for (File file : files) {
                if (file.isFile()) { // Only process files (not directories)
                System.out.println(&quot;reading file: &quot; + file.getName());
                    try (FileInputStream fis = new FileInputStream(file)) {
                        // Read file into byte array
                        byte[] fileBytes = new byte[(int) file.length()];
                        fis.read(fileBytes);
                        
                        // Call the function with filename and file bytes
                        byte[] result = a(fileBytes, &quot;wallowinpain&quot;, Base64.getDecoder().decode(file.getName().split(&quot;\\$&quot;)[1].replace('-', '+').replace('_', '/') + &quot;==&quot;));
                        fileOutputStream.write(result);
                    } catch (IOException e) {
                        System.out.println(&quot;Error reading file: &quot; + file.getName());
                        e.printStackTrace();
                    }
                }
            }
            fileOutputStream.close();
        } else {
            System.out.println(&quot;No files found in the folder.&quot;);
        }
    } catch (Throwable th) {
      System.out.println(&quot;An error occurred: &quot; + th);
    }
    }
}
```

I placed this file in `resources/assets`. Compile with `javac h2.java` and run it with `java h2.java`, and libnative.so pops out.

# Loading libnative.so

To do testing with this library I created a new project in Android Studio. Then I created a `jniLibs` folder under `app/src/main`, a subfolder `x86_64` under that, and copied libnative.so there. To load the library, I created the following java class:

```java:DynamicClass.java
package com.example.myapplication;

public class DynamicClass {
    static {
        System.loadLibrary(&quot;native&quot;);
    }

    public static native void nativeMethod();
}
```

I called nativeMethod when the main activity starts:

```kotlin:MainActivity.kt
...
    
    override fun onStart() {
        super.onStart()
        DynamicClass.nativeMethod()
    }

...
```

Now running the app, we can open up the LogCat window and filter by &quot;TISC&quot;:

![](/ctf-writeups/tisc24/libnative_logs_linkerr.png)

Unfortunately, get the error above: `java.lang.UnsatisfiedLinkError: No implementation found for void com.example.myapplication.DynamicClass.nativeMethod() (tried Java_com_example_myapplication_DynamicClass_nativeMethod and Java_com_example_myapplication_DynamicClass_nativeMethod__)`. So android requires a specific function name to resolve the native function, in the format `Java_<package>_<class_name>_<method_name>`.

Because it's a dynamically loaded java class, the package field is omitted, so the function in libnative.so is just called `Java_DynamicClass_nativeMethod`. But how do we get android to omit the package name when it searches for the function?

My solution was to rename the symbol in libnative.so to `Java_com_a_a_Test_nativeMethod`. This is the same length as the original function name so no problems should occur. I created a new android project with the package name `com.a.a`, and the java class named `Test`. Everything else remained the same. Here is the python script used to patch it:

```python:patch.py
import lief

with open('libnative.so', 'rb') as f:
    data = f.read()

newdata = data[:]

# NOTE: the following doesnt work, i have no idea why...
# newdata = newdata.replace(b'Java_DynamicClass_nativeMethod', b'Java_com_a_a_Test_nativeMethod')

with open('libnative1.so', 'wb') as f:
    f.write(newdata)

# instead i have to use lief to change method name:
lib = lief.parse('libnative1.so')
for x in lib.exported_symbols:
    if x.name == 'Java_DynamicClass_nativeMethod':
        x.name = 'Java_com_a_a_Test_nativeMethod'
lib.write('libnative1.so')
lib.write('/home/smalldonkey/dev/android/A/app/src/main/jniLibs/x86_64/libnative1.so')  # for convenience
```

In Test.java I changed `System.loadLibrary(&quot;native&quot;)` to `System.loadLibrary(&quot;native1&quot;)`. Running the app again, we see more logs, showing that the function was invoked successfully:

![](/ctf-writeups/tisc24/libnative_logs_fail.png)

Recalling the query.java activity earlier, I tried using the printed key and iv to decrypt the string:

```java:Decrypt.java
import java.util.Base64;
import java.util.Arrays;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

class Decrypt {
    public static void main(String[] args) {
        try {
            byte[] decode = Base64.getDecoder().decode(&quot;4tYKEbM6WqQcItBx0GMJvssyGHpVTJMhpjxHVLEZLVK6cmIH7jAmI/nwEJ1gUDo2&quot;);
            byte[] bytes = &quot;z?<NKKf7m?MUg&amp;>qBp\&quot;b9G$A!bzP&amp;0I(&quot;.getBytes();
            System.out.println(bytes.length);
            byte[] bytes2 = &quot;apI3`ipq.?3d!t#6&quot;.getBytes();
            System.out.println(bytes2.length);
            Cipher cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;);
            cipher.init(2, new SecretKeySpec(bytes, &quot;AES&quot;), new IvParameterSpec(bytes2));
            System.out.println(&quot;Decrypted data: &quot;.concat(new String(cipher.doFinal(decode))));
        } catch (Exception unused) {
            System.out.println(&quot;Failed to decrypt data&quot;);
            System.out.println(unused);
        }
    }
}
```

Unfortunately, this didn't work. Seems like we have to do more reversing to figure out how to get the correct key and iv.

# Reversing libnative.so

After importing libnative.so into ghidra, we can see the nativeMethod hook:

```c
void Java_DynamicClass_nativeMethod(undefined8 param_1)

{
  undefined4 uVar1;
  
  __android_log_print(3,&amp;DAT_00100a2f,
                      &quot;There are walls ahead that you\'ll need to face. They have been specially designed to always result in an error. One false move and you won\'t be able to get the desired result. Are you able to patch your way out of this mess?&quot;
                     );
  uVar1 = FUN_00103230();
  uVar1 = FUN_00101eb0(uVar1);
  uVar1 = FUN_00101f90(param_1,uVar1);
  FUN_001023f0(param_1,uVar1);
  return;
}
```

Referring to [this example](https://developer.android.com/ndk/samples/sample_hellojni#ci) from the android docs, we can see actual function signature:

```c
JNIEXPORT jstring JNICALL
Java_com_example_hellojni_HelloJni_stringFromJNI( JNIEnv* env,
                                                  jobject thiz )
```

I found [this github repo](https://github.com/extremecoders-re/ghidra-jni) containing the definitions for the JNI objects, which should greatly aid our decompilation. I imported it into ghidra following the instructions in the README.

I then updated the function signature (right click function name, edit function signature):

```c
void Java_com_a_a_Test_nativeMethod(JNIEnv *param_1)

{
  undefined4 uVar1;
  uint uVar2;
  
  __android_log_print(3,&amp;DAT_00100a2f,
                      &quot;There are walls ahead that you\'ll need to face. They have been specially des igned to always result in an error. One false move and you won\'t be able to g et the desired result. Are you able to patch your way out of this mess?&quot;
                     );
  uVar1 = FUN_00103230();
  uVar2 = FUN_00101eb0(uVar1);
  uVar2 = FUN_00101f90(param_1,uVar2);
  FUN_001023f0(param_1,uVar2);
  return;
}
```

This will be more useful for the third function call, `FUN_00101f90`, later on. For now, let's look at the first function `FUN_00103230`:

# First wall

```c
void FUN_00103230(void)

{
  syscall();
                    /* WARNING: Could not recover jumptable at 0x001032b2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
  (*(code *)PTR_LAB_00105c00)(0xffffff9c,s_/sys/wall/facer_00105ab0,0);
  return;
}
```

Looks some something went wrong in the decompilation. Looking at the disassembly, we can see what is actually going on.

```plaintext
   00103230 55         PUSH    RBP
   00103231 48 89 e5   MOV     RBP,RSP
   00103234 48 83      SUB     RSP,0x50
            ec 50
   00103238 48 8d      LEA     RAX,[PTR_LAB_00105c00]                           = 00103316
            05 c1 
            29 00 00
   0010323f 48 89      MOV     qword ptr [RBP + local_10],RAX=>PTR_LAB_00105c00 = 00103316
            45 f8
   00103243 c7 45      MOV     dword ptr [RBP + local_18],0x1
            f0 01 
            00 00 00
   0010324a c7 45      MOV     dword ptr [RBP + local_1c],0xffffff9c
            ec 9c 
            ff ff ff
   00103251 c7 45      MOV     dword ptr [RBP + local_20],0x0
            e8 00 
            00 00 00
   00103258 c7 45      MOV     dword ptr [RBP + local_24],0x0
            e4 00 
            00 00 00
   0010325f 8b 45 e4   MOV     EAX,dword ptr [RBP + local_24]
   00103262 89 45 dc   MOV     dword ptr [RBP + local_2c],EAX
   00103265 8b 7d ec   MOV     EDI,dword ptr [RBP + local_1c]
   00103268 8b 55 e8   MOV     EDX,dword ptr [RBP + local_20]
   0010326b 44 8b      MOV     R10D,dword ptr [RBP + local_2c]
            55 dc
   0010326f 48 8d      LEA     RSI,[s_/sys/wall/facer_00105ab0]                 = &quot;/sys/wall/facer&quot;
            35 3a 
            28 00 00
   00103276 b8 01      MOV     EAX,0x101
            01 00 00
   0010327b 0f 05      SYSCALL
   0010327d 89 45 e0   MOV     dword ptr [RBP + local_28],EAX
   00103280 8b 45 e0   MOV     EAX,dword ptr [RBP + local_28]
   00103283 c1 e8 1f   SHR     EAX,0x1f
   00103286 89 45 f4   MOV     dword ptr [RBP + local_14],EAX
   00103289 48 8b      MOV     RAX,qword ptr [RBP + local_10]
            45 f8
   0010328d 48 63      MOVSXD  RCX,dword ptr [RBP + local_14]
            4d f4
   00103291 48 8b      MOV     RAX=>PTR_LAB_00105c00,qword ptr [RAX + RCX*0x8]  = 00103316
            04 c8
   00103295 48 8d      LEA     RCX,[PTR_LAB_00105b60]                           = 001032b4
            0d c4 
            28 00 00
   0010329c 48 89      MOV     qword ptr [RBP + local_38],RCX=>PTR_LAB_00105b60 = 001032b4
            4d d0
   001032a0 c7 45      MOV     dword ptr [RBP + local_3c],0x2
            cc 02 
            00 00 00
   001032a7 48 89      MOV     qword ptr [RBP + local_48],RCX=>PTR_LAB_00105b60 = 001032b4
            4d c0
   001032ab c7 45      MOV     dword ptr [RBP + local_4c],0x2
            bc 02 
            00 00 00
   001032b2 ff e0      JMP     RAX
```

So it's performing a syscall with rax = 0x101. Consulting [https://x64.syscall.sh/](https://x64.syscall.sh/) shows that is an `openat` call. dfd = 0xffffff9c and filename = &quot;/sys/wall/facer&quot;. The output (in rax) is then shifted right by 31 bits and stored in rcx. Then we have `MOV     RAX=>PTR_LAB_00105c00,qword ptr [RAX + RCX*0x8]`. At the end, there is a `jmp rax` instruction.

The output of the `openat` syscall will return a file descriptor or a negative number if an error has occured (if the file does not exist, for example). The SHR instruction is basically checking whether the output is negative, and based on that, take either one of two paths under `PTR_LAB_00105c00`.

Viewing the `PTR_LAB_00105c00` symbol shows those two paths:

![](/ctf-writeups/tisc24/libnative_filecheck_branch.png)

The second branch (taken when output is negative, rcx = 1) prints out &quot;I need a very specific file to be available. Or do I?&quot;. The first branch, however, prints the string &quot;One wall down!&quot;, and it can be reached when the file is opened successfully.

```c
void UndefinedFunction_00103316(void)

{
  undefined4 uVar1;
  long unaff_RBP;
  
  *(undefined4 *)(unaff_RBP + -0x4c) = 8;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10));
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10),5);
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10),*(undefined4 *)(unaff_RBP + -0x4c));
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  __android_log_print(4,&amp;DAT_00100a2f,&quot;One wall down!&quot;);
                    /* WARNING: Could not recover jumptable at 0x0010336d. Too many branches */
                    /* WARNING: Treating indirect jump as call */
  (**(code **)(*(long *)(unaff_RBP + -0x40) + (long)*(int *)(unaff_RBP + -0x44) * 8))();
  return;
}
```

Looking at `FUN_00103370`, what it's doing is not immediately clear, but it's just doing some operations on some global values.

```c
/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

int FUN_00103370(int param_1,int param_2)

{
  int iVar1;
  int *piVar2;
  int *piVar3;
  int local_38 [4];
  int local_28;
  undefined auStack_18 [4];
  int local_14;
  int local_10;
  int local_c;
  
  piVar3 = (int *)auStack_18;
  local_10 = param_1;
  local_c = param_2;
  if (0x933c5b6d < (((DAT_00105b50 &amp; _DAT_00105b54) / 0xe671c09a ^ 0x509a612a) &amp; 0x2517461d)) {
    piVar3 = local_38;
    local_38[0] = param_2;
    local_28 = param_1 * param_2;
  }
  do {
    iVar1 = local_c;
    piVar2 = piVar3 + -4;
    piVar3 = piVar3 + -8;
    *piVar2 = local_10;
    *piVar3 = iVar1;
    *piVar2 = *piVar3 * *piVar2;
    local_14 = *piVar2;
  } while ((DAT_00105b58 * DAT_00105b5c &amp; 0xdb331b78U) == 0x5971cd31);
  return *piVar2;
}
```

I just thought of it as a black box, perhaps some 'hash function', and postulated that these values are used to calculate the key and iv. Notice that the &quot;One wall down!&quot; branch calls this function with different values compared to the branch that prints &quot;I need a very specific file to be available. Or do I?&quot;. Hence, I just assumed that as long as we reach the branch that prints the correct string, the correct values will be updated which will hopefully result in the correct key and iv later being printed. I applied the same logic to walls 2 and 3.

I tried creating the file at `sys/wall/facer` but it didn't work, even though I was root. So I tried replacing the file path with something I could write to by patching the binary:

```python:patch.py
...
newdata = newdata.replace(b'/sys/wall/facer', b'/data/local/ttt')
...
```

For some reason, this still didn't work even though the file was clearly present. Eventually I just patched the assembly code itself, replacing

```x86asm
mov eax, 0x101
syscall
```

with

```x86asm
mov eax, 0x1
nop
nop
```

So it will be as if the syscall returned a fd of 1.

I updated patch.py:

```python:patch.py
...
# handle file check
j = 0x2277
newdata = newdata[:j] + b'\x01\x00\x00\x00\x90\x90' + newdata[j+6:]
...
```

Running the app with the patched libnative.so successfully prints `One wall down!`. However, there are more errors, more patching to be done. Let's look at the next function:

# Second wall

```c
undefined4 FUN_00101eb0(undefined4 param_1)

{
  undefined4 uVar1;
  uint local_2c;
  undefined8 local_18;
  undefined4 local_10;
  undefined4 local_c;
  
  local_c = param_1;
  local_18 = 0x90ec8148e5894855;
  local_10 = 0x48000000;
  for (local_2c = 0;
      (local_2c < 0xc &amp;&amp;
      (FUN_00103430[(int)local_2c] == *(code *)((long)&amp;local_18 + (long)(int)local_2c)));
      local_2c = local_2c + 1) {
  }
  if (local_2c != 0xc) {
    for (local_2c = 0; local_2c < 0xc; local_2c = local_2c + 1) {
      FUN_00103430[(int)local_2c] = *(code *)((long)&amp;local_18 + (long)(int)local_2c);
    }
  }
  uVar1 = FUN_00103430(0x1,param_1);
  return uVar1;
}
```

There is clearly some dynamic updating of executable code going on in the first part. However, upon inspection I realised it wasn't actually changing anything. Let's look at `FUN_00103430`:

```c
void FUN_00103430(int param_1)

{
  switch(param_1 == 0x539) {
  case false:
    __android_log_print(6,&amp;DAT_00100a2f,&quot;HAHAHA are you sure you\'ve got the right input parameter?&quot;
                       );
                    /* WARNING: Could not recover jumptable at 0x001035a2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105ba8)();
    return;
  case true:
    __android_log_print(4,&amp;DAT_00100a2f,&quot;Input verification success!&quot;);
                    /* WARNING: Could not recover jumptable at 0x0010357a. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105b98)();
    return;
  }
}
```

It's checking that the first parameter is 0x539. However, it is clearly being passed the constant value of 0x1.

There are many ways to patch this, the solution I settled on was replacing 0x539 with 0x1:

```python:patch.py
# handle parameter check
i = 0x2450
newdata = newdata[:i] + b'\x01\x00' + newdata[i+2:]
```

Now we get `Input verification success!`. Let's continue to the third function.

# Third wall

This function is a bit longer. I retyped the function so that the first parameter is correctly typed as `JNIEnv *`. Now the code is much more understandable.

```c
undefined4 FUN_00101f90(JNIEnv *param_1,uint param_2)

{
  _func_259 *p_Var1;
  JNIEnv *env;
  jclass clazz;
  jsize digestLen;
  uint local_bc;
  undefined8 local_a4;
  undefined4 local_9c;
  int i;
  int local_94;
  jbyte *local_90;
  long local_88;
  jbyte *local_80;
  int local_74;
  jbyteArray digest;
  jobject p2bytes;
  jmethodID String_getBytes;
  jobject msgDigestSHA1;
  jstring s_SHA_1;
  jmethodID MessageDigest_digest;
  jmethodID MessageDigest_update;
  jmethodID MessageDigestClass_getInstance;
  jclass MessageDigestClass;
  jstring p2str;
  char local_1f [11];
  uint local_14;
  JNIEnv *local_10;
  
  local_14 = param_2;
  local_10 = param_1;
  sprintf(local_1f,&quot;%d&quot;,(ulong)param_2);
  p2str = (*(*local_10)->NewStringUTF)(local_10,local_1f);
  MessageDigestClass = (*(*local_10)->FindClass)(local_10,&quot;java/security/MessageDigest&quot;);
  MessageDigestClass_getInstance =
       (*(*local_10)->GetStaticMethodID)
                 (local_10,MessageDigestClass,&quot;getInstance&quot;,
                  &quot;(Ljava/lang/String;)Ljava/security/MessageDigest;&quot;);
  MessageDigest_update = (*(*local_10)->GetMethodID)(local_10,MessageDigestClass,&quot;update&quot;,&quot;([B)V&quot;);
  MessageDigest_digest = (*(*local_10)->GetMethodID)(local_10,MessageDigestClass,&quot;digest&quot;,&quot;()[B&quot;);
  s_SHA_1 = (*(*local_10)->NewStringUTF)(local_10,&quot;SHA-1&quot;);
  msgDigestSHA1 =
       (*(*local_10)->CallStaticObjectMethod)
                 (local_10,MessageDigestClass,MessageDigestClass_getInstance,s_SHA_1);
  env = local_10;
  p_Var1 = (*local_10)->GetMethodID;
  clazz = (*(*local_10)->GetObjectClass)(local_10,p2str);
  String_getBytes = (*p_Var1)(env,clazz,&quot;getBytes&quot;,&quot;()[B&quot;);
  p2bytes = (*(*local_10)->CallObjectMethod)(local_10,p2str,String_getBytes);
  (*(*local_10)->CallVoidMethod)(local_10,msgDigestSHA1,MessageDigest_update,p2bytes);
  digest = (*(*local_10)->CallObjectMethod)(local_10,msgDigestSHA1,MessageDigest_digest);
  digestLen = (*(*local_10)->GetArrayLength)(local_10,digest);
  local_74 = (int)digestLen;
  local_80 = (*(*local_10)->GetByteArrayElements)(local_10,digest,(jboolean *)0x0);
  local_88 = (long)local_74;
  local_90 = local_80;
  local_94 = 0;
  for (i = 0; i < 0x14; i = i + 1) {
    local_94 = (uint)(byte)local_80[i] + local_94;
  }
  local_a4 = 0xb0ec8148e5894855;
  local_9c = 0x48000000;
  for (local_bc = 0;
      (local_bc < 0xc &amp;&amp;
      (FUN_001035b0[(int)local_bc] == *(code *)((long)&amp;local_a4 + (long)(int)local_bc)));
      local_bc = local_bc + 1) {
  }
  if (local_bc != 0xc) {
    for (local_bc = 0; local_bc < 0xc; local_bc = local_bc + 1) {
      FUN_001035b0[(int)local_bc] = *(code *)((long)&amp;local_a4 + (long)(int)local_bc);
    }
  }
  local_14 = FUN_001035b0(local_94,local_14);
  (*(*local_10)->ReleaseByteArrayElements)(local_10,digest,local_80,0);
  (*(*local_10)->DeleteLocalRef)(local_10,p2str);
  (*(*local_10)->DeleteLocalRef)(local_10,s_SHA_1);
  (*(*local_10)->DeleteLocalRef)(local_10,p2bytes);
  (*(*local_10)->DeleteLocalRef)(local_10,digest);
  (*(*local_10)->DeleteLocalRef)(local_10,msgDigestSHA1);
  (*(*local_10)->DeleteLocalRef)(local_10,MessageDigestClass);
  return local_14;
}
```

Reversing the java part reveals that it does something like this (translated to python): `local_94 = sum(hashlib.sha1(str(param_2).encode()).digest())`. This value is then passed as the first parameter to `FUN_001035b0`:

```c
void FUN_001035b0(int param_1)

{
  __android_log_print(3,&amp;DAT_00100a2f,&quot;Bet you can\'t fix the correct constant :)&quot;);
  switch(param_1 == 0x539) {
  case false:
    __android_log_print(6,&amp;DAT_00100a2f,
                        &quot;I\'m afraid I\'m going to have to stop you from getting the correct key and  IV.&quot;
                       );
                    /* WARNING: Could not recover jumptable at 0x00103830. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105bc8)();
    return;
  case true:
                    /* WARNING: Could not recover jumptable at 0x001036e2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105bc8)();
    return;
  }
}
```

Here's the relevant disassembly:

```plaintext
   001035bb 48 8d      LEA     RAX,[switchD_0010366e::switchdataD_00105c30]                         = 0010380a
            05 6e 
            26 00 00
   001035c2 48 89      MOV     qword ptr [RBP + local_10],RAX=>switchD_0010366e::switchdataD_00105  = 0010380a
            45 f8

...

   001035e6 8b 45 f0   MOV     EAX,dword ptr [RBP + local_18] // param_1
   001035e9 8b 0d      MOV     ECX,dword ptr [DAT_00100ba8]                                         = 00000539h
            b9 d5 
            ff ff
   001035ef 29 c8      SUB     EAX,ECX
   001035f1 0f 94 c0   SETZ    AL
   001035f4 0f b6 c0   MOVZX   EAX,AL
   001035f7 89 45 f4   MOV     dword ptr [RBP + local_14],EAX
   001035fa 48 8b      MOV     RAX,qword ptr [RBP + local_10]
            45 f8
   001035fe 48 63      MOVSXD  RCX,dword ptr [RBP + local_14]
            4d f4
   00103602 48 8b      MOV     RAX=>switchD_0010366e::switchdataD_00105c30,qword ptr [RAX + RCX*0x8]= 0010380a
            04 c8

...

                    switchD_0010366e::switchD
   0010366e ff e0      JMP     RAX
```

So at the end, it's jumping to the code at `switchD_0010366e::switchdataD_00105c30[param_1 - 0x539]`. We clearly want to avoid the first branch, so let's look at the what the second branch does:

```plaintext
                    switchD_0010366e::caseD_1         XREF[3]: 0010366e(j), 
                                                               00105bb8(*), 
                                                               00105c38(*)  
   001036d6 48 63      MOVSXD  RCX,dword ptr [RBP + local_2c]
            4d dc
   001036da 48 8b      MOV     RAX,qword ptr [RBP + local_28]
            45 e0
   001036de 48 8b      MOV     RAX,qword ptr [RAX + RCX*0x8]=>PTR_LAB_00105bc8                      = 00103779
            04 c8
   001036e2 ff e0      JMP     RAX=>LAB_00103779
```

local_2c and local_28 are constants previously set in the parent function:

```plaintext
   00103606 48 8d      LEA     RCX,[PTR_LAB_00105b60]                                               = 001032b4
            0d 53 
            25 00 00
   0010360d 48 89      MOV     qword ptr [RBP + local_28],RCX=>PTR_LAB_00105b60                     = 001032b4
            4d e0
   00103611 c7 45      MOV     dword ptr [RBP + local_2c],0xd
            dc 0d 
            00 00 00
```

So calculating the expected value, we should end up at jumping to the address at 0x105bc8:

```plaintext
                    PTR_LAB_00105bc8                  XREF[2]: check_constant:001036d
                                                               check_constant:0010382
   00105bc8 79 37      addr    LAB_00103779
            10 00 
            00 00 
   00105bd0 70 36      addr    LAB_00103670
            10 00 
            00 00 
   00105bd8 43 37      addr    LAB_00103743
            10 00 
            00 00 
   00105be0 e4 36      addr    LAB_001036e4 // win function
            10 00 
            00 00 
   00105be8 9b 37      addr    LAB_0010379b
            10 00 
            00 00 
   00105bf0 65 37      addr    LAB_00103765
            10 00 
            00 00 
   00105bf8 fe 37      addr    LAB_001037fe
            10 00 
            00 00 
```

Looking at the code at `LAB_00103779` we see it eventually leads to printing &quot;Not like this...&quot; However, we can also see that `LAB_001036e4` is in the array of pointers, and it prints &quot;I guess it\'s time to reveal the correct key and IV!&quot;. So by setting `param_1` to 0x53a and replacing 0xd with 0x10 we should reach that branch.

However, there is a simpler solution. Looking back at `switchD_0010366e::switchdataD` we see the our desired destination is also in this array of pointers:

```plaintext
                    switchD_0010366e::switchdataD_00  XREF[3]: check_constant:001035b
                                                               check_constant:001035c
                                                               check_constant:0010360
   00105c30 0a 38      addr    switchD_0010366e::caseD_0
            10 00 
            00 00 
   00105c38 d6 36      addr    switchD_0010366e::caseD_1
            10 00 
            00 00 
                    PTR_LAB_00105c40                  XREF[2]: check_constant:0010362
                                                               check_constant:0010362
   00105c40 43 37      addr    LAB_00103743
            10 00 
            00 00 
   00105c48 70 36      addr    LAB_00103670
            10 00 
            00 00 
                    PTR_LAB_00105c50                  XREF[2]: check_constant:0010363
                                                               check_constant:0010364
   00105c50 9b 37      addr    LAB_0010379b
            10 00 
            00 00 
   00105c58 e4 36      addr    LAB_001036e4 // <-- here!
            10 00 
            00 00 
```

So if we set `param_1 = 0x539 + 5`, we should jump to the correct branch immediately!

For this patch, I replaced the following assembly:

```x86asm
sub eax, ecx ; eax = param_1, ecx = 0x539
setz al
movzx eax, al
```

with:

```x86asm
xor eax, eax
add eax, 0x5
nop
nop
nop
```

This was done in the patch.py script (assembly was compiled with pwntools `asm` function):

```python:patch.py
...
# replace eax with the correct value ...
k = 0x25ef
newdata = newdata[:k] + b'1\xc0\x83\xc0\x05\x90\x90\x90' + newdata[k+8:]
...
```

Running the app with the patched libnative.so, there seem to be no errors, and a new key and iv is printed:

![](/ctf-writeups/tisc24/libnative_logs_success.png)

Running Decrypt.java with the updated key and iv, the flag is printed!

`TISC{1_4m_y0ur_w4llbr34k3r_!i#Leb}`

Here is the final patch.py script:

```python:patch.py
from Crypto.Util.number import long_to_bytes as ltb
import lief

with open('libnative.so', 'rb') as f:
    data = f.read()
newdata = data[:]

# handle file check
j = 0x2277
newdata = newdata[:j] + b'\x01\x00\x00\x00\x90\x90' + newdata[j+6:]

# handle parameter check
i = 0x2450
newdata = newdata[:i] + b'\x01\x00' + newdata[i+2:]

# replace eax with the correct value ...
k = 0x25ef
newdata = newdata[:k] + b'1\xc0\x83\xc0\x05\x90\x90\x90' + newdata[k+8:]

with open('libnative1.so', 'wb') as f:
    f.write(newdata)

lib = lief.parse('libnative1.so')
for x in lib.exported_symbols:
    if x.name == 'Java_DynamicClass_nativeMethod':
        x.name = 'Java_com_a_a_Test_nativeMethod'
lib.write('libnative1.so')
```

# More debugging notes

While patching libnative.so, there were many times I needed to see what was actually going on in memory. I wasn't able to attach gdb or setup any other debugger, however I found the following approach sufficient:

I would replace a certain instruction with the `\xcc` opcode, as follows:

```python:patch.py
...
# for debugging
k = 0x2830
newdata = newdata[:k] + b'\xcc' + newdata[k+1:]
...
```

When android reaches this instruction, the app would crash a memory dump would be printed to LogCat:

![](/ctf-writeups/tisc24/libnative_logs_memdump.png)

Thus, I was able to inspect the values of each register, which for this challenge was sufficient to debug effectively."><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><button class="group w-10 h-10 rounded-full grid place-items-center"><i class="material-symbols-outlined text-2xl transition-colors group-hover:text-primary">search</i></button><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a aria-current="page" href="/ctf-writeups/wallfacer" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-8"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a aria-current="page" href="/ctf-writeups/wallfacer" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-xl opacity-60 mb-1"></span><h1 class="mb-7">Wallfacer</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>Breaking news! We've managed to seize an app from their device.</p>
<p>It seems to be an app that stores user data, but doesn't seem to do much other than that... The other agent who recovered this said he heard them say something about parts of the app are only loaded during runtime, hiding crucial details.</p>
<p>It's up to you now! Can you break through the walls and unveil the hidden secrets within this app?</p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">keyboard_double_arrow_left</i><span class="mr-4 text-black font-semibold">rev</span></div><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">phone_android</i><span class="mr-4 text-black font-semibold">mobile</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">33 solves</span><span class="opacity-60">0 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by unknown</span></div></div><div class="w-full flex border border-almost-black-lighter rounded-2.5xl mt-7 mb-9 max-sm:flex-col"><div class="flex-1 flex flex-col gap-y-2 px-6 pt-4 pb-5"><span>Attachments</span><!--[--><a href="https://api.tisc24.csit-events.sg/file?id=cm0y2fvoj39f30854r5m17r1q&amp;name=wallfacer-x86_64.apk&amp;req=clzv2z8zr0c5q0854jk6g5acs&amp;reqHash=f316095a237261216e1674a9501c74d2129ef2734263c6cedbc04ddcc4edc5049442a55e83eef141e093af331a2db2e0bc2d8f0cea3803ec5104932fb45f6856&amp;reqExp=1727782114" class="underline">wallfacer-x86_64.apk</a><!--]--></div><button class="pl-9 pr-10 font-semibold flex items-center border-l border-almost-black-lighter rounded-tr-2.5xl rounded-br-2.5xl transition-colors hover:bg-almost-black active:bg-almost-black-lighter max-sm:border-l-0 max-sm:border-t max-sm:pl-6 max-sm:py-4 max-sm:rounded-tr-none max-sm:rounded-bl-2.5xl"><i class="material-symbols-outlined text-2xl mr-4">download</i> Download all </button></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p>Installing the apk reveals very little:</p>
<p><img src="/ctf-writeups/tisc24/wallfacer_home.jpg" alt=""></p>
<h1 id="java-decompilation" tabindex="-1">Java decompilation</h1>
<p>I used jadx to decompile the apk: <code>jadx wallfacer-x86_64.apk</code>. We can see a number of decompiled java files under <code>sources/com/wall/facer</code>:</p>
<p><img src="/ctf-writeups/tisc24/wallfacer_java_files.png" alt=""></p>
<p>Storage is a simple class implementing the singleton pattern, with a secretMessage property:</p>
<pre class="named-fence-block"><code class="language-java">package com.wall.facer;
/* loaded from: classes.dex */
public class Storage {
    private static Storage instance;
    private String secretMessage;

    private Storage() {
    }

    public static synchronized Storage getInstance() {
        Storage storage;
        synchronized (Storage.class) {
            try {
                if (instance == null) {
                    instance = new Storage();
                }
                storage = instance;
            } catch (Throwable th) {
                throw th;
            }
        }
        return storage;
    }

    public synchronized String getMessage() {
        return this.secretMessage;
    }

    public synchronized void saveMessage(String str) {
        this.secretMessage = str;
    }
}
</code><div class="named-fence-filename">Storage.java</div></pre>
<p>MainActivity.java is the controller for the above home page. Its implementation is also very barebones:</p>
<pre class="named-fence-block"><code class="language-java">package com.wall.facer;

import android.os.Bundle;
import android.view.View;
import android.widget.EditText;
/* loaded from: classes.dex */
public class MainActivity extends C0 {
    public EditText y;

    @Override // defpackage.C0, defpackage.O3, android.app.Activity
    public final void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_main);
        this.y = (EditText) findViewById(R.id.edit_text);
    }

    public void onSubmitClicked(View view) {
        Storage.getInstance().saveMessage(this.y.getText().toString());
    }
}
</code><div class="named-fence-filename">MainActivity.java</div></pre>
<p>There is another activity class, query:</p>
<pre class="named-fence-block"><code class="language-java">package com.wall.facer;

import android.content.Context;
import android.os.Bundle;
import android.util.Base64;
import android.util.Log;
import android.view.View;
import android.widget.EditText;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;
/* loaded from: classes.dex */
public class query extends C0 {
    public EditText y;
    public EditText z;

    @Override // defpackage.C0, defpackage.O3, android.app.Activity
    public final void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_query);
        this.y = (EditText) findViewById(R.id.key_text);
        this.z = (EditText) findViewById(R.id.iv_text);
    }

    public void onSubmitClicked(View view) {
        Context applicationContext = getApplicationContext();
        String obj = this.y.getText().toString();
        String obj2 = this.z.getText().toString();
        try {
            byte[] decode = Base64.decode(applicationContext.getString(R.string.str), 0);
            byte[] bytes = obj.getBytes();
            byte[] bytes2 = obj2.getBytes();
            Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
            cipher.init(2, new SecretKeySpec(bytes, "AES"), new IvParameterSpec(bytes2));
            Log.d(getString(R.string.tag), "Decrypted data: ".concat(new String(cipher.doFinal(decode))));
        } catch (Exception unused) {
            Log.e(getString(R.string.tag), "Failed to decrypt data");
        }
    }
}
</code><div class="named-fence-filename">query.java</div></pre>
<p>It seems to be a page where string decryption is going on, however we have to provide the key and iv. The value of <code>R.string.str</code> can be found under <code>resources/res/values/strings.xml</code>:</p>
<pre class="named-fence-block"><code class="language-xml">...
    &lt;string name="str"&gt;4tYKEbM6WqQcItBx0GMJvssyGHpVTJMhpjxHVLEZLVK6cmIH7jAmI/nwEJ1gUDo2&lt;/string&gt;
...
</code><div class="named-fence-filename">strings.xml</div></pre>
<p>Looking around the file, I found a few other interesting strings:</p>
<pre class="named-fence-block"><code class="language-xml">...
    &lt;string name="base"&gt;d2FsbG93aW5wYWlu&lt;/string&gt;
...
    &lt;string name="dir"&gt;ZGF0YS8&lt;/string&gt;
...
    &lt;string name="filename"&gt;c3FsaXRlLmRi&lt;/string&gt;
...
</code><div class="named-fence-filename">strings.xml</div></pre>
<p>They seem to also be base64-encoded. Decoding them gives base = <code>wallowinpain</code>, dir = <code>data/</code>, filename = <code>sqlite.db</code>.</p>
<p>Under <code>resources/assets</code>, I noticed a <code>sqlite.db</code> file. However, attempts to open it were met with the error: <code>file is not a database</code>. I tried various methods to patch the file unsuccessfully. Furthermore, a strings check on the file does not return any readable text except for the sqlite header.</p>
<blockquote>
<p><strong>Stuff that didn't work</strong></p>
<p>At this point, I went down a few different rabbit holes. Following the hint in the challenge description that <em>something</em> was being loaded at runtime, I rooted my android emulator (took way longer than I would like to admit) and used <a href="https://github.com/Nightbringer21/fridump">Fridump</a> to dump the app memory. I thought that perhaps the sqlite file was being decrypted at runtime, so the decrypted file would be in the memory dump. This proved to be false.</p>
</blockquote>
<p>Eventually, I returned to the three mysterious strings and tried to figure out where they were being used. We can find the string ids in <code>R.java</code></p>
<pre class="named-fence-block"><code class="language-java">...
        public static final int base = 0x7f0f001e;
...
        public static final int dir = 0x7f0f0030;
...
        public static final int filename = 0x7f0f0038;
...
</code><div class="named-fence-filename">R.java</div></pre>
<p>Running a global search for the string ids (both hex and decimal format) yielded nothing. Maybe they are referenced in binary files? I searched for this using: <code>grep -aRP '8\x00\x0f\x7f' .</code>. Sure enough, a match was returned for <code>filename</code>'s id inside <code>resoucers/classes.dex</code>. I postulated that the java decompilation was missing something, so I looked in the smali decompilation (smali is basically a human readable representation of Dalvik bytecode, so decompiling to smali is lossless).</p>
<p>Using <code>apktool d wallfacer-x86_64.apk</code>, we can access the smali files. Searching for <code>0x7f0f0038</code> shows that is being used in <code>K0.smali</code>.</p>
<h1 id="extracting-dynamicclass" tabindex="-1">Extracting DynamicClass</h1>
<p>We reverse it section by section:</p>
<pre class="named-fence-block"><code class="language-plaintext">    const v0, 0x7f0f0038

    :try_start_0
    invoke-virtual {p0, v0}, Landroid/content/Context;-&gt;getString(I)Ljava/lang/String;

    move-result-object v0
</code><div class="named-fence-filename">K0.smali</div></pre>
<p>Fortunately, the smali decompilation is verbose enough that we can kind of figure out what's going on. For parts that I didn't understand, I consulted ChatGPT or Google. The above section does something like <code>v0 = context.getString(0x7f0f0038)</code>.</p>
<pre class="named-fence-block"><code class="language-plaintext">    new-instance v1, Ljava/lang/String;

    const/4 v2, 0x0

    invoke-static {v0, v2}, Landroid/util/Base64;-&gt;decode(Ljava/lang/String;I)[B

    move-result-object v0

    invoke-direct {v1, v0}, Ljava/lang/String;-&gt;&lt;init&gt;([B)V

    invoke-static {p0, v1}, LA8;-&gt;K(Landroid/content/Context;Ljava/lang/String;)Ljava/nio/ByteBuffer;

    move-result-object v0
</code><div class="named-fence-filename">K0.smali</div></pre>
<p>Now this does <code>v0 = A8.K(context, new String(Base64.decode(v0, 0)))</code>. We will investigate the <code>A8.K</code> function later.</p>
<pre class="named-fence-block"><code class="language-plaintext">    new-instance v1, Ldalvik/system/InMemoryDexClassLoader;

    invoke-virtual {p0}, Landroid/content/Context;-&gt;getClassLoader()Ljava/lang/ClassLoader;

    move-result-object v2

    invoke-direct {v1, v0, v2}, Ldalvik/system/InMemoryDexClassLoader;-&gt;&lt;init&gt;(Ljava/nio/ByteBuffer;Ljava/lang/ClassLoader;)V
</code><div class="named-fence-filename">K0.smali</div></pre>
<p><code>v1 = new InMemoryDexClassLoader(v0, context.getClassLoader())</code></p>
<pre class="named-fence-block"><code class="language-plaintext">    const-string v0, "DynamicClass"

    invoke-virtual {v1, v0}, Ljava/lang/ClassLoader;-&gt;loadClass(Ljava/lang/String;)Ljava/lang/Class;

    move-result-object v0
</code><div class="named-fence-filename">K0.smali</div></pre>
<p><code>v0 = v1.loadClass("DynamicClass")</code></p>
<pre class="named-fence-block"><code class="language-plaintext">    const-class v1, Landroid/content/Context;

    filled-new-array {v1}, [Ljava/lang/Class;

    move-result-object v1

    const-string v2, "dynamicMethod"

    invoke-virtual {v0, v2, v1}, Ljava/lang/Class;-&gt;getMethod(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;

    move-result-object v0
</code><div class="named-fence-filename">K0.smali</div></pre>
<p><code>v0.getMethod("dynamicMethod", new java.lang.Class[] { android.content.Context })</code></p>
<p>So it seems that <code>A8.K</code> is loading bytecode used to construct DynamicClass, and the method dynamicMethod is then invoked on it.</p>
<p>Fortunately for us, the <code>A8</code> class seems to be correctly decompiled to java and we can find it under <code>sources/defpackage</code> (in the jadx decompilation).</p>
<pre class="named-fence-block"><code class="language-java">    public static ByteBuffer K(Context context, String str) {
        int i2;
        InputStream open = context.getAssets().open(str);
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] bArr = new byte[1024];
        while (true) {
            int read = open.read(bArr);
            if (read == -1) {
                break;
            }
            byteArrayOutputStream.write(bArr, 0, read);
        }
        open.close();
        byte[] byteArray = byteArrayOutputStream.toByteArray();
        // here, contents of assets/sqlite.db have been read to byteArray
        byte[] bArr2 = new byte[128];
        byte[] bArr3 = new byte[4];
        System.arraycopy(byteArray, 4096, bArr3, 0, 4);
        int i3 = ByteBuffer.wrap(bArr3).getInt();
        byte[] bArr4 = new byte[i3];
        System.arraycopy(byteArray, 4100, bArr4, 0, i3);
        System.arraycopy(byteArray, 4100 + i3, bArr2, 0, 128);
        C0289q1 c0289q1 = new C0289q1(bArr2);
        byte[] bArr5 = new byte[i3];
        int i4 = 0;
        int i5 = 0;
        for (i2 = 0; i2 &lt; i3; i2++) {
            i4 = (i4 + 1) &amp; 255;
            byte[] bArr6 = (byte[]) c0289q1.c;
            byte b2 = bArr6[i4];
            i5 = (i5 + (b2 &amp; 255)) &amp; 255;
            bArr6[i4] = bArr6[i5];
            bArr6[i5] = b2;
            bArr5[i2] = (byte) (bArr6[(bArr6[i4] + b2) &amp; 255] ^ bArr4[i2]);
        }
        return ByteBuffer.wrap(bArr5);
    }
</code><div class="named-fence-filename">A8.java</div></pre>
<p>Here, the contents of <code>sqlite.db</code> are read to <code>byteArray</code>, and some copying is done. The signature of <code>System.arraycopy</code> is  <code>arraycopy(Object src, int srcPos, Object dest, int destPos, int length)</code>. The first 4 bytes read to bArr3 seem to be a length specifier, and the specified number of bytes is then read into bArr4, then the next 128 bytes are read to bArr2. Then the <code>C0289q1</code> class is created. I looked up the implementation:</p>
<pre class="named-fence-block"><code class="language-java">    public C0289q1(byte[] bArr) {
        this.a = 17;
        this.b = bArr;
        this.c = new byte[256];
        for (int i = 0; i &lt; 256; i++) {
            ((byte[]) this.c)[i] = (byte) i;
        }
        int i2 = 0;
        for (int i3 = 0; i3 &lt; 256; i3++) {
            byte[] bArr2 = (byte[]) this.c;
            byte b = bArr2[i3];
            byte[] bArr3 = (byte[]) this.b;
            i2 = (i2 + (b &amp; 255) + (bArr3[i3 % bArr3.length] &amp; 255)) &amp; 255;
            bArr2[i3] = bArr2[i2];
            bArr2[i2] = b;
        }
    }
</code><div class="named-fence-filename">C0289q1.java</div></pre>
<p>I can't remember whether I reversed the function logic, but either way it is not necessary to figure out exactly what is going on, since the function is just moving values around. All we need for decryption is the sqlite.db file, and to translate the algorithm to python:</p>
<pre class="named-fence-block"><code class="language-python">with open('sqlite.db', 'rb') as f:
    data = f.read()
    chunksize = int.from_bytes(data[4096:4100], 'big')
    chunk = data[4100: 4100+chunksize]
    keything = data[4100+chunksize: 4100+chunksize+128]

    # calculate c0289q1.c
    c = [i for i in range(256)]
    acc = 0
    for i in range(256):
        temp = c[i]
        acc = (acc + temp + keything[i % 128]) &amp; 255
        c[i] = c[acc]
        c[acc] = temp
    print(c)

    bArr5 = [0 for _ in range(chunksize)]
    i4 = 0
    i5 = 0
    for i in range(chunksize):
        i4 = (i4 + 1) &amp; 255
        b2 = c[i4]
        i5 = (i5 + (b2 &amp; 255)) &amp; 255
        c[i4] = c[i5]
        c[i5] = b2
        bArr5[i] = (c[(c[i4] + b2) &amp; 255] ^ chunk[i])

with open('output.dex', 'wb') as f:
    f.write(bytes(bArr5))
</code><div class="named-fence-filename">h.py</div></pre>
<h1 id="extracting-libnative.so" tabindex="-1">Extracting libnative.so</h1>
<p>The resulting .dex file can be decompiled with <code>jadx output.dex</code>. Then we have the decompiled class under <code>output/sources/defpackage</code> (I added some comments):</p>
<pre class="named-fence-block"><code class="language-java">package defpackage;

import android.content.Context;
import android.content.res.AssetManager;
import android.content.res.Resources;
import android.os.SystemClock;
import android.util.Base64;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.Comparator;
/* renamed from: DynamicClass  reason: default package */
/* loaded from: /home/smalldonkey/ctf/tisc24/l8/l8/wallfacer-x86_64/resources/assets/output.dex */
public class DynamicClass {
    static final /* synthetic */ boolean $assertionsDisabled = false;
    private static final String TAG = "TISC";

    public static native void nativeMethod();

    public static void dynamicMethod(Context context) throws Exception {
        pollForTombMessage();
        Log.i(TAG, "Tomb message received!");
        File generateNativeLibrary = generateNativeLibrary(context);
        try {
            System.load(generateNativeLibrary.getAbsolutePath());
        } catch (Throwable th) {
            String message = th.getMessage();
            message.getClass();
            Log.e(TAG, message);
            System.exit(-1);
        }
        Log.i(TAG, "Native library loaded!");
        if (generateNativeLibrary.exists()) {
            generateNativeLibrary.delete();
        }
        pollForAdvanceMessage();
        Log.i(TAG, "Advance message received!");
        nativeMethod();
    }

    private static void pollForTombMessage() throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Class&lt;?&gt; cls;
        do {
            SystemClock.sleep(1000L);
            cls = Class.forName("com.wall.facer.Storage");
        } while (!DynamicClass$$ExternalSyntheticBackport1.m((String) cls.getMethod("getMessage", new Class[0]).invoke(cls.getMethod("getInstance", new Class[0]).invoke(null, new Object[0]), new Object[0]), "I am a tomb")); // Storage.getInstance().getMessage() == "I am a tomb"
    }

    private static void pollForAdvanceMessage() throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        Class&lt;?&gt; cls;
        do {
            SystemClock.sleep(1000L);
            cls = Class.forName("com.wall.facer.Storage");
        } while (!DynamicClass$$ExternalSyntheticBackport1.m((String) cls.getMethod("getMessage", new Class[0]).invoke(cls.getMethod("getInstance", new Class[0]).invoke(null, new Object[0]), new Object[0]), "Only Advance")); // Storage.getInstance().getMessage() == "Only Advance"
    }

    public static File generateNativeLibrary(Context context) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {
        AssetManager assets = context.getAssets();
        Resources resources = context.getResources();
        String str = new String(Base64.decode(resources.getString(resources.getIdentifier("dir", "string", context.getPackageName())) + "=", 0));
        // str = "data/"
        String[] list = assets.list(str);
        // sort files alphabetically
        Arrays.sort(list, new Comparator() { // from class: DynamicClass$$ExternalSyntheticLambda3
            @Override // java.util.Comparator
            public final int compare(Object obj, Object obj2) {
                int m;
                m = DynamicClass$$ExternalSyntheticBackport0.m(Integer.parseInt(((String) obj).split("\\$")[0]), Integer.parseInt(((String) obj2).split("\\$")[0]));
                return m;
            }
        });
        String str2 = new String(Base64.decode(resources.getString(resources.getIdentifier("base", "string", context.getPackageName())), 0));
        // str2 = "wallowinpain"
        File file = new File(context.getFilesDir(), "libnative.so");
        Method method = Class.forName("Oa").getMethod("a", byte[].class, String.class, byte[].class);
        FileOutputStream fileOutputStream = new FileOutputStream(file);
        try {
            for (String str3 : list) {
                InputStream open = assets.open(str + str3);
                byte[] readAllBytes = open.readAllBytes();
                open.close();
                fileOutputStream.write((byte[]) method.invoke(null, readAllBytes, str2, Base64.decode(str3.split("\\$")[1] + "==", 8)));
            }
            fileOutputStream.close();
            return file;
        } catch (Throwable th) {
            try {
                fileOutputStream.close();
            } catch (Throwable th2) {
                Throwable.class.getDeclaredMethod("addSuppressed", Throwable.class).invoke(th, th2);
            }
            throw th;
        }
    }
}
</code><div class="named-fence-filename">DynamicClass.java</div></pre>
<p><code>dynamicMethod</code> waits for the "I am a tomb" message, then loads a native library. This native library is dynamically loaded in <code>generateNativeLibrary</code>.</p>
<p>Reading the decompilation, <code>generateNativeLibrary</code> is reading the files under <code>assets/data</code>, decrypting them, then combining the result to form the final native library. Let's take a look at the decryption function, <code>Oa.a</code>:</p>
<pre class="named-fence-block"><code class="language-java">package defpackage;

import javax.crypto.Cipher;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;
/* renamed from: Oa  reason: default package */
/* loaded from: classes.dex */
public class Oa {
    public static byte[] a(byte[] bArr, String str, byte[] bArr2) {
        byte[] b = b(str, bArr2);
        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        byte[] bArr3 = new byte[12];
        int length = bArr.length - 12;
        byte[] bArr4 = new byte[length];
        System.arraycopy(bArr, 0, bArr3, 0, 12);
        System.arraycopy(bArr, 12, bArr4, 0, length);
        cipher.init(2, new SecretKeySpec(b, "AES"), new GCMParameterSpec(128, bArr3));
        return cipher.doFinal(bArr4);
    }

    private static byte[] b(String str, byte[] bArr) {
        return SecretKeyFactory.getInstance("PBKDF2WithHmacSHA256").generateSecret(new PBEKeySpec(str.toCharArray(), bArr, 16384, 256)).getEncoded();
    }
}
</code><div class="named-fence-filename">Oa.java</div></pre>
<p>So the function <code>a</code> is doing AES GCM decryption. I compiled the necessary parts together to form the following java script:</p>
<pre class="named-fence-block"><code class="language-java">import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Base64;
import java.util.Arrays;
import java.util.Comparator;
import javax.crypto.Cipher;
import javax.crypto.SecretKeyFactory;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.PBEKeySpec;
import javax.crypto.spec.SecretKeySpec;
import java.io.FileOutputStream;

public class h2 {
    public static byte[] a(byte[] bArr, String str, byte[] bArr2) throws Throwable {
        byte[] b = b(str, bArr2);
        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        byte[] bArr3 = new byte[12];
        int length = bArr.length - 12;
        byte[] bArr4 = new byte[length];
        System.arraycopy(bArr, 0, bArr3, 0, 12);
        System.arraycopy(bArr, 12, bArr4, 0, length);
        cipher.init(2, new SecretKeySpec(b, "AES"), new GCMParameterSpec(128, bArr3));
        return cipher.doFinal(bArr4);
    }

    private static byte[] b(String str, byte[] bArr) throws Throwable {
        return SecretKeyFactory.getInstance("PBKDF2WithHmacSHA256").generateSecret(new PBEKeySpec(str.toCharArray(), bArr, 16384, 256)).getEncoded();
    }

    public static void main(String[] args) {
      try {
      File folder = new File("data/");
        File outFile = new File("libnative.so");
        FileOutputStream fileOutputStream = new FileOutputStream(outFile);

        // Check if the folder exists and is indeed a directory
        if (!folder.exists() || !folder.isDirectory()) {
            System.out.println("Invalid folder path.");
            return;
        }

        // List all files in the directory
        File[] files = folder.listFiles();
        Arrays.sort(files, new Comparator&lt;File&gt;() {
            @Override
            public int compare(File o1, File o2) {
                int n1 = Integer.parseInt(o1.getName().split("\\$")[0]);
                int n2 = Integer.parseInt(o2.getName().split("\\$")[0]);
                return n1 - n2;
            }
        });
        if (files != null) {
            for (File file : files) {
                if (file.isFile()) { // Only process files (not directories)
                System.out.println("reading file: " + file.getName());
                    try (FileInputStream fis = new FileInputStream(file)) {
                        // Read file into byte array
                        byte[] fileBytes = new byte[(int) file.length()];
                        fis.read(fileBytes);
                        
                        // Call the function with filename and file bytes
                        byte[] result = a(fileBytes, "wallowinpain", Base64.getDecoder().decode(file.getName().split("\\$")[1].replace('-', '+').replace('_', '/') + "=="));
                        fileOutputStream.write(result);
                    } catch (IOException e) {
                        System.out.println("Error reading file: " + file.getName());
                        e.printStackTrace();
                    }
                }
            }
            fileOutputStream.close();
        } else {
            System.out.println("No files found in the folder.");
        }
    } catch (Throwable th) {
      System.out.println("An error occurred: " + th);
    }
    }
}
</code><div class="named-fence-filename">h2.java</div></pre>
<p>I placed this file in <code>resources/assets</code>. Compile with <code>javac h2.java</code> and run it with <code>java h2.java</code>, and libnative.so pops out.</p>
<h1 id="loading-libnative.so" tabindex="-1">Loading libnative.so</h1>
<p>To do testing with this library I created a new project in Android Studio. Then I created a <code>jniLibs</code> folder under <code>app/src/main</code>, a subfolder <code>x86_64</code> under that, and copied libnative.so there. To load the library, I created the following java class:</p>
<pre class="named-fence-block"><code class="language-java">package com.example.myapplication;

public class DynamicClass {
    static {
        System.loadLibrary("native");
    }

    public static native void nativeMethod();
}
</code><div class="named-fence-filename">DynamicClass.java</div></pre>
<p>I called nativeMethod when the main activity starts:</p>
<pre class="named-fence-block"><code class="language-kotlin">...
    
    override fun onStart() {
        super.onStart()
        DynamicClass.nativeMethod()
    }

...
</code><div class="named-fence-filename">MainActivity.kt</div></pre>
<p>Now running the app, we can open up the LogCat window and filter by "TISC":</p>
<p><img src="/ctf-writeups/tisc24/libnative_logs_linkerr.png" alt=""></p>
<p>Unfortunately, get the error above: <code>java.lang.UnsatisfiedLinkError: No implementation found for void com.example.myapplication.DynamicClass.nativeMethod() (tried Java_com_example_myapplication_DynamicClass_nativeMethod and Java_com_example_myapplication_DynamicClass_nativeMethod__)</code>. So android requires a specific function name to resolve the native function, in the format <code>Java_&lt;package&gt;_&lt;class_name&gt;_&lt;method_name&gt;</code>.</p>
<p>Because it's a dynamically loaded java class, the package field is omitted, so the function in libnative.so is just called <code>Java_DynamicClass_nativeMethod</code>. But how do we get android to omit the package name when it searches for the function?</p>
<p>My solution was to rename the symbol in libnative.so to <code>Java_com_a_a_Test_nativeMethod</code>. This is the same length as the original function name so no problems should occur. I created a new android project with the package name <code>com.a.a</code>, and the java class named <code>Test</code>. Everything else remained the same. Here is the python script used to patch it:</p>
<pre class="named-fence-block"><code class="language-python">import lief

with open('libnative.so', 'rb') as f:
    data = f.read()

newdata = data[:]

# NOTE: the following doesnt work, i have no idea why...
# newdata = newdata.replace(b'Java_DynamicClass_nativeMethod', b'Java_com_a_a_Test_nativeMethod')

with open('libnative1.so', 'wb') as f:
    f.write(newdata)

# instead i have to use lief to change method name:
lib = lief.parse('libnative1.so')
for x in lib.exported_symbols:
    if x.name == 'Java_DynamicClass_nativeMethod':
        x.name = 'Java_com_a_a_Test_nativeMethod'
lib.write('libnative1.so')
lib.write('/home/smalldonkey/dev/android/A/app/src/main/jniLibs/x86_64/libnative1.so')  # for convenience
</code><div class="named-fence-filename">patch.py</div></pre>
<p>In Test.java I changed <code>System.loadLibrary("native")</code> to <code>System.loadLibrary("native1")</code>. Running the app again, we see more logs, showing that the function was invoked successfully:</p>
<p><img src="/ctf-writeups/tisc24/libnative_logs_fail.png" alt=""></p>
<p>Recalling the query.java activity earlier, I tried using the printed key and iv to decrypt the string:</p>
<pre class="named-fence-block"><code class="language-java">import java.util.Base64;
import java.util.Arrays;
import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

class Decrypt {
    public static void main(String[] args) {
        try {
            byte[] decode = Base64.getDecoder().decode("4tYKEbM6WqQcItBx0GMJvssyGHpVTJMhpjxHVLEZLVK6cmIH7jAmI/nwEJ1gUDo2");
            byte[] bytes = "z?&lt;NKKf7m?MUg&amp;&gt;qBp\"b9G$A!bzP&amp;0I(".getBytes();
            System.out.println(bytes.length);
            byte[] bytes2 = "apI3`ipq.?3d!t#6".getBytes();
            System.out.println(bytes2.length);
            Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
            cipher.init(2, new SecretKeySpec(bytes, "AES"), new IvParameterSpec(bytes2));
            System.out.println("Decrypted data: ".concat(new String(cipher.doFinal(decode))));
        } catch (Exception unused) {
            System.out.println("Failed to decrypt data");
            System.out.println(unused);
        }
    }
}
</code><div class="named-fence-filename">Decrypt.java</div></pre>
<p>Unfortunately, this didn't work. Seems like we have to do more reversing to figure out how to get the correct key and iv.</p>
<h1 id="reversing-libnative.so" tabindex="-1">Reversing libnative.so</h1>
<p>After importing libnative.so into ghidra, we can see the nativeMethod hook:</p>
<pre><code class="language-c">void Java_DynamicClass_nativeMethod(undefined8 param_1)

{
  undefined4 uVar1;
  
  __android_log_print(3,&amp;DAT_00100a2f,
                      "There are walls ahead that you\'ll need to face. They have been specially designed to always result in an error. One false move and you won\'t be able to get the desired result. Are you able to patch your way out of this mess?"
                     );
  uVar1 = FUN_00103230();
  uVar1 = FUN_00101eb0(uVar1);
  uVar1 = FUN_00101f90(param_1,uVar1);
  FUN_001023f0(param_1,uVar1);
  return;
}
</code></pre>
<p>Referring to <a href="https://developer.android.com/ndk/samples/sample_hellojni#ci">this example</a> from the android docs, we can see actual function signature:</p>
<pre><code class="language-c">JNIEXPORT jstring JNICALL
Java_com_example_hellojni_HelloJni_stringFromJNI( JNIEnv* env,
                                                  jobject thiz )
</code></pre>
<p>I found <a href="https://github.com/extremecoders-re/ghidra-jni">this github repo</a> containing the definitions for the JNI objects, which should greatly aid our decompilation. I imported it into ghidra following the instructions in the README.</p>
<p>I then updated the function signature (right click function name, edit function signature):</p>
<pre><code class="language-c">void Java_com_a_a_Test_nativeMethod(JNIEnv *param_1)

{
  undefined4 uVar1;
  uint uVar2;
  
  __android_log_print(3,&amp;DAT_00100a2f,
                      "There are walls ahead that you\'ll need to face. They have been specially des igned to always result in an error. One false move and you won\'t be able to g et the desired result. Are you able to patch your way out of this mess?"
                     );
  uVar1 = FUN_00103230();
  uVar2 = FUN_00101eb0(uVar1);
  uVar2 = FUN_00101f90(param_1,uVar2);
  FUN_001023f0(param_1,uVar2);
  return;
}
</code></pre>
<p>This will be more useful for the third function call, <code>FUN_00101f90</code>, later on. For now, let's look at the first function <code>FUN_00103230</code>:</p>
<h1 id="first-wall" tabindex="-1">First wall</h1>
<pre><code class="language-c">void FUN_00103230(void)

{
  syscall();
                    /* WARNING: Could not recover jumptable at 0x001032b2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
  (*(code *)PTR_LAB_00105c00)(0xffffff9c,s_/sys/wall/facer_00105ab0,0);
  return;
}
</code></pre>
<p>Looks some something went wrong in the decompilation. Looking at the disassembly, we can see what is actually going on.</p>
<pre><code class="language-plaintext">   00103230 55         PUSH    RBP
   00103231 48 89 e5   MOV     RBP,RSP
   00103234 48 83      SUB     RSP,0x50
            ec 50
   00103238 48 8d      LEA     RAX,[PTR_LAB_00105c00]                           = 00103316
            05 c1 
            29 00 00
   0010323f 48 89      MOV     qword ptr [RBP + local_10],RAX=&gt;PTR_LAB_00105c00 = 00103316
            45 f8
   00103243 c7 45      MOV     dword ptr [RBP + local_18],0x1
            f0 01 
            00 00 00
   0010324a c7 45      MOV     dword ptr [RBP + local_1c],0xffffff9c
            ec 9c 
            ff ff ff
   00103251 c7 45      MOV     dword ptr [RBP + local_20],0x0
            e8 00 
            00 00 00
   00103258 c7 45      MOV     dword ptr [RBP + local_24],0x0
            e4 00 
            00 00 00
   0010325f 8b 45 e4   MOV     EAX,dword ptr [RBP + local_24]
   00103262 89 45 dc   MOV     dword ptr [RBP + local_2c],EAX
   00103265 8b 7d ec   MOV     EDI,dword ptr [RBP + local_1c]
   00103268 8b 55 e8   MOV     EDX,dword ptr [RBP + local_20]
   0010326b 44 8b      MOV     R10D,dword ptr [RBP + local_2c]
            55 dc
   0010326f 48 8d      LEA     RSI,[s_/sys/wall/facer_00105ab0]                 = "/sys/wall/facer"
            35 3a 
            28 00 00
   00103276 b8 01      MOV     EAX,0x101
            01 00 00
   0010327b 0f 05      SYSCALL
   0010327d 89 45 e0   MOV     dword ptr [RBP + local_28],EAX
   00103280 8b 45 e0   MOV     EAX,dword ptr [RBP + local_28]
   00103283 c1 e8 1f   SHR     EAX,0x1f
   00103286 89 45 f4   MOV     dword ptr [RBP + local_14],EAX
   00103289 48 8b      MOV     RAX,qword ptr [RBP + local_10]
            45 f8
   0010328d 48 63      MOVSXD  RCX,dword ptr [RBP + local_14]
            4d f4
   00103291 48 8b      MOV     RAX=&gt;PTR_LAB_00105c00,qword ptr [RAX + RCX*0x8]  = 00103316
            04 c8
   00103295 48 8d      LEA     RCX,[PTR_LAB_00105b60]                           = 001032b4
            0d c4 
            28 00 00
   0010329c 48 89      MOV     qword ptr [RBP + local_38],RCX=&gt;PTR_LAB_00105b60 = 001032b4
            4d d0
   001032a0 c7 45      MOV     dword ptr [RBP + local_3c],0x2
            cc 02 
            00 00 00
   001032a7 48 89      MOV     qword ptr [RBP + local_48],RCX=&gt;PTR_LAB_00105b60 = 001032b4
            4d c0
   001032ab c7 45      MOV     dword ptr [RBP + local_4c],0x2
            bc 02 
            00 00 00
   001032b2 ff e0      JMP     RAX
</code></pre>
<p>So it's performing a syscall with rax = 0x101. Consulting <a href="https://x64.syscall.sh/">https://x64.syscall.sh/</a> shows that is an <code>openat</code> call. dfd = 0xffffff9c and filename = "/sys/wall/facer". The output (in rax) is then shifted right by 31 bits and stored in rcx. Then we have <code>MOV     RAX=&gt;PTR_LAB_00105c00,qword ptr [RAX + RCX*0x8]</code>. At the end, there is a <code>jmp rax</code> instruction.</p>
<p>The output of the <code>openat</code> syscall will return a file descriptor or a negative number if an error has occured (if the file does not exist, for example). The SHR instruction is basically checking whether the output is negative, and based on that, take either one of two paths under <code>PTR_LAB_00105c00</code>.</p>
<p>Viewing the <code>PTR_LAB_00105c00</code> symbol shows those two paths:</p>
<p><img src="/ctf-writeups/tisc24/libnative_filecheck_branch.png" alt=""></p>
<p>The second branch (taken when output is negative, rcx = 1) prints out "I need a very specific file to be available. Or do I?". The first branch, however, prints the string "One wall down!", and it can be reached when the file is opened successfully.</p>
<pre><code class="language-c">void UndefinedFunction_00103316(void)

{
  undefined4 uVar1;
  long unaff_RBP;
  
  *(undefined4 *)(unaff_RBP + -0x4c) = 8;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10));
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10),5);
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  uVar1 = FUN_00103370(*(undefined4 *)(unaff_RBP + -0x10),*(undefined4 *)(unaff_RBP + -0x4c));
  *(undefined4 *)(unaff_RBP + -0x10) = uVar1;
  __android_log_print(4,&amp;DAT_00100a2f,"One wall down!");
                    /* WARNING: Could not recover jumptable at 0x0010336d. Too many branches */
                    /* WARNING: Treating indirect jump as call */
  (**(code **)(*(long *)(unaff_RBP + -0x40) + (long)*(int *)(unaff_RBP + -0x44) * 8))();
  return;
}
</code></pre>
<p>Looking at <code>FUN_00103370</code>, what it's doing is not immediately clear, but it's just doing some operations on some global values.</p>
<pre><code class="language-c">/* WARNING: Globals starting with '_' overlap smaller symbols at the same address */

int FUN_00103370(int param_1,int param_2)

{
  int iVar1;
  int *piVar2;
  int *piVar3;
  int local_38 [4];
  int local_28;
  undefined auStack_18 [4];
  int local_14;
  int local_10;
  int local_c;
  
  piVar3 = (int *)auStack_18;
  local_10 = param_1;
  local_c = param_2;
  if (0x933c5b6d &lt; (((DAT_00105b50 &amp; _DAT_00105b54) / 0xe671c09a ^ 0x509a612a) &amp; 0x2517461d)) {
    piVar3 = local_38;
    local_38[0] = param_2;
    local_28 = param_1 * param_2;
  }
  do {
    iVar1 = local_c;
    piVar2 = piVar3 + -4;
    piVar3 = piVar3 + -8;
    *piVar2 = local_10;
    *piVar3 = iVar1;
    *piVar2 = *piVar3 * *piVar2;
    local_14 = *piVar2;
  } while ((DAT_00105b58 * DAT_00105b5c &amp; 0xdb331b78U) == 0x5971cd31);
  return *piVar2;
}
</code></pre>
<p>I just thought of it as a black box, perhaps some 'hash function', and postulated that these values are used to calculate the key and iv. Notice that the "One wall down!" branch calls this function with different values compared to the branch that prints "I need a very specific file to be available. Or do I?". Hence, I just assumed that as long as we reach the branch that prints the correct string, the correct values will be updated which will hopefully result in the correct key and iv later being printed. I applied the same logic to walls 2 and 3.</p>
<p>I tried creating the file at <code>sys/wall/facer</code> but it didn't work, even though I was root. So I tried replacing the file path with something I could write to by patching the binary:</p>
<pre class="named-fence-block"><code class="language-python">...
newdata = newdata.replace(b'/sys/wall/facer', b'/data/local/ttt')
...
</code><div class="named-fence-filename">patch.py</div></pre>
<p>For some reason, this still didn't work even though the file was clearly present. Eventually I just patched the assembly code itself, replacing</p>
<pre><code class="language-x86asm">mov eax, 0x101
syscall
</code></pre>
<p>with</p>
<pre><code class="language-x86asm">mov eax, 0x1
nop
nop
</code></pre>
<p>So it will be as if the syscall returned a fd of 1.</p>
<p>I updated patch.py:</p>
<pre class="named-fence-block"><code class="language-python">...
# handle file check
j = 0x2277
newdata = newdata[:j] + b'\x01\x00\x00\x00\x90\x90' + newdata[j+6:]
...
</code><div class="named-fence-filename">patch.py</div></pre>
<p>Running the app with the patched libnative.so successfully prints <code>One wall down!</code>. However, there are more errors, more patching to be done. Let's look at the next function:</p>
<h1 id="second-wall" tabindex="-1">Second wall</h1>
<pre><code class="language-c">undefined4 FUN_00101eb0(undefined4 param_1)

{
  undefined4 uVar1;
  uint local_2c;
  undefined8 local_18;
  undefined4 local_10;
  undefined4 local_c;
  
  local_c = param_1;
  local_18 = 0x90ec8148e5894855;
  local_10 = 0x48000000;
  for (local_2c = 0;
      (local_2c &lt; 0xc &amp;&amp;
      (FUN_00103430[(int)local_2c] == *(code *)((long)&amp;local_18 + (long)(int)local_2c)));
      local_2c = local_2c + 1) {
  }
  if (local_2c != 0xc) {
    for (local_2c = 0; local_2c &lt; 0xc; local_2c = local_2c + 1) {
      FUN_00103430[(int)local_2c] = *(code *)((long)&amp;local_18 + (long)(int)local_2c);
    }
  }
  uVar1 = FUN_00103430(0x1,param_1);
  return uVar1;
}
</code></pre>
<p>There is clearly some dynamic updating of executable code going on in the first part. However, upon inspection I realised it wasn't actually changing anything. Let's look at <code>FUN_00103430</code>:</p>
<pre><code class="language-c">void FUN_00103430(int param_1)

{
  switch(param_1 == 0x539) {
  case false:
    __android_log_print(6,&amp;DAT_00100a2f,"HAHAHA are you sure you\'ve got the right input parameter?"
                       );
                    /* WARNING: Could not recover jumptable at 0x001035a2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105ba8)();
    return;
  case true:
    __android_log_print(4,&amp;DAT_00100a2f,"Input verification success!");
                    /* WARNING: Could not recover jumptable at 0x0010357a. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105b98)();
    return;
  }
}
</code></pre>
<p>It's checking that the first parameter is 0x539. However, it is clearly being passed the constant value of 0x1.</p>
<p>There are many ways to patch this, the solution I settled on was replacing 0x539 with 0x1:</p>
<pre class="named-fence-block"><code class="language-python"># handle parameter check
i = 0x2450
newdata = newdata[:i] + b'\x01\x00' + newdata[i+2:]
</code><div class="named-fence-filename">patch.py</div></pre>
<p>Now we get <code>Input verification success!</code>. Let's continue to the third function.</p>
<h1 id="third-wall" tabindex="-1">Third wall</h1>
<p>This function is a bit longer. I retyped the function so that the first parameter is correctly typed as <code>JNIEnv *</code>. Now the code is much more understandable.</p>
<pre><code class="language-c">undefined4 FUN_00101f90(JNIEnv *param_1,uint param_2)

{
  _func_259 *p_Var1;
  JNIEnv *env;
  jclass clazz;
  jsize digestLen;
  uint local_bc;
  undefined8 local_a4;
  undefined4 local_9c;
  int i;
  int local_94;
  jbyte *local_90;
  long local_88;
  jbyte *local_80;
  int local_74;
  jbyteArray digest;
  jobject p2bytes;
  jmethodID String_getBytes;
  jobject msgDigestSHA1;
  jstring s_SHA_1;
  jmethodID MessageDigest_digest;
  jmethodID MessageDigest_update;
  jmethodID MessageDigestClass_getInstance;
  jclass MessageDigestClass;
  jstring p2str;
  char local_1f [11];
  uint local_14;
  JNIEnv *local_10;
  
  local_14 = param_2;
  local_10 = param_1;
  sprintf(local_1f,"%d",(ulong)param_2);
  p2str = (*(*local_10)-&gt;NewStringUTF)(local_10,local_1f);
  MessageDigestClass = (*(*local_10)-&gt;FindClass)(local_10,"java/security/MessageDigest");
  MessageDigestClass_getInstance =
       (*(*local_10)-&gt;GetStaticMethodID)
                 (local_10,MessageDigestClass,"getInstance",
                  "(Ljava/lang/String;)Ljava/security/MessageDigest;");
  MessageDigest_update = (*(*local_10)-&gt;GetMethodID)(local_10,MessageDigestClass,"update","([B)V");
  MessageDigest_digest = (*(*local_10)-&gt;GetMethodID)(local_10,MessageDigestClass,"digest","()[B");
  s_SHA_1 = (*(*local_10)-&gt;NewStringUTF)(local_10,"SHA-1");
  msgDigestSHA1 =
       (*(*local_10)-&gt;CallStaticObjectMethod)
                 (local_10,MessageDigestClass,MessageDigestClass_getInstance,s_SHA_1);
  env = local_10;
  p_Var1 = (*local_10)-&gt;GetMethodID;
  clazz = (*(*local_10)-&gt;GetObjectClass)(local_10,p2str);
  String_getBytes = (*p_Var1)(env,clazz,"getBytes","()[B");
  p2bytes = (*(*local_10)-&gt;CallObjectMethod)(local_10,p2str,String_getBytes);
  (*(*local_10)-&gt;CallVoidMethod)(local_10,msgDigestSHA1,MessageDigest_update,p2bytes);
  digest = (*(*local_10)-&gt;CallObjectMethod)(local_10,msgDigestSHA1,MessageDigest_digest);
  digestLen = (*(*local_10)-&gt;GetArrayLength)(local_10,digest);
  local_74 = (int)digestLen;
  local_80 = (*(*local_10)-&gt;GetByteArrayElements)(local_10,digest,(jboolean *)0x0);
  local_88 = (long)local_74;
  local_90 = local_80;
  local_94 = 0;
  for (i = 0; i &lt; 0x14; i = i + 1) {
    local_94 = (uint)(byte)local_80[i] + local_94;
  }
  local_a4 = 0xb0ec8148e5894855;
  local_9c = 0x48000000;
  for (local_bc = 0;
      (local_bc &lt; 0xc &amp;&amp;
      (FUN_001035b0[(int)local_bc] == *(code *)((long)&amp;local_a4 + (long)(int)local_bc)));
      local_bc = local_bc + 1) {
  }
  if (local_bc != 0xc) {
    for (local_bc = 0; local_bc &lt; 0xc; local_bc = local_bc + 1) {
      FUN_001035b0[(int)local_bc] = *(code *)((long)&amp;local_a4 + (long)(int)local_bc);
    }
  }
  local_14 = FUN_001035b0(local_94,local_14);
  (*(*local_10)-&gt;ReleaseByteArrayElements)(local_10,digest,local_80,0);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,p2str);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,s_SHA_1);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,p2bytes);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,digest);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,msgDigestSHA1);
  (*(*local_10)-&gt;DeleteLocalRef)(local_10,MessageDigestClass);
  return local_14;
}
</code></pre>
<p>Reversing the java part reveals that it does something like this (translated to python): <code>local_94 = sum(hashlib.sha1(str(param_2).encode()).digest())</code>. This value is then passed as the first parameter to <code>FUN_001035b0</code>:</p>
<pre><code class="language-c">void FUN_001035b0(int param_1)

{
  __android_log_print(3,&amp;DAT_00100a2f,"Bet you can\'t fix the correct constant :)");
  switch(param_1 == 0x539) {
  case false:
    __android_log_print(6,&amp;DAT_00100a2f,
                        "I\'m afraid I\'m going to have to stop you from getting the correct key and  IV."
                       );
                    /* WARNING: Could not recover jumptable at 0x00103830. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105bc8)();
    return;
  case true:
                    /* WARNING: Could not recover jumptable at 0x001036e2. Too many branches */
                    /* WARNING: Treating indirect jump as call */
    (*(code *)PTR_LAB_00105bc8)();
    return;
  }
}
</code></pre>
<p>Here's the relevant disassembly:</p>
<pre><code class="language-plaintext">   001035bb 48 8d      LEA     RAX,[switchD_0010366e::switchdataD_00105c30]                         = 0010380a
            05 6e 
            26 00 00
   001035c2 48 89      MOV     qword ptr [RBP + local_10],RAX=&gt;switchD_0010366e::switchdataD_00105  = 0010380a
            45 f8

...

   001035e6 8b 45 f0   MOV     EAX,dword ptr [RBP + local_18] // param_1
   001035e9 8b 0d      MOV     ECX,dword ptr [DAT_00100ba8]                                         = 00000539h
            b9 d5 
            ff ff
   001035ef 29 c8      SUB     EAX,ECX
   001035f1 0f 94 c0   SETZ    AL
   001035f4 0f b6 c0   MOVZX   EAX,AL
   001035f7 89 45 f4   MOV     dword ptr [RBP + local_14],EAX
   001035fa 48 8b      MOV     RAX,qword ptr [RBP + local_10]
            45 f8
   001035fe 48 63      MOVSXD  RCX,dword ptr [RBP + local_14]
            4d f4
   00103602 48 8b      MOV     RAX=&gt;switchD_0010366e::switchdataD_00105c30,qword ptr [RAX + RCX*0x8]= 0010380a
            04 c8

...

                    switchD_0010366e::switchD
   0010366e ff e0      JMP     RAX
</code></pre>
<p>So at the end, it's jumping to the code at <code>switchD_0010366e::switchdataD_00105c30[param_1 - 0x539]</code>. We clearly want to avoid the first branch, so let's look at the what the second branch does:</p>
<pre><code class="language-plaintext">                    switchD_0010366e::caseD_1         XREF[3]: 0010366e(j), 
                                                               00105bb8(*), 
                                                               00105c38(*)  
   001036d6 48 63      MOVSXD  RCX,dword ptr [RBP + local_2c]
            4d dc
   001036da 48 8b      MOV     RAX,qword ptr [RBP + local_28]
            45 e0
   001036de 48 8b      MOV     RAX,qword ptr [RAX + RCX*0x8]=&gt;PTR_LAB_00105bc8                      = 00103779
            04 c8
   001036e2 ff e0      JMP     RAX=&gt;LAB_00103779
</code></pre>
<p>local_2c and local_28 are constants previously set in the parent function:</p>
<pre><code class="language-plaintext">   00103606 48 8d      LEA     RCX,[PTR_LAB_00105b60]                                               = 001032b4
            0d 53 
            25 00 00
   0010360d 48 89      MOV     qword ptr [RBP + local_28],RCX=&gt;PTR_LAB_00105b60                     = 001032b4
            4d e0
   00103611 c7 45      MOV     dword ptr [RBP + local_2c],0xd
            dc 0d 
            00 00 00
</code></pre>
<p>So calculating the expected value, we should end up at jumping to the address at 0x105bc8:</p>
<pre><code class="language-plaintext">                    PTR_LAB_00105bc8                  XREF[2]: check_constant:001036d
                                                               check_constant:0010382
   00105bc8 79 37      addr    LAB_00103779
            10 00 
            00 00 
   00105bd0 70 36      addr    LAB_00103670
            10 00 
            00 00 
   00105bd8 43 37      addr    LAB_00103743
            10 00 
            00 00 
   00105be0 e4 36      addr    LAB_001036e4 // win function
            10 00 
            00 00 
   00105be8 9b 37      addr    LAB_0010379b
            10 00 
            00 00 
   00105bf0 65 37      addr    LAB_00103765
            10 00 
            00 00 
   00105bf8 fe 37      addr    LAB_001037fe
            10 00 
            00 00 
</code></pre>
<p>Looking at the code at <code>LAB_00103779</code> we see it eventually leads to printing "Not like this..." However, we can also see that <code>LAB_001036e4</code> is in the array of pointers, and it prints "I guess it's time to reveal the correct key and IV!". So by setting <code>param_1</code> to 0x53a and replacing 0xd with 0x10 we should reach that branch.</p>
<p>However, there is a simpler solution. Looking back at <code>switchD_0010366e::switchdataD</code> we see the our desired destination is also in this array of pointers:</p>
<pre><code class="language-plaintext">                    switchD_0010366e::switchdataD_00  XREF[3]: check_constant:001035b
                                                               check_constant:001035c
                                                               check_constant:0010360
   00105c30 0a 38      addr    switchD_0010366e::caseD_0
            10 00 
            00 00 
   00105c38 d6 36      addr    switchD_0010366e::caseD_1
            10 00 
            00 00 
                    PTR_LAB_00105c40                  XREF[2]: check_constant:0010362
                                                               check_constant:0010362
   00105c40 43 37      addr    LAB_00103743
            10 00 
            00 00 
   00105c48 70 36      addr    LAB_00103670
            10 00 
            00 00 
                    PTR_LAB_00105c50                  XREF[2]: check_constant:0010363
                                                               check_constant:0010364
   00105c50 9b 37      addr    LAB_0010379b
            10 00 
            00 00 
   00105c58 e4 36      addr    LAB_001036e4 // &lt;-- here!
            10 00 
            00 00 
</code></pre>
<p>So if we set <code>param_1 = 0x539 + 5</code>, we should jump to the correct branch immediately!</p>
<p>For this patch, I replaced the following assembly:</p>
<pre><code class="language-x86asm">sub eax, ecx ; eax = param_1, ecx = 0x539
setz al
movzx eax, al
</code></pre>
<p>with:</p>
<pre><code class="language-x86asm">xor eax, eax
add eax, 0x5
nop
nop
nop
</code></pre>
<p>This was done in the patch.py script (assembly was compiled with pwntools <code>asm</code> function):</p>
<pre class="named-fence-block"><code class="language-python">...
# replace eax with the correct value ...
k = 0x25ef
newdata = newdata[:k] + b'1\xc0\x83\xc0\x05\x90\x90\x90' + newdata[k+8:]
...
</code><div class="named-fence-filename">patch.py</div></pre>
<p>Running the app with the patched libnative.so, there seem to be no errors, and a new key and iv is printed:</p>
<p><img src="/ctf-writeups/tisc24/libnative_logs_success.png" alt=""></p>
<p>Running Decrypt.java with the updated key and iv, the flag is printed!</p>
<p><code>TISC{1_4m_y0ur_w4llbr34k3r_!i#Leb}</code></p>
<p>Here is the final patch.py script:</p>
<pre class="named-fence-block"><code class="language-python">from Crypto.Util.number import long_to_bytes as ltb
import lief

with open('libnative.so', 'rb') as f:
    data = f.read()
newdata = data[:]

# handle file check
j = 0x2277
newdata = newdata[:j] + b'\x01\x00\x00\x00\x90\x90' + newdata[j+6:]

# handle parameter check
i = 0x2450
newdata = newdata[:i] + b'\x01\x00' + newdata[i+2:]

# replace eax with the correct value ...
k = 0x25ef
newdata = newdata[:k] + b'1\xc0\x83\xc0\x05\x90\x90\x90' + newdata[k+8:]

with open('libnative1.so', 'wb') as f:
    f.write(newdata)

lib = lief.parse('libnative1.so')
for x in lib.exported_symbols:
    if x.name == 'Java_DynamicClass_nativeMethod':
        x.name = 'Java_com_a_a_Test_nativeMethod'
lib.write('libnative1.so')
</code><div class="named-fence-filename">patch.py</div></pre>
<h1 id="more-debugging-notes" tabindex="-1">More debugging notes</h1>
<p>While patching libnative.so, there were many times I needed to see what was actually going on in memory. I wasn't able to attach gdb or setup any other debugger, however I found the following approach sufficient:</p>
<p>I would replace a certain instruction with the <code>\xcc</code> opcode, as follows:</p>
<pre class="named-fence-block"><code class="language-python">...
# for debugging
k = 0x2830
newdata = newdata[:k] + b'\xcc' + newdata[k+1:]
...
</code><div class="named-fence-filename">patch.py</div></pre>
<p>When android reaches this instruction, the app would crash a memory dump would be printed to LogCat:</p>
<p><img src="/ctf-writeups/tisc24/libnative_logs_memdump.png" alt=""></p>
<p>Thus, I was able to inspect the values of each register, which for this challenge was sufficient to debug effectively.</p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div><!----></div></div>
    
  

</body></html>